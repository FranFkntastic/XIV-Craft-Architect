@using FFXIVCraftArchitect.Core.Models
@inject IJSRuntime JSRuntime

<!-- Full Viewport Modal -->
<div style="position: fixed; top: 64px; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; align-items: flex-start; justify-content: center; padding: 20px;">
    <div style="background: #1a1a18; border-radius: 8px; border: 2px solid #d4a73a; width: 95%; max-width: 1400px; height: calc(100vh - 104px); display: flex; flex-direction: column; overflow: hidden; margin-top: 20px;">
        
        <!-- Header -->
        <div style="display: flex; align-items: center; padding: 16px 20px; background: #2a2a25; border-bottom: 2px solid #444; flex-shrink: 0;">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                           OnClick="OnClose"
                           Style="color: #d4a73a; margin-right: 16px;"
                           Size="Size.Medium" />
            
            <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <MudText Typo="Typo.h5" Style="color: #fff; font-weight: 600;">
                        @Plan.Name
                    </MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                   OnClick="CopyItemName"
                                   Style="color: #666;"
                                   Size="Size.Small"
                                   Title="Copy item name" />
                </div>
                <MudText Typo="Typo.body2" Style="color: #888;">
                    Quantity: <span style="color: #d4a73a;">×@Plan.QuantityNeeded</span>
                </MudText>
                @if (IsVendorItem)
                {
                    <VendorInfoDisplay Vendors="Plan.Vendors" 
                                       SelectedVendorPrice="(int?)Plan.RecommendedWorld?.AveragePricePerUnit" />
                }
            </div>
            
            <MudIconButton Icon="@Icons.Material.Filled.PushPin"
                           Style="color: #888; margin-right: 8px;"
                           Size="Size.Small" />
            <MudIconButton Icon="@Icons.Material.Filled.Close"
                           OnClick="OnClose"
                           Style="color: #888;"
                           Size="Size.Medium" />
        </div>
        
        <!-- Scrollable Content -->
        <div style="flex-grow: 1; overflow-y: auto; padding: 20px;">
            
            <!-- STOCK WARNING BANNER -->
            @if (!Plan.HasSufficientStock)
            {
                <div style="background: #3a2520; border: 2px solid #ff9800; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Medium" />
                        <div>
                            <MudText Typo="Typo.subtitle1" Style="color: #ff9800; font-weight: 600;">
                                Insufficient Market Stock
                            </MudText>
                            <MudText Typo="Typo.body2" Style="color: #ccc;">
                                Only @Plan.TotalAvailableQuantity.ToString("N0") of @Plan.QuantityNeeded.ToString("N0") available across all worlds.
                                Shortfall: <span style="color: #ff9800; font-weight: 600;">@Plan.StockShortfall.ToString("N0")</span> units.
                            </MudText>
                        </div>
                    </div>
                </div>
            }
            
            <!-- RECOMMENDED PURCHASE SECTION -->
            <div style="margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <MudIcon Icon="@Icons.Material.Filled.Recommend" Style="color: #d4a73a;" Size="Size.Small" />
                    <MudText Typo="Typo.subtitle1" Style="color: #d4a73a; font-weight: 600;">Recommended Purchase</MudText>
                </div>
                
                <div style="background: #252520; border-radius: 8px; border: 2px solid #4a4a40; padding: 20px;">
                    @if (Plan.RequiresSplitPurchase && Plan.RecommendedSplit?.Any() == true)
                    {
                        <!-- Split World Recommendation -->
                        <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 16px;">
                            @foreach (var split in Plan.RecommendedSplit)
                            {
                                var isExpanded = _expandedWorlds.Contains(split.WorldName);
                                var worldData = Plan.WorldOptions?.FirstOrDefault(w => w.WorldName == split.WorldName);
                                
                                <div style="flex: 1; min-width: 200px; max-width: 300px;">
                                    <div @onclick="() => ToggleWorld(split.WorldName)" 
                                         style="cursor: pointer; background: @(isExpanded ? "#1a3a1a" : "#2a2a25"); border-radius: 6px; border: 2px solid @(isExpanded ? "#4caf50" : "#444"); padding: 12px;">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <MudIcon Icon="@(isExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                                         Size="Size.Small" Style="color: #888;" />
                                                <MudText Typo="Typo.subtitle1" Style="color: #90EE90; font-weight: 600;">
                                                    @split.WorldName
                                                </MudText>
                                            </div>
                                        </div>
                                        <div style="margin-top: 8px;">
                                            <MudText Typo="Typo.h6" Style="color: #d4a73a; font-weight: 600;">
                                                ×@split.QuantityToBuy
                                            </MudText>
                                            <MudText Typo="Typo.body2" Style="color: #888;">
                                                @split.TotalCost.ToString("N0")g
                                            </MudText>
                                        </div>
                                    </div>
                                    
                                    @if (isExpanded && worldData?.Listings?.Any() == true)
                                    {
                                        <div style="margin-top: 8px; background: #1e1e1a; border-radius: 4px; padding: 12px; border: 1px solid #333; max-height: 400px; overflow-y: auto;">
                                            @RenderListingsTable(worldData.Listings.Where(l => !l.IsAdditionalOption).OrderBy(l => l.PricePerUnit).ToList())
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        
                        <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 16px; border-top: 1px solid #444;">
                            <MudText Typo="Typo.body2" Style="color: #888;">
                                Multi-world purchase
                            </MudText>
                            <MudText Typo="Typo.h6" Style="color: #d4a73a; font-weight: 700;">
                                Total: @Plan.SplitTotalCost?.ToString("N0")g
                            </MudText>
                        </div>
                    }
                    else if (Plan.RecommendedWorld != null)
                    {
                        <!-- Single World Recommendation -->
                        <div style="display: flex; flex-wrap: wrap; gap: 16px;">
                            <div style="flex: 1; min-width: 200px; max-width: 300px;">
                                <div @onclick="() => ToggleWorld(Plan.RecommendedWorld.WorldName)" 
                                     style="cursor: pointer; background: #1a3a1a; border-radius: 6px; border: 2px solid #4caf50; padding: 12px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <MudIcon Icon="@(_expandedWorlds.Contains(Plan.RecommendedWorld.WorldName) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                                     Size="Size.Small" Style="color: #888;" />
                                            <MudText Typo="Typo.subtitle1" Style="color: #90EE90; font-weight: 600;">
                                                @Plan.RecommendedWorld.WorldName
                                            </MudText>
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Style="color: #4caf50;" />
                                        </div>
                                    </div>
                                    <div style="margin-top: 8px;">
                                        <MudText Typo="Typo.h6" Style="color: #d4a73a; font-weight: 600;">
                                            ×@Plan.QuantityNeeded
                                        </MudText>
                                        <MudText Typo="Typo.body2" Style="color: #888;">
                                            @Plan.RecommendedWorld.TotalCost.ToString("N0")g
                                        </MudText>
                                    </div>
                                </div>
                                
                                @if (_expandedWorlds.Contains(Plan.RecommendedWorld.WorldName) && Plan.RecommendedWorld.Listings?.Any() == true)
                                {
                                    <div style="margin-top: 8px; background: #1e1e1a; border-radius: 4px; padding: 12px; border: 1px solid #333; max-height: 400px; overflow-y: auto;">
                                        @RenderListingsTable(Plan.RecommendedWorld.Listings.Where(l => !l.IsAdditionalOption).OrderBy(l => l.PricePerUnit).ToList())
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
            
            <!-- ALL WORLDS SECTION -->
            <div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; cursor: pointer;" @onclick="() => _showAllWorlds = !_showAllWorlds">
                    <MudIcon Icon="@Icons.Material.Filled.Public" Style="color: #888;" Size="Size.Small" />
                    <MudText Typo="Typo.subtitle1" Style="color: #888; font-weight: 600;">All Worlds</MudText>
                    <MudText Typo="Typo.caption" Style="color: #666; margin-left: 8px;">(sorted by favorability)</MudText>
                    <MudIcon Icon="@(_showAllWorlds ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                             Size="Size.Small" Style="color: #666; margin-left: auto;" />
                </div>
                
                @if (_showAllWorlds && Plan.WorldOptions?.Any() == true)
                {
                    <div style="background: #1e1e1a; border-radius: 8px; border: 1px solid #333; overflow: hidden;">
                        @foreach (var world in GetWorldsByFavorability())
                        {
                            var isExpanded = _expandedAllWorlds.Contains(world.WorldName);
                            <div style="border-bottom: 1px solid #2a2a2a;">
                                <div @onclick="() => ToggleAllWorld(world.WorldName)" 
                                     style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: @(isExpanded ? "#252520" : "transparent");">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <MudIcon Icon="@(isExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                                 Size="Size.Small" Style="color: #666;" />
                                        <MudText Typo="Typo.body1" Style="color: #ccc; font-weight: 500;">
                                            @world.WorldName
                                        </MudText>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 24px;">
                                        <MudText Typo="Typo.body2" Style="color: #888;">
                                            @world.TotalQuantityPurchased × @world.AveragePricePerUnit.ToString("N0")g
                                        </MudText>
                                        <MudText Typo="Typo.subtitle1" Style="color: #d4a73a; font-weight: 600; min-width: 80px; text-align: right;">
                                            @world.TotalCost.ToString("N0")g
                                        </MudText>
                                    </div>
                                </div>
                                
                                @if (isExpanded)
                                {
                                    <div style="padding: 0 16px 16px 48px; background: #1a1a18; max-height: 400px; overflow-y: auto;">
                                        @{
                                            var normalListings = world.Listings?.Where(l => !l.IsAdditionalOption) ?? Enumerable.Empty<ShoppingListingEntry>();
                                            var excludedListings = world.ExcludedListings ?? Enumerable.Empty<ShoppingListingEntry>();
                                            var allListings = normalListings.Concat(excludedListings).OrderBy(l => l.PricePerUnit).ToList();
                                        }
                                        @if (allListings.Any())
                                        {
                                            @RenderListingsTable(allListings, world.ExcludedListings, world.ModePricePerUnit)
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2" Style="color: #666; padding: 12px;">No listings available</MudText>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
            
            <!-- ALTERNATIVE CONFIGURATIONS SECTION -->
            @if (GetAlternativeConfigs().Any())
            {
                <div style="margin-top: 24px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; cursor: pointer;" @onclick="() => _showAlternatives = !_showAlternatives">
                        <MudIcon Icon="@Icons.Material.Filled.AltRoute" Style="color: #666;" Size="Size.Small" />
                        <MudText Typo="Typo.subtitle1" Style="color: #666; font-weight: 600;">Alternative Configurations</MudText>
                        <MudText Typo="Typo.caption" Style="color: #444; margin-left: 8px;">(deprecated)</MudText>
                        <MudIcon Icon="@(_showAlternatives ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                 Size="Size.Small" Style="color: #666; margin-left: auto;" />
                    </div>
                    
                    @if (_showAlternatives)
                    {
                        <div style="background: #1e2530; border-radius: 8px; border: 1px solid #3a4a5a; overflow: hidden; opacity: 0.7;">
                            @foreach (var config in GetAlternativeConfigs())
                            {
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #2a3540;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        @if (config.IsBestSingleWorld)
                                        {
                                            <MudText Typo="Typo.caption" Style="color: #4caf50; background: #1a3a1a; padding: 2px 8px; border-radius: 4px;">BEST</MudText>
                                        }
                                        <MudText Typo="Typo.body1" Style="color: #888;">
                                            @config.Description
                                        </MudText>
                                    </div>
                                    <MudText Typo="Typo.subtitle1" Style="color: #d4a73a; font-weight: 600;">
                                        @config.TotalCost.ToString("N0")g
                                    </MudText>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            
        </div>
    </div>
</div>

@code {
    [Parameter] public DetailedShoppingPlan Plan { get; set; } = null!;
    [Parameter] public EventCallback OnClose { get; set; }
    
    private bool IsVendorItem => Plan.RecommendedWorld?.WorldName == "Vendor";

    private async Task CopyItemName()
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", Plan.Name);
    }

    private HashSet<string> _expandedWorlds = new();
    private HashSet<string> _expandedAllWorlds = new();
    private bool _showAlternatives = false;  // Start collapsed
    private bool _showAllWorlds = false;

    private void ToggleWorld(string worldName)
    {
        if (_expandedWorlds.Contains(worldName))
            _expandedWorlds.Remove(worldName);
        else
            _expandedWorlds.Add(worldName);
    }

    private void ToggleAllWorld(string worldName)
    {
        if (_expandedAllWorlds.Contains(worldName))
            _expandedAllWorlds.Remove(worldName);
        else
            _expandedAllWorlds.Add(worldName);
    }

    private RenderFragment RenderListingsTable(List<ShoppingListingEntry> listings, List<ShoppingListingEntry>? excludedListings = null, long modePrice = 0)
    {
        var excludedSet = excludedListings?.ToHashSet() ?? new HashSet<ShoppingListingEntry>();
        return @<div>
            <div style="display: flex; padding: 6px 8px; border-bottom: 1px solid #333; color: #666; font-size: 11px; font-weight: 600;">
                <span style="width: 50px;">Qty</span>
                <span style="width: 80px;">Price</span>
                <span style="width: 80px; text-align: right;">Total</span>
                <span style="flex: 1; text-align: right;">Retainer</span>
                <span style="width: 100px; text-align: center;"></span>
            </div>
            @foreach (var listing in listings)
            {
                var total = listing.Quantity * listing.PricePerUnit;
                var isExcluded = excludedSet.Contains(listing);
                var priceMultiplier = modePrice > 0 ? (decimal)listing.PricePerUnit / modePrice : 0;
                <div style="display: flex; padding: 6px 8px; color: @(isExcluded ? "#ff6b6b" : "#aaa"); font-size: 12px; border-bottom: 1px solid #2a2a2a; @(isExcluded ? "background: rgba(255, 107, 107, 0.1);" : "")">
                    <span style="width: 50px; color: @(isExcluded ? "#ff6b6b" : "#90EE90");">×@(listing.Quantity)</span>
                    <span style="width: 80px; color: @(isExcluded ? "#ff6b6b" : (listing.IsHq ? "#ffeb3b" : "#ccc")); text-decoration: @(isExcluded ? "line-through" : "none");">
                        @(listing.IsHq ? "★" : "")@listing.PricePerUnit.ToString("N0")g
                    </span>
                    <span style="width: 80px; text-align: right; color: @(isExcluded ? "#ff6b6b" : "#d4a73a"); text-decoration: @(isExcluded ? "line-through" : "none");">
                        @total.ToString("N0")g
                    </span>
                    <span style="flex: 1; text-align: right; color: @(isExcluded ? "#ff6b6b" : "#888"); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-left: 8px;">
                        @listing.RetainerName
                    </span>
                    @if (isExcluded)
                    {
                        <span style="width: 100px; text-align: center;">
                            <MudText Typo="Typo.caption" Style="color: #ff4444; background: rgba(255, 68, 68, 0.2); padding: 2px 8px; border-radius: 4px; font-weight: 600;">
                                too expensive! (@(priceMultiplier.ToString("F1"))×)
                            </MudText>
                        </span>
                    }
                    else
                    {
                        <span style="width: 100px; text-align: center;"></span>
                    }
                </div>
            }
        </div>;
    }

    private List<WorldShoppingSummary> GetWorldsByFavorability()
    {
        if (Plan.WorldOptions == null) return new();
        
        // Sort by total cost as a proxy for favorability
        // (In a real implementation, this would use the actual favorability score)
        return Plan.WorldOptions
            .OrderBy(w => w.TotalCost)
            .ToList();
    }

    private record AlternativeConfig(string Description, decimal TotalCost, bool IsBestSingleWorld = false);

    private List<AlternativeConfig> GetAlternativeConfigs()
    {
        var configs = new List<AlternativeConfig>();
        
        // Add single-world options
        if (Plan.WorldOptions?.Any() == true)
        {
            var sortedWorlds = Plan.WorldOptions.OrderBy(w => w.TotalCost).ToList();
            for (int i = 0; i < sortedWorlds.Count; i++)
            {
                var world = sortedWorlds[i];
                configs.Add(new AlternativeConfig(
                    $"Single World: {world.WorldName}",
                    world.TotalCost,
                    i == 0 // Mark the best one
                ));
            }
        }
        
        return configs;
    }
}
