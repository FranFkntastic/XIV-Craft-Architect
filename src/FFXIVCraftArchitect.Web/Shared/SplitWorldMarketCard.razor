@using FFXIVCraftArchitect.Core.Models
@inject IJSRuntime JSRuntime

@* Full-width card for split-world purchases *@
<div style="background: @(IsSelected ? "#3a3020" : "#2a2515"); border-radius: 4px; border: 2px solid @(IsSelected ? "#ff9800" : "#5a4a3a"); overflow: hidden;">
    
    @* Header with item info *@
    <div style="display: flex; align-items: center; padding: 4px 8px; background: @(IsSelected ? "#4a4a40" : "#363630"); border-bottom: 1px solid #555;">
        <MudIcon Icon="@Icons.Material.Filled.CallSplit" Style="color: #ff9800; margin-right: 6px;" Size="Size.Small" />
        
        <div style="flex: 1; min-width: 0; overflow: hidden; display: flex; align-items: center; gap: 4px;">
            <MudText Typo="Typo.body2" Style="color: #fff; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                @Plan.Name
            </MudText>
            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                           OnClick="CopyItemName"
                           Style="color: #666; padding: 2px;"
                           Size="Size.Small"
                           Title="Copy item name" />
        </div>
        
        <MudText Typo="Typo.caption" Style="color: #d4a73a; margin: 0 8px;">
            ×@(Plan.QuantityNeeded)
        </MudText>
        
        <MudText Typo="Typo.body2" Style="color: #ff9800; font-weight: 700; min-width: 80px; text-align: right;">
            @Plan.SplitTotalCost?.ToString("N0")g
        </MudText>
    </div>
    
    @* Multi-world sections *@
    <div style="display: flex; flex-wrap: wrap;">
        @foreach (var split in Plan.RecommendedSplit!)
        {
            <div style="flex: 1; min-width: 150px; padding: 6px 8px; border-right: 1px solid #444; @(Plan.RecommendedSplit!.IndexOf(split) == Plan.RecommendedSplit.Count - 1 ? "border-right: none;" : "")">
                @* World header *@
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                    <MudText Typo="Typo.caption" Style="color: #90EE90; font-weight: 600;">
                        @split.WorldName
                    </MudText>
                    @if (split.IsPartial)
                    {
                        <MudText Typo="Typo.caption" Style="color: #ff9800; font-size: 10px;">partial</MudText>
                    }
                </div>
                
                @* Purchase details *@
                <div style="display: flex; justify-content: space-between; align-items: baseline;">
                    <MudText Typo="Typo.caption" Style="color: #d4a73a;">
                        @split.QuantityToBuy × @split.PricePerUnit.ToString("N0")g
                    </MudText>
                    <MudText Typo="Typo.body2" Style="color: #4caf50; font-weight: 600;">
                        @split.TotalCost.ToString("N0")g
                    </MudText>
                </div>
                
                @* Excess info *@
                @if (split.ExcessAvailable > 0)
                {
                    <MudText Typo="Typo.caption" Style="color: #666; font-size: 10px;">
                        +@split.ExcessAvailable excess available
                    </MudText>
                }
            </div>
        }
    </div>
    
    @* Savings comparison footer *@
    @if (Plan.RecommendedWorld != null && Plan.SplitTotalCost.HasValue)
    {
        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: #1e1e1e; border-top: 1px solid #444;">
            <MudText Typo="Typo.caption" Style="color: #888;">
                vs @Plan.RecommendedWorld.WorldName: @Plan.RecommendedWorld.TotalCost.ToString("N0")g
            </MudText>
            @if (Plan.SplitSavingsPercent.HasValue && Plan.SplitSavingsPercent.Value > 0)
            {
                <MudText Typo="Typo.caption" Style="color: #4caf50; font-weight: 600;">
                    Save @Plan.SplitSavingsPercent.Value.ToString("F0")%
                </MudText>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public DetailedShoppingPlan Plan { get; set; } = null!;
    
    [Parameter]
    public bool IsSelected { get; set; } = false;
    
    private async Task CopyItemName()
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", Plan.Name);
    }
}
