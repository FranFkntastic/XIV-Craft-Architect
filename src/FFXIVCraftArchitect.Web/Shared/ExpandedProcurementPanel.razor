@using FFXIVCraftArchitect.Core.Models
@using FFXIVCraftArchitect.Core.Services
@using FFXIVCraftArchitect.Web.Services
@inject NavigationManager NavigationManager
@inject AppState AppState

<div style="background: #2a2a25; border-radius: 8px; border: 2px solid #d4a73a; overflow: hidden; margin-bottom: 12px;">
    <!-- Header -->
    <div style="display: flex; align-items: center; padding: 12px 16px; background: #363630; border-bottom: 1px solid #444;">
        <!-- Icon based on recommendation -->
        <div style="margin-right: 12px;">
            @if (Item.IconId > 0)
            {
                <img src="@GetIconUrl(Item.IconId)" style="width: 48px; height: 48px; border-radius: 6px; background: #1a1a1a;" />
            }
            else
            {
                <div style="width: 48px; height: 48px; border-radius: 6px; background: #1a1a1a; display: flex; align-items: center; justify-content: center;">
                    <MudIcon Icon="@GetActionIcon()" Size="Size.Large" Style="@GetActionStyle()" />
                </div>
            }
        </div>
        
        <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                <MudText Typo="Typo.h6" Style="color: #fff; font-weight: 600;">
                    @Item.Name
                </MudText>
                <MudText Typo="Typo.body1" Style="color: #d4a73a;">
                    ×@Item.QuantityNeeded
                </MudText>
                <div style="@GetActionBackgroundStyle()">
                    <MudText Typo="Typo.caption" Style="@GetActionTextStyle()">
                        @GetActionText()
                    </MudText>
                </div>
            </div>
            
            @if (Item.Recommendation == ProcurementRecommendation.Craft)
            {
                <MudText Typo="Typo.body2" Style="color: #2196f3;">
                    Craft Cost: <span style="font-weight: 600;">@Item.CraftCost.ToString("N0")g</span>
                </MudText>
            }
            else if (Item.Recommendation == ProcurementRecommendation.BuyFromMarket && Item.BestWorldPurchase != null)
            {
                <div style="display: flex; gap: 16px;">
                    <MudText Typo="Typo.body2" Style="color: #4caf50;">
                        Buy Cost: <span style="font-weight: 600;">@Item.BestWorldPurchase.TotalCost.ToString("N0")g</span>
                    </MudText>
                    <MudText Typo="Typo.body2" Style="color: #90EE90;">
                        Best World: <span style="font-weight: 600;">@Item.BestWorldPurchase.WorldName</span>
                    </MudText>
                    <MudText Typo="Typo.body2" Style="color: #aaa;">
                        (@Item.BestWorldPurchase.UnitPrice.ToString("N0")g/ea)
                    </MudText>
                </div>
            }
        </div>
        
        <!-- View in Market Analysis Button -->
        @if (Item.Recommendation == ProcurementRecommendation.BuyFromMarket)
        {
            <MudButton OnClick="GoToMarketAnalysis"
                       Color="Color.Warning"
                       Variant="Variant.Outlined"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.OpenInNew"
                       Style="margin-right: 12px;">
                Market Analysis
            </MudButton>
        }
        
        <MudIconButton Icon="@Icons.Material.Filled.Close"
                       OnClick="OnClose"
                       Style="color: #888;"
                       Size="Size.Small" />
    </div>
    
    <!-- Details Content -->
    <div style="padding: 16px; background: #1e1e1a;">
        
        <!-- Market Listings Section (for Buy items) -->
        @if (Item.Recommendation == ProcurementRecommendation.BuyFromMarket && Item.BestWorldPurchase != null)
        {
            var shoppingPlan = GetShoppingPlan();
            var worldOption = GetWorldOption(shoppingPlan);
            
            @if (worldOption?.Listings?.Any() == true)
            {
                var relevantListings = worldOption.Listings.Where(l => !l.IsAdditionalOption).ToList();
                var totalListingCost = relevantListings.Sum(l => l.Quantity * l.PricePerUnit);
                var totalQuantityBought = relevantListings.Sum(l => l.Quantity);
                
                <div style="margin-bottom: 16px; background: #1a3a2a; border-radius: 6px; padding: 12px; border: 1px solid #4caf50;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <MudText Typo="Typo.subtitle1" Style="color: #90EE90; font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Small" Style="margin-right: 8px;" />
                            @Item.BestWorldPurchase.WorldName Listings
                        </MudText>
                        <div style="text-align: right;">
                            <MudText Typo="Typo.caption" Style="color: #888;">
                                @relevantListings.Count listing(s) · @totalQuantityBought items total
                            </MudText>
                        </div>
                    </div>
                    
                    <!-- Listings Table -->
                    <div style="background: rgba(0,0,0,0.3); border-radius: 4px; padding: 8px;">
                        <!-- Header Row -->
                        <div style="display: flex; padding: 4px 8px; border-bottom: 1px solid #333; color: #666; font-size: 12px; font-weight: 600;">
                            <span style="width: 60px;">Qty</span>
                            <span style="width: 80px;">Price</span>
                            <span style="width: 90px; text-align: right;">Full Cost</span>
                            <span style="flex: 1; text-align: right;">Retainer</span>
                        </div>
                        
                        <!-- Listing Rows -->
                        @foreach (var listing in relevantListings.OrderBy(l => l.PricePerUnit))
                        {
                            var fullListingCost = listing.Quantity * listing.PricePerUnit;
                            <div style="display: flex; padding: 6px 8px; color: #aaa; font-size: 13px; border-bottom: 1px solid #2a2a2a;">
                                <span style="width: 60px; color: #90EE90;">×@(listing.Quantity)</span>
                                <span style="width: 80px; color: @(listing.IsHq ? "#ffeb3b" : "#ccc");">
                                    @if (listing.IsHq)
                                    {
                                        <span style="margin-right: 2px;">★</span>
                                    }
                                    @listing.PricePerUnit.ToString("N0")g
                                </span>
                                <span style="width: 90px; text-align: right; color: #d4a73a; font-weight: 600;">
                                    @fullListingCost.ToString("N0")g
                                </span>
                                <span style="flex: 1; text-align: right; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-left: 8px;">
                                    @listing.RetainerName
                                </span>
                            </div>
                        }
                        
                        <!-- Total Row -->
                        <div style="display: flex; padding: 8px; border-top: 2px solid #444; margin-top: 4px; background: rgba(76, 175, 80, 0.1);">
                            <span style="width: 60px; color: #90EE90; font-weight: 600;">@totalQuantityBought</span>
                            <span style="width: 80px;"></span>
                            <span style="width: 90px; text-align: right; color: #4caf50; font-weight: 700;">
                                @totalListingCost.ToString("N0")g
                            </span>
                            <span style="flex: 1; text-align: right; color: #888; font-size: 12px;">
                                Total (full listings)
                            </span>
                        </div>
                    </div>
                    
                    @if (worldOption.ExcessQuantity > 0)
                    {
                        <div style="margin-top: 8px; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; border-left: 3px solid #ff9800;">
                            <MudText Typo="Typo.caption" Style="color: #ff9800;">
                                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Style="margin-right: 4px;" />
                                You're buying <strong>@totalQuantityBought</strong> items to get the <strong>@Item.QuantityNeeded</strong> needed. 
                                You'll have <strong>@worldOption.ExcessQuantity</strong> extra.
                            </MudText>
                        </div>
                    }
                </div>
            }
        }
        
        <!-- Craft Components Section -->
        @if (Item.Recommendation == ProcurementRecommendation.Craft && Item.CraftComponents?.Any() == true)
        {
            <div style="margin-bottom: 16px;">
                <MudText Typo="Typo.subtitle1" Style="color: #2196f3; font-weight: 600; margin-bottom: 12px;">
                    <MudIcon Icon="@Icons.Material.Filled.List" Size="Size.Small" Style="margin-right: 8px;" />
                    Required Components
                </MudText>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
                    @foreach (var component in Item.CraftComponents)
                    {
                        <div style="display: flex; align-items: center; gap: 8px; background: #252520; padding: 8px 12px; border-radius: 6px; border: 1px solid #333;">
                            @if (component.IconId > 0)
                            {
                                <img src="@GetIconUrl(component.IconId)" style="width: 32px; height: 32px; border-radius: 4px;" />
                            }
                            else
                            {
                                <div style="width: 32px; height: 32px; border-radius: 4px; background: #1a1a1a; display: flex; align-items: center; justify-content: center;">
                                    <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Small" Style="color: #666;" />
                                </div>
                            }
                            <div>
                                <MudText Typo="Typo.body2" Style="color: #ccc; font-weight: 500;">@component.Name</MudText>
                                <MudText Typo="Typo.caption" Style="color: #d4a73a;">×@component.Quantity</MudText>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        
        <!-- Market Comparison Section (for craft items) -->
        @if (Item.Recommendation == ProcurementRecommendation.Craft && Item.HasMarketData)
        {
            <div style="background: #1a3a2a; border-radius: 6px; padding: 12px; border: 1px solid #4caf50;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <MudText Typo="Typo.subtitle2" Style="color: #90EE90;">
                        <MudIcon Icon="@Icons.Material.Filled.CompareArrows" Size="Size.Small" Style="margin-right: 8px;" />
                        Market Alternative
                    </MudText>
                    <MudButton OnClick="GoToMarketAnalysis"
                               Color="Color.Warning"
                               Variant="Variant.Text"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.OpenInNew">
                        View in Market Analysis
                    </MudButton>
                </div>
                <div style="display: flex; gap: 24px;">
                    <div>
                        <MudText Typo="Typo.caption" Style="color: #888;">Craft Cost</MudText>
                        <MudText Typo="Typo.body1" Style="color: #2196f3; font-weight: 600;">@Item.CraftCost.ToString("N0")g</MudText>
                    </div>
                    <div>
                        <MudText Typo="Typo.caption" Style="color: #888;">Market Price (NQ)</MudText>
                        <MudText Typo="Typo.body1" Style="color: #aaa;">@Item.MarketPriceNq.ToString("N0")g</MudText>
                    </div>
                    @if (Item.MarketPriceHq > 0)
                    {
                        <div>
                            <MudText Typo="Typo.caption" Style="color: #888;">Market Price (HQ)</MudText>
                            <MudText Typo="Typo.body1" Style="color: #ffeb3b;">@Item.MarketPriceHq.ToString("N0")g</MudText>
                        </div>
                    }
                    @if (Item.CraftCost < Item.TotalMarketCost)
                    {
                        <div style="margin-left: auto;">
                            <MudText Typo="Typo.caption" Style="color: #888;">Savings</MudText>
                            <MudText Typo="Typo.body1" Style="color: #4caf50; font-weight: 600;">@((Item.TotalMarketCost - Item.CraftCost).ToString("N0"))g</MudText>
                        </div>
                    }
                </div>
            </div>
        }
        
        <!-- No Data Warning -->
        @if (Item.Recommendation == ProcurementRecommendation.NoDataAvailable)
        {
            <div style="background: #3d2d2d; border-radius: 6px; padding: 12px; border: 1px solid #f44336;">
                <MudText Typo="Typo.body2" Style="color: #ff9800;">
                    <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Style="margin-right: 8px;" />
                    No market data available for this item. Please check prices manually or run Market Analysis first.
                </MudText>
                <MudButton OnClick="GoToMarketAnalysis"
                           Color="Color.Warning"
                           Variant="Variant.Outlined"
                           Size="Size.Small"
                           Class="mt-2"
                           StartIcon="@Icons.Material.Filled.Analytics">
                    Go to Market Analysis
                </MudButton>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public ItemProcurementAnalysis Item { get; set; } = null!;
    [Parameter] public List<DetailedShoppingPlan> ShoppingPlans { get; set; } = new();
    [Parameter] public EventCallback OnClose { get; set; }

    private string GetIconUrl(int iconId) => $"https://www.garlandtools.org/files/icons/item/{iconId}.png";

    private DetailedShoppingPlan? GetShoppingPlan()
    {
        return ShoppingPlans.FirstOrDefault(sp => sp.ItemId == Item.ItemId);
    }

    private WorldShoppingSummary? GetWorldOption(DetailedShoppingPlan? plan)
    {
        if (plan?.WorldOptions == null || Item.BestWorldPurchase == null)
            return null;
        
        return plan.WorldOptions.FirstOrDefault(wo => wo.WorldName == Item.BestWorldPurchase.WorldName);
    }

    private void GoToMarketAnalysis()
    {
        // Set the auto-expand item ID so the market analysis page knows which card to expand
        AppState.AutoExpandItemId = Item.ItemId;
        // Use relative path (no leading slash) so it resolves against base href correctly
        NavigationManager.NavigateTo("market");
    }

    private string GetActionIcon() => Item.Recommendation switch
    {
        ProcurementRecommendation.Craft => Icons.Material.Filled.Build,
        ProcurementRecommendation.BuyFromMarket => Icons.Material.Filled.ShoppingCart,
        _ => Icons.Material.Filled.Help
    };

    private string GetActionColor() => Item.Recommendation switch
    {
        ProcurementRecommendation.Craft => "#2196f3",
        ProcurementRecommendation.BuyFromMarket => "#4caf50",
        _ => "#888"
    };

    private string GetActionStyle() => Item.Recommendation switch
    {
        ProcurementRecommendation.Craft => "color: #2196f3;",
        ProcurementRecommendation.BuyFromMarket => "color: #4caf50;",
        _ => "color: #888;"
    };

    private string GetActionTextStyle() => Item.Recommendation switch
    {
        ProcurementRecommendation.Craft => "color: #2196f3; font-weight: 600;",
        ProcurementRecommendation.BuyFromMarket => "color: #4caf50; font-weight: 600;",
        _ => "color: #888; font-weight: 600;"
    };

    private string GetActionBackground() => Item.Recommendation switch
    {
        ProcurementRecommendation.Craft => "rgba(33, 150, 243, 0.2)",
        ProcurementRecommendation.BuyFromMarket => "rgba(76, 175, 80, 0.2)",
        _ => "rgba(128, 128, 128, 0.2)"
    };

    private string GetActionBackgroundStyle() => Item.Recommendation switch
    {
        ProcurementRecommendation.Craft => "background: rgba(33, 150, 243, 0.2); padding: 4px 12px; border-radius: 4px;",
        ProcurementRecommendation.BuyFromMarket => "background: rgba(76, 175, 80, 0.2); padding: 4px 12px; border-radius: 4px;",
        _ => "background: rgba(128, 128, 128, 0.2); padding: 4px 12px; border-radius: 4px;"
    };

    private string GetActionText() => Item.Recommendation switch
    {
        ProcurementRecommendation.Craft => "CRAFT",
        ProcurementRecommendation.BuyFromMarket => "BUY FROM MARKET",
        _ => "NO DATA"
    };
}
