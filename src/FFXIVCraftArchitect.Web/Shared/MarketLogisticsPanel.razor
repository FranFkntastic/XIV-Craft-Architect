@using FFXIVCraftArchitect.Core.Models

<div style="display: flex; flex-direction: column; height: 100%; gap: 6px;">
    
    <!-- Compressed Purchase Summary -->
    @if (ShowAnalysisSections && ShoppingPlans?.Any() == true)
    {
        <div style="flex-shrink: 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #2a3a2a; border-radius: 4px; border: 1px solid #3a5a3a;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <MudIcon Icon="@Icons.Material.Filled.Savings" Color="Color.Success" Size="Size.Small" />
                    <span style="color: #90EE90; font-weight: 600; font-size: 14px;">
                        @TotalBestValue.ToString("N0")g
                    </span>
                    <span style="color: #888; font-size: 12px;">best value</span>
                </div>
                <div style="display: flex; gap: 16px;">
                    <span style="color: #aaa; font-size: 12px;">
                        <span style="color: #666;">DC Avg:</span> @TotalDCAverage.ToString("N0")g
                    </span>
                    @if (TotalSavings > 0)
                    {
                        <span style="color: #4caf50; font-size: 12px;">
                            Save @TotalSavings.ToString("N0")g
                        </span>
                    }
                </div>
            </div>
        </div>
    }
    
    <!-- Expanded Item Panel (Top) -->
    @if (_expandedPlan != null)
    {
        <div style="flex-shrink: 0; max-height: 50%; overflow-y: auto;">
            <ExpandedItemPanel Plan="_expandedPlan" OnClose="CloseExpanded" />
        </div>
    }
    
    <!-- Collapsed Cards Grid (Bottom) -->
    <div style="flex-grow: 1; overflow-y: auto; min-height: 0;">
        @if (ShoppingPlans?.Any() == true)
        {
            <!-- Craft vs Buy Analysis (collapsible, full width) -->
            @if (ShowAnalysisSections && CraftAnalyses?.Any() == true)
            {
                <div style="margin-bottom: 8px; background: #2a2a25; border-radius: 4px; border: 1px solid #444; overflow: hidden;">
                    <div @onclick="ToggleCraftAnalysis"
                         style="background: #363630; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <MudIcon Icon="@Icons.Material.Filled.Assessment" Color="Color.Success" Size="Size.Small" />
                            <span style="color: #90EE90; font-weight: 600; font-size: 13px;">Craft vs Buy Analysis</span>
                            @if (!string.IsNullOrEmpty(CraftAnalysisSummary))
                            {
                                <span style="color: #aaa; background: #1e1e1e; padding: 2px 8px; border-radius: 10px; font-size: 11px;">@CraftAnalysisSummary</span>
                            }
                        </div>
                        <MudIcon Icon="@(_craftAnalysisExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                 Color="Color.Secondary" Size="Size.Small" />
                    </div>
                    @if (_craftAnalysisExpanded)
                    {
                        <div style="background: #1e1e1a; padding: 8px;">
                            <CraftAnalysisPanel Analyses="CraftAnalyses" />
                        </div>
                    }
                </div>
            }
            
            <!-- Collapsed Cards Grid -->
            <div style="display: flex; flex-direction: column; gap: 4px;">
                @{ 
                    var vendorPlans = GetVendorPlans().ToList();
                    var singleWorldPlans = GetSingleWorldPlans().ToList();
                    var splitWorldPlans = GetSplitWorldPlans().ToList();
                }
                
                <!-- Vendor Items Section -->
                @if (vendorPlans.Any())
                {
                    <div style="display: flex; align-items: center; gap: 6px; padding: 3px 8px; background: #2a2520; border-radius: 3px; border: 1px solid #5a4a3a;">
                        <MudIcon Icon="@Icons.Material.Filled.Store" Color="Color.Warning" Size="Size.Small" />
                        <span style="color: #d4a73a; font-weight: 600; font-size: 11px;">VENDOR (@vendorPlans.Count)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 4px; align-items: start;">
                        @foreach (var plan in vendorPlans)
                        {
                            var isSelected = _expandedPlan?.ItemId == plan.ItemId;
                            <div @onclick="() => SelectPlan(plan)" style="cursor: pointer;">
                                <MarketAnalysisCard @key="plan.ItemId" 
                                                   Plan="plan" 
                                                   IsCollapsed="true"
                                                   IsSelected="isSelected" />
                            </div>
                        }
                    </div>
                }
                
                <!-- Market Items (single-world and split-world combined) -->
                @{ 
                    var allMarketPlans = GetMarketPlans().ToList();
                }
                @if (allMarketPlans.Any())
                {
                    <div style="display: flex; align-items: center; gap: 6px; padding: 3px 8px; background: #20252a; border-radius: 3px; border: 1px solid #3a4a5a; margin-top: 4px;">
                        <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Info" Size="Size.Small" />
                        <span style="color: #87ceeb; font-weight: 600; font-size: 11px;">MARKET (@allMarketPlans.Count)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 4px; align-items: start;">
                        @foreach (var plan in allMarketPlans)
                        {
                            var isSelected = _expandedPlan?.ItemId == plan.ItemId;
                            <div @onclick="() => SelectPlan(plan)" style="cursor: pointer;">
                                <MarketAnalysisCard @key="plan.ItemId" 
                                                   Plan="plan" 
                                                   IsCollapsed="true"
                                                   IsSelected="isSelected" />
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; min-height: 200px; background: #252525; border-radius: 8px;">
                <MudText Typo="Typo.body1" Style="color: #888; text-align: center;">
                    No market data to display
                </MudText>
                <MudText Typo="Typo.body2" Style="color: #666; text-align: center; margin-top: 8px;">
                    Add items to your shopping list and click "Analyze Market" to see world recommendations.
                </MudText>
            </div>
        }
    </div>
    
</div>

@code {
    [Parameter] public List<DetailedShoppingPlan> ShoppingPlans { get; set; } = new();
    [Parameter] public List<CraftVsBuyAnalysis> CraftAnalyses { get; set; } = new();
    [Parameter] public string? CraftAnalysisSummary { get; set; }
    [Parameter] public string? PurchaseSummaryText { get; set; }
    [Parameter] public RecommendationMode InitialMode { get; set; } = RecommendationMode.MinimizeTotalCost;
    [Parameter] public EventCallback OnRefreshMarketData { get; set; }
    [Parameter] public EventCallback OnViewStatus { get; set; }
    [Parameter] public EventCallback<MarketSortOption> OnSortChanged { get; set; }
    [Parameter] public EventCallback<RecommendationMode> OnModeChanged { get; set; }
    [Parameter] public EventCallback<bool> OnSearchAllNAChanged { get; set; }
    [Parameter] public bool ShowAnalysisSections { get; set; } = true;
    [Parameter] public MarketSortOption CurrentSort { get; set; } = MarketSortOption.ByRecommended;
    [Parameter] public int? AutoExpandItemId { get; set; }

    private bool _craftAnalysisExpanded = false;
    private DetailedShoppingPlan? _expandedPlan;
    private bool _autoExpandProcessed = false;

    protected override void OnParametersSet()
    {
        ShoppingPlans ??= new List<DetailedShoppingPlan>();
        CraftAnalyses ??= new List<CraftVsBuyAnalysis>();
        
        // Handle auto-expand once when the parameter is set
        if (!_autoExpandProcessed && AutoExpandItemId.HasValue && ShoppingPlans.Any())
        {
            var planToExpand = ShoppingPlans.FirstOrDefault(p => p.ItemId == AutoExpandItemId.Value);
            if (planToExpand != null)
            {
                _expandedPlan = planToExpand;
            }
            _autoExpandProcessed = true;
        }
        else if (!AutoExpandItemId.HasValue)
        {
            // Reset when no auto-expand is requested
            _autoExpandProcessed = false;
        }
    }

    private void ToggleCraftAnalysis()
    {
        _craftAnalysisExpanded = !_craftAnalysisExpanded;
    }

    private void SelectPlan(DetailedShoppingPlan plan)
    {
        if (_expandedPlan?.ItemId == plan.ItemId)
        {
            // Clicking the already expanded plan closes it
            _expandedPlan = null;
        }
        else
        {
            _expandedPlan = plan;
        }
    }

    private void CloseExpanded()
    {
        _expandedPlan = null;
    }

    private IEnumerable<DetailedShoppingPlan> GetSortedPlans()
    {
        var plans = ShoppingPlans ?? new List<DetailedShoppingPlan>();
        
        return CurrentSort switch
        {
            MarketSortOption.Alphabetical => plans.OrderBy(p => p.Name),
            MarketSortOption.ByRecommended => plans.OrderBy(p => p.RecommendedWorld?.WorldName ?? string.Empty)
                                                    .ThenBy(p => p.Name),
            _ => plans
        };
    }
    
    /// <summary>
    /// Get plans where vendor is the recommended source.
    /// </summary>
    private IEnumerable<DetailedShoppingPlan> GetVendorPlans()
    {
        return GetSortedPlans().Where(p => p.RecommendedWorld?.WorldName == "Vendor");
    }
    
    /// <summary>
    /// Get plans where market board is the recommended source.
    /// </summary>
    private IEnumerable<DetailedShoppingPlan> GetMarketPlans()
    {
        return GetSortedPlans().Where(p => p.RecommendedWorld?.WorldName != "Vendor");
    }
    
    /// <summary>
    /// Get single-world market purchase plans (non-split).
    /// </summary>
    private IEnumerable<DetailedShoppingPlan> GetSingleWorldPlans()
    {
        return GetSortedPlans().Where(p => 
            p.RecommendedWorld?.WorldName != "Vendor" && 
            (!p.RequiresSplitPurchase || p.RecommendedSplit?.Any() != true));
    }
    
    /// <summary>
    /// Get split-world market purchase plans.
    /// </summary>
    private IEnumerable<DetailedShoppingPlan> GetSplitWorldPlans()
    {
        return GetSortedPlans().Where(p => 
            p.RecommendedWorld?.WorldName != "Vendor" && 
            p.RequiresSplitPurchase && 
            p.RecommendedSplit?.Any() == true);
    }

    private decimal TotalDCAverage => ShoppingPlans?.Sum(p => p.DCAveragePrice * p.QuantityNeeded) ?? 0;
    
    private decimal TotalBestValue => ShoppingPlans?.Sum(p => 
    {
        if (p.RecommendedWorld != null)
            return p.RecommendedWorld.TotalCost;
        if (p.WorldOptions.Any())
            return p.WorldOptions.OrderBy(w => w.TotalCost).First().TotalCost;
        return p.DCAveragePrice * p.QuantityNeeded;
    }) ?? 0;

    private decimal TotalSavings => Math.Max(0, TotalDCAverage - TotalBestValue);
}
