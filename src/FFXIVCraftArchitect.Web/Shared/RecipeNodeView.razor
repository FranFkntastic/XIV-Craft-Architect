@using FFXIVCraftArchitect.Core.Helpers
@using FFXIVCraftArchitect.Core.Models
@using FFXIVCraftArchitect.Web.Services
@inject AppState AppState
@implements IDisposable

@if (Node != null)
{
    <div style="margin-left: @(Depth * 20)px;">
        @if (HasChildren)
        {
            <!-- Parent Node: Expander -->
            <div style="border: 1px solid #444; border-radius: 4px; margin-bottom: 4px; overflow: hidden;">
                <div style="background: #363636; padding: 8px 12px; display: flex; align-items: center; gap: 8px;">
                    <!-- Toggle button - only this should expand/collapse -->
                    <div @onclick="ToggleExpanded"
                         @onclick:stopPropagation
                         style="cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1;">
                        <span style="color: #888; font-size: 12px;">@(_isExpanded ? "▼" : "▶")</span>
                        @RenderNodeContentCore()
                    </div>
                </div>
                @if (_isExpanded)
                {
                    <div style="padding: 8px; background: #2d2d2d;">
                        @foreach (var child in Node.Children)
                        {
                            <RecipeNodeView Node="child" 
                                            Depth="Depth + 1"
                                            OnSourceChanged="OnSourceChanged"
                                            OnHqChanged="OnHqChanged" />
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <!-- Leaf Node: Simple row with acquisition dropdown -->
            <div style="display: flex; align-items: center; gap: 8px; padding: 6px 0;">
                @RenderNodeContentCore()
            </div>
        }
    </div>
}

@code {
    [Parameter] public PlanNode? Node { get; set; }
    [Parameter] public int Depth { get; set; }
    [Parameter] public EventCallback<PlanNode> OnSourceChanged { get; set; }
    [Parameter] public EventCallback<PlanNode> OnHqChanged { get; set; }

    private bool _isExpanded = true;
    private int _lastExpandVersion = -1;
    private bool _isDisposed;

    private bool HasChildren => Node?.Children.Any() == true;

    protected override void OnInitialized()
    {
        AppState.OnRecipeTreeExpandChanged += OnRecipeTreeExpandChanged;
    }

    public void Dispose()
    {
        _isDisposed = true;
        AppState.OnRecipeTreeExpandChanged -= OnRecipeTreeExpandChanged;
    }

    private void OnRecipeTreeExpandChanged()
    {
        if (_isDisposed)
        {
            return;
        }

        if (_lastExpandVersion != AppState.RecipeTreeExpandVersion)
        {
            _isExpanded = AppState.RecipeTreeAllExpanded;
            _lastExpandVersion = AppState.RecipeTreeExpandVersion;
            InvokeAsync(StateHasChanged);
        }
    }

    protected override void OnParametersSet()
    {
        // Sync with global expand state on initial render or when version changes
        if (_lastExpandVersion != AppState.RecipeTreeExpandVersion)
        {
            _isExpanded = AppState.RecipeTreeAllExpanded;
            _lastExpandVersion = AppState.RecipeTreeExpandVersion;
        }
    }

    private void ToggleExpanded()
    {
        _isExpanded = !_isExpanded;
    }

    private async Task OnHqToggle()
    {
        if (Node != null && Node.CanBeHq)
        {
            Node.MustBeHq = !Node.MustBeHq;
            // If switching to HQ and currently buying NQ, switch to HQ buy
            if (Node.MustBeHq && Node.Source == AcquisitionSource.MarketBuyNq)
            {
                Node.Source = AcquisitionSource.MarketBuyHq;
            }
            // If switching to NQ and currently buying HQ, switch to NQ buy
            else if (!Node.MustBeHq && Node.Source == AcquisitionSource.MarketBuyHq)
            {
                Node.Source = AcquisitionSource.MarketBuyNq;
            }
            await OnHqChanged.InvokeAsync(Node);
        }
    }

    private List<DropdownOption> GetDropdownOptions()
    {
        var options = new List<DropdownOption>();
        
        if (Node == null) return options;
        
        // Always add market buy options
        options.Add(new DropdownOption($"market_nq_{Node.NodeId}", "Buy NQ", AcquisitionSource.MarketBuyNq, -1));
        
        if (Node.CanBeHq)
        {
            options.Add(new DropdownOption($"market_hq_{Node.NodeId}", "Buy HQ", AcquisitionSource.MarketBuyHq, -1));
        }
        
        // Add vendor options - create entry for each location (including alternate instances)
        if (Node.CanBuyFromVendor && Node.VendorOptions?.Any() == true)
        {
            var gilVendors = Node.VendorOptions.Where(v => v.IsGilVendor).ToList();
            if (gilVendors.Any())
            {
                var minPrice = gilVendors.Min(v => v.Price);
                var cheapestVendors = gilVendors.Where(v => v.Price == minPrice).ToList();

                // Create dropdown entries for each vendor location
                foreach (var vendor in cheapestVendors)
                {
                    var vendorIndex = Node.VendorOptions.IndexOf(vendor);
                    
                    // Primary location
                    options.Add(new DropdownOption(
                        $"vendor_{vendorIndex}_primary_{Node.NodeId}",
                        $"Vendor: {vendor.Name} - {vendor.Location} [{vendor.Price:N0}g]",
                        AcquisitionSource.VendorBuy,
                        vendorIndex));
                    
                    // Alternate locations (if any)
                    if (vendor.HasMultipleLocations)
                    {
                        for (int altIndex = 0; altIndex < vendor.AlternateLocations.Count; altIndex++)
                        {
                            var location = vendor.AlternateLocations[altIndex];
                            options.Add(new DropdownOption(
                                $"vendor_{vendorIndex}_alt_{altIndex}_{Node.NodeId}",
                                $"Vendor: {vendor.Name} - {location} [{vendor.Price:N0}g]",
                                AcquisitionSource.VendorBuy,
                                vendorIndex));
                        }
                    }
                }
            }

            // Add special currency vendors (crossed out / not supported)
            var specialCurrencyVendors = Node.VendorOptions.Where(v => !v.IsGilVendor).ToList();
            foreach (var vendor in specialCurrencyVendors)
            {
                var vendorIndex = Node.VendorOptions.IndexOf(vendor);
                options.Add(new DropdownOption(
                    $"vendor_special_{vendorIndex}_{Node.NodeId}",
                    $"~~{vendor.Name} - {vendor.Location} [{vendor.Price:N0} {vendor.Currency}] (not supported)~~",
                    AcquisitionSource.VendorSpecialCurrency,
                    vendorIndex));
            }
        }
        
        // Add craft option if craftable
        if (Node.Children?.Any() == true)
        {
            options.Add(new DropdownOption($"craft_{Node.NodeId}", "Craft", AcquisitionSource.Craft, -1));
        }
        
        return options;
    }
    
    private string GetCurrentDropdownValue()
    {
        if (Node == null) return "";
        
        return Node.Source switch
        {
            AcquisitionSource.MarketBuyNq => $"market_nq_{Node.NodeId}",
            AcquisitionSource.MarketBuyHq => $"market_hq_{Node.NodeId}",
            AcquisitionSource.VendorBuy => GetVendorDropdownValue(),
            AcquisitionSource.Craft => $"craft_{Node.NodeId}",
            _ => $"market_nq_{Node.NodeId}"
        };
    }
    
    private string GetVendorDropdownValue()
    {
        if (Node?.VendorOptions == null || !Node.VendorOptions.Any()) return "";
        
        var gilVendors = Node.VendorOptions.Where(v => v.IsGilVendor).ToList();
        if (!gilVendors.Any()) return "";
        
        var minPrice = gilVendors.Min(v => v.Price);
        var cheapestVendors = gilVendors.Where(v => v.Price == minPrice).ToList();
        
        // Use selected vendor index if valid - defaults to primary location
        if (Node.SelectedVendorIndex >= 0 && Node.SelectedVendorIndex < cheapestVendors.Count)
        {
            var vendor = cheapestVendors[Node.SelectedVendorIndex];
            var vendorIndex = Node.VendorOptions.IndexOf(vendor);
            return $"vendor_{vendorIndex}_primary_{Node.NodeId}";
        }
        
        // Default to first vendor's primary location
        var firstVendor = cheapestVendors.First();
        var firstIndex = Node.VendorOptions.IndexOf(firstVendor);
        return $"vendor_{firstIndex}_primary_{Node.NodeId}";
    }
    
    private async Task OnDropdownChange(ChangeEventArgs e)
    {
        if (Node == null) return;
        
        var value = e.Value?.ToString() ?? "";
        var options = GetDropdownOptions();
        var selectedOption = options.FirstOrDefault(o => o.Value == value);
        
        if (selectedOption != null)
        {
            Node.Source = selectedOption.Source;
            if (selectedOption.Source == AcquisitionSource.VendorBuy)
            {
                Node.SelectedVendorIndex = selectedOption.VendorIndex;
            }
            await OnSourceChanged.InvokeAsync(Node);
        }
    }
    
    private record DropdownOption(string Value, string Text, AcquisitionSource Source, int VendorIndex);

    private RenderFragment RenderNodeContentCore() => __builder =>
    {
        if (Node == null) return;

        var color = GetNodeColor();
        var hqStar = Node.MustBeHq ? "★ " : "";
        
        // HQ Toggle button (if item can be HQ)
        if (Node.CanBeHq)
        {
            __builder.OpenElement(0, "button");
            __builder.AddAttribute(1, "onclick", EventCallback.Factory.Create<MouseEventArgs>(this, OnHqToggle));
            __builder.AddEventStopPropagationAttribute(2, "onclick", true);
            __builder.AddAttribute(3, "style", $"background: transparent; border: none; cursor: pointer; color: {(Node.MustBeHq ? "#d4a73a" : "#666")}; font-size: 14px; padding: 0; width: 20px;");
            __builder.AddContent(4, "★");
            __builder.CloseElement();
        }
        else
        {
            __builder.OpenElement(4, "span");
            __builder.AddAttribute(5, "style", "width: 20px;");
            __builder.CloseElement();
        }
        
        // Item name and quantity
        __builder.OpenElement(6, "span");
        __builder.AddAttribute(7, "style", $"color: {color}; flex: 1;");
        __builder.AddContent(8, $"{hqStar}{Node.Name} x{Node.Quantity}");
        // Circular reference indicator
        if (Node.IsCircularReference)
        {
            __builder.OpenElement(9, "span");
            __builder.AddAttribute(10, "style", "color: #ff9800; margin-left: 6px; font-size: 12px; cursor: help;");
            __builder.AddAttribute(11, "title", "This item is already being crafted higher up in the recipe chain. To avoid infinite loops, purchase this from the market instead.");
            __builder.AddContent(12, "↻ circular");
            __builder.CloseElement();
        }
        __builder.CloseElement();
        
        // Recipe info (if craftable)
        if (!string.IsNullOrEmpty(Node.Job) && Node.Job != "Company Workshop")
        {
            __builder.OpenElement(9, "span");
            __builder.AddAttribute(10, "style", "color: #888; font-size: 12px;");
            __builder.AddContent(11, $"Lv.{Node.RecipeLevel} {Node.Job}");
            __builder.CloseElement();
        }
        
        // Acquisition source dropdown with vendor details
        var dropdownOptions = GetDropdownOptions();
        var currentValue = GetCurrentDropdownValue();
        
        __builder.OpenElement(12, "select");
        __builder.AddAttribute(13, "value", currentValue);
        __builder.AddAttribute(14, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, OnDropdownChange));
        __builder.AddEventStopPropagationAttribute(15, "onclick", true);
        __builder.AddAttribute(16, "style", "background: #2d2d2d; color: white; border: 1px solid #555; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer; min-width: 150px;");
        
        foreach (var option in dropdownOptions)
        {
            __builder.OpenElement(16, "option");
            __builder.AddAttribute(17, "value", option.Value);
            __builder.AddContent(18, option.Text);
            __builder.CloseElement();
        }
        
        __builder.CloseElement(); // select
        
        // Price display
        var priceText = GetPriceDisplay();
        if (!string.IsNullOrEmpty(priceText))
        {
            __builder.OpenElement(19, "span");
            __builder.AddAttribute(20, "style", "color: #4caf50; font-size: 12px; min-width: 80px; text-align: right;");
            __builder.AddContent(21, priceText);
            __builder.CloseElement();
        }
    };

    private string GetNodeColor()
    {
        if (Node == null) return "#ccc";
        return RecipePlanDisplayHelpers.GetSourceHexColor(Node.Source);
    }

    private static string GetSourceDisplayName(AcquisitionSource source)
    {
        return RecipePlanDisplayHelpers.GetSourceDisplayName(source);
    }

    private string GetPriceDisplay()
    {
        if (Node == null) return "";
        
        return Node.Source switch
        {
            AcquisitionSource.Craft => $"{CalculateCraftCost():N0}g",
            AcquisitionSource.MarketBuyNq => Node.MarketPrice > 0 ? $"{Node.MarketPrice:N0}g" : "",
            AcquisitionSource.MarketBuyHq => Node.HqMarketPrice > 0 ? $"{Node.HqMarketPrice:N0}g" : "",
            AcquisitionSource.VendorBuy => Node.VendorPrice > 0 ? $"{Node.VendorPrice:N0}g" : "",
            _ => ""
        };
    }

    private decimal CalculateCraftCost()
    {
        if (Node?.Children == null) return 0;
        
        decimal cost = 0;
        foreach (var child in Node.Children)
        {
            cost += child.Source switch
            {
                AcquisitionSource.Craft => CalculateChildCraftCost(child),
                AcquisitionSource.MarketBuyNq => child.MarketPrice * child.Quantity,
                AcquisitionSource.MarketBuyHq => child.HqMarketPrice * child.Quantity,
                _ => 0
            };
        }
        return cost;
    }

    private static decimal CalculateChildCraftCost(PlanNode node)
    {
        if (node.Children == null || !node.Children.Any()) 
            return node.MarketPrice * node.Quantity;
        
        decimal cost = 0;
        foreach (var child in node.Children)
        {
            cost += child.Source switch
            {
                AcquisitionSource.Craft => CalculateChildCraftCost(child),
                AcquisitionSource.MarketBuyNq => child.MarketPrice * child.Quantity,
                AcquisitionSource.MarketBuyHq => child.HqMarketPrice * child.Quantity,
                _ => 0
            };
        }
        return cost;
    }
}
