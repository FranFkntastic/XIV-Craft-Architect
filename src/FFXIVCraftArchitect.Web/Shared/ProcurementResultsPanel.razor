@using FFXIVCraftArchitect.Core.Models
@using FFXIVCraftArchitect.Core.Services
@inject ISnackbar Snackbar

<div style="display: flex; flex-direction: column; height: 100%; gap: 12px;">
    
    <!-- Header Summary Card -->
    <div style="flex-shrink: 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: #2a3a2a; border-radius: 6px; border: 1px solid #3a5a3a;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <MudIcon Icon="@Icons.Material.Filled.Assignment" Color="Color.Success" Size="Size.Medium" />
                <div>
                    <MudText Typo="Typo.subtitle1" Style="color: #90EE90; font-weight: 600;">Procurement Plan</MudText>
                    @if (Analysis != null)
                    {
                        <MudText Typo="Typo.caption" Style="color: #888;">
                            @Analysis.DataCenter Â· @Analysis.ItemsToCraft craft, @Analysis.ItemsToBuy buy
                        </MudText>
                    }
                </div>
            </div>
            @if (Analysis != null)
            {
                <div style="text-align: right;">
                    <MudText Typo="Typo.h6" Style="color: #d4a73a; font-weight: 700;">@Analysis.OptimalTotalCost.ToString("N0")g</MudText>
                    <MudText Typo="Typo.caption" Style="color: #888;">total optimal cost</MudText>
                </div>
            }
        </div>
        
        @if (Analysis != null)
        {
            <div style="display: flex; gap: 12px; margin-top: 8px;">
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 6px; background: rgba(33, 150, 243, 0.1); border-radius: 4px;">
                    <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Small" Style="color: #2196f3;" />
                    <MudText Typo="Typo.body2" Style="color: #2196f3; font-weight: 600;">@Analysis.ItemsToCraft Craft</MudText>
                    <MudText Typo="Typo.caption" Style="color: #888;">(@Analysis.TotalCraftCost.ToString("N0")g)</MudText>
                </div>
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 6px; background: rgba(76, 175, 80, 0.1); border-radius: 4px;">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Small" Style="color: #4caf50;" />
                    <MudText Typo="Typo.body2" Style="color: #4caf50; font-weight: 600;">@Analysis.ItemsToBuy Buy</MudText>
                    <MudText Typo="Typo.caption" Style="color: #888;">(@Analysis.TotalPurchaseCost.ToString("N0")g)</MudText>
                </div>
            </div>
        }
    </div>
    
    <!-- Expanded Item Panel (Top) -->
    @if (_expandedItem != null)
    {
        <div style="flex-shrink: 0; max-height: 50%; overflow-y: auto;">
            <ExpandedProcurementPanel Item="_expandedItem" ShoppingPlans="ShoppingPlans" OnClose="CloseExpanded" />
        </div>
    }
    
    <!-- Collapsed Cards Grid (Bottom) -->
    <div style="flex-grow: 1; overflow-y: auto; min-height: 0;">
        @if (Analysis?.ItemAnalyses?.Any() != true)
        {
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px; text-align: center; background: #252525; border-radius: 8px;">
                <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Large" Style="color: #555; margin-bottom: 16px;" />
                <MudText Typo="Typo.body1" Style="color: #888;">No procurement plan available</MudText>
                <MudText Typo="Typo.caption" Style="color: #666; margin-top: 8px;">
                    Build a project plan in the Recipe Planner to generate procurement recommendations
                </MudText>
            </div>
        }
        else
        {
            <!-- Section Headers and Cards -->
            <div style="display: flex; flex-direction: column; gap: 16px;">
                
                <!-- Items to Craft -->
                @if (GetItemsToCraft().Any())
                {
                    <div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #2196f3;">
                            <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Small" Style="color: #2196f3;" />
                            <MudText Typo="Typo.subtitle2" Style="color: #2196f3; font-weight: 600;">Items to Craft</MudText>
                            <MudText Typo="Typo.caption" Style="color: #888;">(@GetItemsToCraft().Count())</MudText>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 6px; align-items: start;">
                            @foreach (var item in GetItemsToCraft())
                            {
                                var isSelected = _expandedItem?.ItemId == item.ItemId;
                                <div @onclick="() => SelectItem(item)" style="cursor: pointer;">
                                    <ProcurementItemCard Item="item" IsSelected="isSelected" />
                                </div>
                            }
                        </div>
                    </div>
                }
                
                <!-- Items to Buy -->
                @if (GetItemsToBuy().Any())
                {
                    <div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #4caf50;">
                            <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Small" Style="color: #4caf50;" />
                            <MudText Typo="Typo.subtitle2" Style="color: #4caf50; font-weight: 600;">Items to Buy</MudText>
                            <MudText Typo="Typo.caption" Style="color: #888;">(@GetItemsToBuy().Count())</MudText>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 6px; align-items: start;">
                            @foreach (var item in GetItemsToBuy())
                            {
                                var isSelected = _expandedItem?.ItemId == item.ItemId;
                                <div @onclick="() => SelectItem(item)" style="cursor: pointer;">
                                    <ProcurementItemCard Item="item" IsSelected="isSelected" />
                                </div>
                            }
                        </div>
                    </div>
                }
                
                <!-- Items with No Data -->
                @if (GetItemsWithNoData().Any())
                {
                    <div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #666;">
                            <MudIcon Icon="@Icons.Material.Filled.Help" Size="Size.Small" Style="color: #666;" />
                            <MudText Typo="Typo.subtitle2" Style="color: #888; font-weight: 600;">No Data Available</MudText>
                            <MudText Typo="Typo.caption" Style="color: #888;">(@GetItemsWithNoData().Count())</MudText>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 6px; align-items: start;">
                            @foreach (var item in GetItemsWithNoData())
                            {
                                var isSelected = _expandedItem?.ItemId == item.ItemId;
                                <div @onclick="() => SelectItem(item)" style="cursor: pointer;">
                                    <ProcurementItemCard Item="item" IsSelected="isSelected" />
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public ProcurementAnalysis? Analysis { get; set; }
    
    [Parameter]
    public List<DetailedShoppingPlan> ShoppingPlans { get; set; } = new();
    
    private ItemProcurementAnalysis? _expandedItem;
    
    private void SelectItem(ItemProcurementAnalysis item)
    {
        if (_expandedItem?.ItemId == item.ItemId)
        {
            _expandedItem = null;
        }
        else
        {
            _expandedItem = item;
        }
    }
    
    private void CloseExpanded()
    {
        _expandedItem = null;
    }
    
    private IEnumerable<ItemProcurementAnalysis> GetItemsToCraft()
    {
        if (Analysis?.ItemAnalyses == null)
            return Enumerable.Empty<ItemProcurementAnalysis>();
        
        return Analysis.ItemAnalyses
            .Where(i => i.Recommendation == ProcurementRecommendation.Craft)
            .OrderBy(i => i.Name);
    }
    
    private IEnumerable<ItemProcurementAnalysis> GetItemsToBuy()
    {
        if (Analysis?.ItemAnalyses == null)
            return Enumerable.Empty<ItemProcurementAnalysis>();
        
        return Analysis.ItemAnalyses
            .Where(i => i.Recommendation == ProcurementRecommendation.BuyFromMarket)
            .OrderBy(i => i.Name);
    }
    
    private IEnumerable<ItemProcurementAnalysis> GetItemsWithNoData()
    {
        if (Analysis?.ItemAnalyses == null)
            return Enumerable.Empty<ItemProcurementAnalysis>();
        
        return Analysis.ItemAnalyses
            .Where(i => i.Recommendation == ProcurementRecommendation.NoDataAvailable)
            .OrderBy(i => i.Name);
    }
}
