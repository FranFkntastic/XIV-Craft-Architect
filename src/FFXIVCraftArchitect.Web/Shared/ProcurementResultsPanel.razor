@using FFXIVCraftArchitect.Core.Models
@using FFXIVCraftArchitect.Core.Services
@inject ISnackbar Snackbar

<div style="display: flex; flex-direction: column; height: 100%; gap: 12px;">
    
    <!-- Header with Summary -->
    <MudPaper Elevation="2" Class="pa-3" Style="background: linear-gradient(135deg, #2d2d2d 0%, #252525 100%); border-radius: 12px; flex-shrink: 0;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Primary" Size="Size.Medium" />
                <div>
                    <MudText Typo="Typo.h6" Style="color: #d4a73a; font-weight: 600;">Procurement Plan</MudText>
                    @if (Analysis != null)
                    {
                        <MudText Typo="Typo.caption" Style="color: #888;">
                            @Analysis.ItemsToCraft to craft, @Analysis.ItemsToBuy to buy
                            | Total: <span style="color: #90EE90; font-weight: 600;">@Analysis.OptimalTotalCost.ToString("N0")g</span>
                        </MudText>
                    }
                </div>
            </div>
            @if (Analysis != null)
            {
                <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Outlined">
                    @Analysis.DataCenter
                </MudChip>
            }
        </div>
    </MudPaper>
    
    <!-- Items List -->
    <MudPaper Elevation="1" Style="flex: 1; overflow-y: auto; border-radius: 12px; background: #1e1e1e;">
        @if (Analysis?.ItemAnalyses?.Any() != true)
        {
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px; text-align: center;">
                <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Large" Style="color: #555; margin-bottom: 16px;" />
                <MudText Typo="Typo.body1" Style="color: #888;">No procurement analysis available</MudText>
                <MudText Typo="Typo.caption" Style="color: #666; margin-top: 8px;">
                    Build a project plan in the Recipe Planner to see procurement recommendations
                </MudText>
            </div>
        }
        else
        {
            <MudList T="ItemProcurementAnalysis" Dense="true" Style="padding: 8px;">
                @foreach (var item in GetSortedItems())
                {
                    <MudListItem T="ItemProcurementAnalysis" Style="padding: 8px; margin-bottom: 8px; background: #2d2d2d; border-radius: 8px; border: 1px solid #383838;">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Item Header -->
                            <div style="display: flex; align-items: center; gap: 12px;">
                                @if (item.IconId > 0)
                                {
                                    <img src="@GetIconUrl(item.IconId)" 
                                         alt="@item.Name" 
                                         style="width: 32px; height: 32px; border-radius: 4px; background: #1a1a1a;" />
                                }
                                else
                                {
                                    <div style="width: 32px; height: 32px; border-radius: 4px; background: #1a1a1a; display: flex; align-items: center; justify-content: center;">
                                        <MudIcon Icon="@Icons.Material.Filled.Help" Size="Size.Small" Style="color: #666;" />
                                    </div>
                                }
                                
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <MudText Typo="Typo.body2" Style="color: #fff; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                            @item.Name
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #888;">x@(item.QuantityNeeded)</MudText>
                                    </div>
                                    
                                    <!-- Recommendation Badge -->
                                    @if (item.Recommendation == ProcurementRecommendation.Craft)
                                    {
                                        <MudChip T="string" Color="Color.Info" Size="Size.Small" Style="height: 20px; font-size: 10px;">
                                            <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Small" Style="font-size: 12px; margin-right: 4px;" />
                                            Craft
                                        </MudChip>
                                    }
                                    else if (item.Recommendation == ProcurementRecommendation.BuyFromMarket)
                                    {
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small" Style="height: 20px; font-size: 10px;">
                                            <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Small" Style="font-size: 12px; margin-right: 4px;" />
                                            Buy
                                        </MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Color="Color.Default" Size="Size.Small" Style="height: 20px; font-size: 10px;">No Data</MudChip>
                                    }
                                </div>
                                
                                <!-- Cost Display -->
                                <div style="text-align: right;">
                                    @if (item.Recommendation == ProcurementRecommendation.Craft)
                                    {
                                        <MudText Typo="Typo.body2" Style="color: #90EE90; font-weight: 600;">@item.CraftCost.ToString("N0")g</MudText>
                                        <MudText Typo="Typo.caption" Style="color: #888;">craft cost</MudText>
                                    }
                                    else if (item.BestWorldPurchase != null)
                                    {
                                        <MudText Typo="Typo.body2" Style="color: #90EE90; font-weight: 600;">@item.BestWorldPurchase.TotalCost.ToString("N0")g</MudText>
                                        <MudText Typo="Typo.caption" Style="color: #888;">@@ @item.BestWorldPurchase.WorldName</MudText>
                                    }
                                    else if (item.HasMarketData)
                                    {
                                        <MudText Typo="Typo.body2" Style="color: #d4a73a;">@item.TotalMarketCost.ToString("N0")g</MudText>
                                        <MudText Typo="Typo.caption" Style="color: #888;">market avg</MudText>
                                    }
                                </div>
                            </div>
                            
                            <!-- Best World Details (if buying) -->
                            @if (item.Recommendation == ProcurementRecommendation.BuyFromMarket && item.BestWorldPurchase != null)
                            {
                                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #1a1a1a; border-radius: 6px; margin-left: 44px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" Style="color: #4caf50;" />
                                    <MudText Typo="Typo.caption" Style="color: #ccc;">
                                        Best world: <span style="color: #90EE90; font-weight: 500;">@item.BestWorldPurchase.WorldName</span>
                                    </MudText>
                                    <MudText Typo="Typo.caption" Style="color: #888;">
                                        @item.BestWorldPurchase.UnitPrice.ToString("N0")g each
                                        Â· @item.BestWorldPurchase.ListingsNeeded listing@(item.BestWorldPurchase.ListingsNeeded > 1 ? "s" : "")
                                    </MudText>
                                </div>
                            }
                            
                            <!-- Craft Components (if crafting) -->
                            @if (item.Recommendation == ProcurementRecommendation.Craft && item.CraftComponents?.Any() == true)
                            {
                                <div style="margin-left: 44px; padding: 6px 8px; background: #1a1a1a; border-radius: 6px;">
                                    <MudText Typo="Typo.caption" Style="color: #888; margin-bottom: 4px; display: block;">Components:</MudText>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        @foreach (var component in item.CraftComponents)
                                        {
                                            <div style="display: flex; align-items: center; gap: 4px; background: #2d2d2d; padding: 2px 8px; border-radius: 4px;">
                                                @if (component.IconId > 0)
                                                {
                                                    <img src="@GetIconUrl(component.IconId)" style="width: 16px; height: 16px;" />
                                                }
                                                <MudText Typo="Typo.caption" Style="color: #ccc;">@component.Name x@(component.Quantity)</MudText>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            
                            <!-- No Data Warning -->
                            @if (!item.HasMarketData && item.Recommendation == ProcurementRecommendation.NoDataAvailable)
                            {
                                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #3d2d20; border-radius: 6px; margin-left: 44px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Style="color: #ff9800;" />
                                    <MudText Typo="Typo.caption" Style="color: #ff9800;">No market data available</MudText>
                                </div>
                            }
                        </div>
                    </MudListItem>
                }
            </MudList>
        }
    </MudPaper>
    
    <!-- Legend -->
    @if (Analysis?.ItemAnalyses?.Any() == true)
    {
        <MudPaper Elevation="1" Class="pa-2" Style="background: #252525; border-radius: 8px; flex-shrink: 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 16px;">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Small" Style="color: #2196f3;" />
                    <MudText Typo="Typo.caption" Style="color: #888;">Craft</MudText>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Small" Style="color: #4caf50;" />
                    <MudText Typo="Typo.caption" Style="color: #888;">Buy</MudText>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" Style="color: #90EE90;" />
                    <MudText Typo="Typo.caption" Style="color: #888;">Best World</MudText>
                </div>
            </div>
        </MudPaper>
    }
</div>

@code {
    [Parameter]
    public ProcurementAnalysis? Analysis { get; set; }
    
    [Parameter]
    public RecommendationMode SortMode { get; set; } = RecommendationMode.MinimizeTotalCost;
    
    private List<ItemProcurementAnalysis> GetSortedItems()
    {
        if (Analysis?.ItemAnalyses == null)
            return new List<ItemProcurementAnalysis>();
        
        var items = Analysis.ItemAnalyses.ToList();
        
        return SortMode switch
        {
            RecommendationMode.MinimizeTotalCost => items
                .OrderBy(i => i.Recommendation == ProcurementRecommendation.NoDataAvailable)
                .ThenBy(i => i.Name)
                .ToList(),
            RecommendationMode.MaximizeValue => items
                .OrderByDescending(i => GetTotalCost(i))
                .ToList(),
            RecommendationMode.BestUnitPrice => items
                .OrderBy(i => i.BestWorldPurchase?.UnitPrice ?? decimal.MaxValue)
                .ToList(),
            _ => items.OrderBy(i => i.Name).ToList()
        };
    }
    
    private decimal GetTotalCost(ItemProcurementAnalysis item)
    {
        return item.Recommendation switch
        {
            ProcurementRecommendation.Craft => item.CraftCost,
            ProcurementRecommendation.BuyFromMarket => item.BestWorldPurchase?.TotalCost ?? item.TotalMarketCost,
            _ => 0
        };
    }
    
    private string GetIconUrl(int iconId)
    {
        // Garland Tools icon URL format
        return $"https://www.garlandtools.org/files/icons/item/{iconId}.png";
    }
}
