@using FFXIVCraftArchitect.Core.Models
@using FFXIVCraftArchitect.Core.Services
@using FFXIVCraftArchitect.Web.Services
@inject ISnackbar Snackbar
@inject AppState AppState

@* Type alias to avoid confusion with WorldProcurementCard component *@
@using WorldCardModel = FFXIVCraftArchitect.Core.Models.WorldProcurementCardModel

<div style="display: flex; flex-direction: column; height: 100%; gap: 8px;">
    
    <!-- Header Summary Card -->
    <div style="flex-shrink: 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #2a3a2a; border-radius: 6px; border: 1px solid #3a5a3a;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <MudIcon Icon="@Icons.Material.Filled.Assignment" Color="Color.Success" Size="Size.Medium" />
                <div>
                    <MudText Typo="Typo.subtitle1" Style="color: #90EE90; font-weight: 600;">Procurement Plan</MudText>
                    @if (Analysis != null)
                    {
                        <MudText Typo="Typo.caption" Style="color: #888;">
                            @Analysis.DataCenter Â· @Analysis.ItemsToBuy items
                        </MudText>
                    }
                </div>
            </div>
            @if (Analysis != null)
            {
                <div style="text-align: right;">
                    <MudText Typo="Typo.h6" Style="color: #d4a73a; font-weight: 700;">@Analysis.OptimalTotalCost.ToString("N0")g</MudText>
                    <MudText Typo="Typo.caption" Style="color: #888;">total cost</MudText>
                </div>
            }
        </div>
    </div>
    
    <!-- Expanded Item Panel (Top) -->
    @if (_expandedItem != null)
    {
        <div style="flex-shrink: 0; max-height: 50%; overflow-y: auto;">
            <ExpandedProcurementPanel Item="_expandedItem" ShoppingPlans="ShoppingPlans" OnClose="CloseExpanded" />
        </div>
    }
    
    <!-- View Toggle -->
    @if (Analysis?.ItemAnalyses?.Any() == true)
    {
        <div style="flex-shrink: 0; display: flex; gap: 6px;">
            <MudButton OnClick="() => _viewMode = ViewMode.Cards" 
                       Color="@(_viewMode == ViewMode.Cards ? Color.Primary : Color.Default)"
                       Variant="Variant.Outlined" 
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.GridView">
                Cards
            </MudButton>
            <MudButton OnClick="() => _viewMode = ViewMode.TextList" 
                       Color="@(_viewMode == ViewMode.TextList ? Color.Primary : Color.Default)"
                       Variant="Variant.Outlined" 
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.List">
                Shopping List
            </MudButton>
        </div>
    }
    
    <!-- Content Area -->
    <div style="flex-grow: 1; overflow-y: auto; min-height: 0;">
        @if (Analysis?.ItemAnalyses?.Any() != true)
        {
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px; text-align: center; background: #252525; border-radius: 8px;">
                <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Large" Style="color: #555; margin-bottom: 16px;" />
                <MudText Typo="Typo.body1" Style="color: #888;">No procurement plan available</MudText>
                <MudText Typo="Typo.caption" Style="color: #666; margin-top: 8px;">
                    Build a project plan in the Recipe Planner to generate procurement recommendations
                </MudText>
            </div>
        }
        else if (_viewMode == ViewMode.TextList)
        {
            <!-- Text-based Shopping List View - Markdown Format -->
            <div style="height: 100%; display: flex; flex-direction: column;">
                <div style="flex: 1; position: relative;">
                    <textarea readonly 
                              style="width: 100%; height: 100%; background: #1a1a1a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; padding: 12px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; line-height: 1.5; resize: none; white-space: pre; overflow-wrap: normal; overflow-x: auto;"
                              spellcheck="false">@GenerateShoppingListText()</textarea>
                </div>
                <MudText Typo="Typo.caption" Style="color: #666; margin-top: 8px; text-align: center;">
                    Copy and paste this list directly into your notes
                </MudText>
            </div>
        }
        else
        {
            <!-- Card View - World-Centric -->
            <div style="display: flex; flex-direction: column; gap: 12px;">
                @{ 
                    var worldCards = GetWorldCards().ToList();
                    var noDataItemsCard = GetItemsWithNoData().ToList();
                }
                
                <!-- Market & Vendor World Cards -->
                @foreach (var worldCard in worldCards)
                {
                    <WorldProcurementCard 
                        Card="worldCard" 
                        IsExpanded="_expandedWorld == worldCard.WorldName"
                        IsExpandedChanged="(expanded) => OnWorldExpanded(worldCard.WorldName, expanded)"
                        OnItemSelected="OnWorldItemSelected"
                        OnReanalyzeRequested="OnReanalyzeWithoutWorld" />
                }
                
                <!-- Items with No Data -->
                @if (noDataItemsCard.Any())
                {
                    <div>
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; padding: 3px 8px; background: #2a2a2a; border-radius: 3px; border: 1px solid #555;">
                            <MudIcon Icon="@Icons.Material.Filled.Help" Size="Size.Small" Style="color: #666;" />
                            <MudText Typo="Typo.subtitle2" Style="color: #888; font-weight: 600;">No Data</MudText>
                            <MudText Typo="Typo.caption" Style="color: #888;">(@noDataItemsCard.Count)</MudText>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 4px; align-items: start;">
                            @foreach (var item in noDataItemsCard)
                            {
                                var isSelected = _expandedItem?.ItemId == item.ItemId;
                                <div @onclick="() => SelectItem(item)" style="cursor: pointer;">
                                    <ProcurementItemCard Item="item" ShoppingPlan="GetShoppingPlan(item.ItemId)" IsSelected="isSelected" />
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public ProcurementAnalysis? Analysis { get; set; }
    
    [Parameter]
    public List<DetailedShoppingPlan> ShoppingPlans { get; set; } = new();
    
    /// <summary>
    /// Called when user requests re-analysis without a specific world (due to congestion).
    /// </summary>
    [Parameter]
    public EventCallback<string> OnReanalyzeWithoutWorldRequested { get; set; }
    
    private ItemProcurementAnalysis? _expandedItem;
    private ViewMode _viewMode = ViewMode.Cards;
    private string? _expandedWorld = null;
    
    private enum ViewMode
    {
        Cards,
        TextList
    }
    
    private void SelectItem(ItemProcurementAnalysis item)
    {
        if (_expandedItem?.ItemId == item.ItemId)
        {
            _expandedItem = null;
        }
        else
        {
            _expandedItem = item;
        }
    }
    
    private void CloseExpanded()
    {
        _expandedItem = null;
    }
    
    private DetailedShoppingPlan? GetShoppingPlan(int itemId)
    {
        return ShoppingPlans.FirstOrDefault(p => p.ItemId == itemId);
    }
    
    // === FILTER METHODS ===
    
    private IEnumerable<ItemProcurementAnalysis> GetItemsToBuy()
    {
        if (Analysis?.ItemAnalyses == null)
            return Enumerable.Empty<ItemProcurementAnalysis>();
        
        return Analysis.ItemAnalyses
            .Where(i => i.Recommendation == ProcurementRecommendation.BuyFromMarket)
            .OrderBy(i => i.Name);
    }
    
    private IEnumerable<ItemProcurementAnalysis> GetItemsWithNoData()
    {
        if (Analysis?.ItemAnalyses == null)
            return Enumerable.Empty<ItemProcurementAnalysis>();
        
        return Analysis.ItemAnalyses
            .Where(i => i.Recommendation == ProcurementRecommendation.NoDataAvailable)
            .OrderBy(i => i.Name);
    }
    
    // === WORLD-CENTRIC CARD METHODS ===
    
    private void OnWorldExpanded(string worldName, bool expanded)
    {
        if (expanded)
        {
            _expandedWorld = worldName;
        }
        else if (_expandedWorld == worldName)
        {
            _expandedWorld = null;
        }
    }
    
    private void OnWorldItemSelected(WorldItemPurchase item)
    {
        if (item.SourcePlan != null)
        {
            // Find the corresponding ItemProcurementAnalysis
            var analysis = Analysis?.ItemAnalyses.FirstOrDefault(a => a.ItemId == item.ItemId);
            if (analysis != null)
            {
                SelectItem(analysis);
            }
        }
    }
    
    private async Task OnReanalyzeWithoutWorld(string worldName)
    {
        // Collapse all cards before re-analysis
        _expandedWorld = null;
        
        // Notify parent to re-run analysis with this world blacklisted
        await OnReanalyzeWithoutWorldRequested.InvokeAsync(worldName);
    }
    
    /// <summary>
    /// Groups procurement items by world, aggregating both single-world and split purchases.
    /// Creates WorldProcurementCard objects for each world with all items to buy there.
    /// </summary>
    private IEnumerable<WorldCardModel> GetWorldCards()
    {
        if (Analysis?.ItemAnalyses == null || !ShoppingPlans.Any())
            return Enumerable.Empty<WorldCardModel>();
        
        var worldCards = new Dictionary<string, WorldCardModel>(StringComparer.OrdinalIgnoreCase);
        
        foreach (var item in GetItemsToBuy())
        {
            var plan = GetShoppingPlan(item.ItemId);
            if (plan == null) continue;
            
            // Handle split purchases
            if (plan.RequiresSplitPurchase && plan.RecommendedSplit?.Any() == true)
            {
                foreach (var split in plan.RecommendedSplit)
                {
                    var worldName = split.WorldName;
                    
                    if (!worldCards.TryGetValue(worldName, out var card))
                    {
                        var worldOption = plan.WorldOptions.FirstOrDefault(w => w.WorldName == worldName);
                        card = new WorldCardModel
                        {
                            WorldName = worldName,
                            DataCenter = Analysis.DataCenter,
                            IsCongested = worldOption?.IsCongested ?? false,
                            Classification = worldOption?.Classification ?? WorldClassification.Standard
                        };
                        worldCards[worldName] = card;
                    }
                    
                    card.Items.Add(new WorldItemPurchase
                    {
                        ItemId = item.ItemId,
                        ItemName = item.Name,
                        IconId = item.IconId,
                        QuantityOnThisWorld = split.QuantityToBuy,
                        TotalQuantityNeeded = item.QuantityNeeded,
                        PricePerUnit = split.PricePerUnit,
                        TotalCost = split.TotalCost,
                        IsSplitPurchase = true,
                        SourcePlan = plan,
                        TravelContext = split.IsPartial ? "Supplemental" : "Primary"
                    });
                }
            }
            // Handle single-world purchases (including vendor)
            else if (plan.RecommendedWorld != null)
            {
                var worldName = plan.RecommendedWorld.WorldName;
                
                if (!worldCards.TryGetValue(worldName, out var card))
                {
                    card = new WorldCardModel
                    {
                        WorldName = worldName,
                        DataCenter = Analysis.DataCenter,
                        IsCongested = plan.RecommendedWorld.IsCongested,
                        Classification = plan.RecommendedWorld.Classification,
                        // For vendor cards, aggregate vendor info from all items
                        Vendors = worldName == "Vendor" ? GetVendorInfoForVendorCard(item.ItemId, plan) : new List<GarlandVendor>(),
                        // Include the specific selected vendor name for display
                        SelectedVendorName = worldName == "Vendor" ? plan.RecommendedWorld?.VendorName : null
                    };
                    worldCards[worldName] = card;
                }
                
                card.Items.Add(new WorldItemPurchase
                {
                    ItemId = item.ItemId,
                    ItemName = item.Name,
                    IconId = item.IconId,
                    QuantityOnThisWorld = item.QuantityNeeded,
                    TotalQuantityNeeded = item.QuantityNeeded,
                    PricePerUnit = plan.RecommendedWorld.AveragePricePerUnit,
                    TotalCost = plan.RecommendedWorld.TotalCost,
                    IsSplitPurchase = false,
                    SourcePlan = plan,
                    TravelContext = "Primary"
                });
            }
        }
        
        // Sort: non-vendor worlds by cost (descending), vendor always last
        return worldCards.Values
            .OrderBy(w => w.IsVendor ? 1 : 0)
            .ThenByDescending(w => w.TotalCost);
    }
    
    /// <summary>
    /// Gets vendor information for a vendor card from the plan's Vendors property.
    /// </summary>
    private List<GarlandVendor> GetVendorInfoForVendorCard(int itemId, DetailedShoppingPlan plan)
    {
        // Get vendors from the plan's Vendors property (populated during market analysis)
        if (plan.Vendors?.Any() == true)
        {
            return plan.Vendors.ToList();
        }
        
        return new List<GarlandVendor>();
    }
    
    /// <summary>
    /// Generates a markdown-formatted shopping list grouped by world.
    /// </summary>
    private string GenerateShoppingListText()
    {
        if (Analysis?.ItemAnalyses == null || !ShoppingPlans.Any())
            return "# Shopping List\n\nNo items to purchase.";
        
        var sb = new System.Text.StringBuilder();
        sb.AppendLine("# FFXIV Craft Architect - Shopping List");
        sb.AppendLine();
        sb.AppendLine($"**Data Center:** {Analysis.DataCenter}");
        sb.AppendLine($"**Generated:** {DateTime.Now:yyyy-MM-dd HH:mm}");
        sb.AppendLine();
        
        var worldCards = GetWorldCards().ToList();
        var noDataItems = GetItemsWithNoData().ToList();
        
        if (!worldCards.Any() && !noDataItems.Any())
        {
            sb.AppendLine("_No items to purchase._");
            return sb.ToString();
        }
        
        // World sections
        foreach (var world in worldCards)
        {
            sb.AppendLine($"## {(world.IsVendor ? "ðŸª Vendor" : $"ðŸŒ {world.WorldName}")}");
            sb.AppendLine();
            
            foreach (var item in world.Items.OrderBy(i => i.ItemName))
            {
                var qtyDisplay = item.IsSplitPurchase 
                    ? $"Ã—{item.QuantityOnThisWorld} of {item.TotalQuantityNeeded}"
                    : $"Ã—{item.QuantityOnThisWorld}";
                
                sb.AppendLine($"- **{item.ItemName}** {qtyDisplay} @ {item.PricePerUnit:N0}g = **{item.TotalCost:N0}g**");
                
                // Add vendor information for vendor purchases
                if (world.IsVendor)
                {
                    var plan = ShoppingPlans.FirstOrDefault(p => p.ItemId == item.ItemId);
                    if (plan?.Vendors?.Any() == true)
                    {
                        var vendor = plan.Vendors.FirstOrDefault(v => v.Price == item.PricePerUnit) 
                            ?? plan.Vendors.FirstOrDefault();
                        if (vendor != null)
                        {
                            sb.AppendLine($"   ðŸ“ {vendor.Name} - {vendor.Location}");
                        }
                    }
                }
            }
            
            sb.AppendLine();
            sb.AppendLine($"**Subtotal: {world.TotalCost:N0}g**");
            sb.AppendLine();
        }
        
        // No data section
        if (noDataItems.Any())
        {
            sb.AppendLine("## âš ï¸ No Market Data");
            sb.AppendLine();
            foreach (var item in noDataItems.OrderBy(i => i.Name))
            {
                sb.AppendLine($"- {item.Name} Ã—{item.QuantityNeeded}");
            }
            sb.AppendLine();
        }
        
        // Grand total
        var grandTotal = worldCards.Sum(w => w.TotalCost);
        sb.AppendLine("---");
        sb.AppendLine($"## **Grand Total: {grandTotal:N0}g**");
        sb.AppendLine();
        sb.AppendLine($"_Items to buy: {worldCards.Sum(w => w.ItemCount)} | Total quantity: {worldCards.Sum(w => w.TotalQuantity)}_");
        
        return sb.ToString();
    }
}
