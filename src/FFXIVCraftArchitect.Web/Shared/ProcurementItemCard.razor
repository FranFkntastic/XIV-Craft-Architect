@using FFXIVCraftArchitect.Core.Services
@using FFXIVCraftArchitect.Core.Models

@* Two-line card for procurement items *@
<div style="background: @(IsSelected ? "#3a3a30" : GetBackgroundColor()); border-radius: 4px; border: 1px solid @(IsSelected ? "#d4a73a" : GetBorderColor()); overflow: hidden; min-height: 56px;">
    
    @* Line 1: Item Name *@
    <div style="padding: 6px 10px 2px 10px; border-bottom: 1px solid #3a3a3a;">
        <MudText Typo="Typo.body2" Style="color: #fff; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            @Item.Name
        </MudText>
    </div>
    
    @* Line 2: Details *@
    <div style="display: flex; align-items: center; padding: 4px 10px 6px 10px;">
        
        <!-- Source icon -->
        <MudIcon Icon="@GetSourceIcon()" 
                 Style="@GetSourceIconStyle()" 
                 Size="Size.Small" />
        
        <!-- Quantity -->
        <MudText Typo="Typo.caption" Style="color: #d4a73a; margin-right: 12px; min-width: 40px;">
            Ã—@(Item.QuantityNeeded)
        </MudText>
        
        <!-- World / Source info -->
        <div style="flex: 1; min-width: 0; overflow: hidden;">
            @if (IsSplitWorld)
            {
                <MudText Typo="Typo.caption" Style="color: #ff9800; font-weight: 500;">
                    @string.Join(" + ", ShoppingPlan!.RecommendedSplit!.Select(s => $"{s.QuantityToBuy}@{s.WorldName}"))
                </MudText>
            }
            else if (IsVendorItem)
            {
                <MudText Typo="Typo.caption" Style="color: #d4a73a; font-weight: 500;">
                    VENDOR
                </MudText>
            }
            else if (Item.BestWorldPurchase != null)
            {
                <MudText Typo="Typo.caption" Style="color: #90EE90; font-weight: 500;">
                    @Item.BestWorldPurchase.WorldName
                </MudText>
            }
        </div>
        
        <!-- Price -->
        <div style="text-align: right;">
            @if (IsSplitWorld && ShoppingPlan?.SplitTotalCost.HasValue == true)
            {
                <MudText Typo="Typo.body2" Style="color: #ff9800; font-weight: 600;">
                    @ShoppingPlan.SplitTotalCost.Value.ToString("N0")g
                </MudText>
            }
            else if (IsVendorItem && ShoppingPlan?.RecommendedWorld != null)
            {
                <MudText Typo="Typo.body2" Style="color: #d4a73a; font-weight: 600;">
                    @ShoppingPlan.RecommendedWorld.TotalCost.ToString("N0")g
                </MudText>
                <MudText Typo="Typo.caption" Style="color: #888; font-size: 10px; display: block;">
                    @ShoppingPlan.RecommendedWorld.AveragePricePerUnit.ToString("N0")g/ea
                </MudText>
            }
            else if (Item.BestWorldPurchase != null)
            {
                <MudText Typo="Typo.body2" Style="color: #d4a73a; font-weight: 600;">
                    @Item.BestWorldPurchase.TotalCost.ToString("N0")g
                </MudText>
                <MudText Typo="Typo.caption" Style="color: #888; font-size: 10px; display: block;">
                    @Item.BestWorldPurchase.UnitPrice.ToString("N0")g/ea
                </MudText>
            }
            else
            {
                <MudText Typo="Typo.caption" Style="color: #666;">-</MudText>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public ItemProcurementAnalysis Item { get; set; } = null!;
    [Parameter] public DetailedShoppingPlan? ShoppingPlan { get; set; }
    [Parameter] public bool IsSelected { get; set; } = false;

    private bool IsVendorItem => ShoppingPlan?.RecommendedWorld?.WorldName == "Vendor";
    private bool IsSplitWorld => ShoppingPlan?.RequiresSplitPurchase == true && ShoppingPlan?.RecommendedSplit?.Any() == true;

    private string GetBackgroundColor() => IsVendorItem 
        ? "#2a2520"  // Vendor items - warm brown
        : "#20252a"; // Market items - cool blue-gray

    private string GetBorderColor() => IsVendorItem 
        ? "#5a4a3a"  // Vendor border
        : "#3a4a5a"; // Market border

    private string GetSourceIcon() => IsVendorItem 
        ? Icons.Material.Filled.Store 
        : (IsSplitWorld ? Icons.Material.Filled.CallSplit : Icons.Material.Filled.ShoppingCart);

    private string GetSourceIconStyle() => IsVendorItem 
        ? "color: #d4a73a; margin-right: 8px;" 
        : (IsSplitWorld ? "color: #ff9800; margin-right: 8px;" : "color: #87ceeb; margin-right: 8px;");
}
