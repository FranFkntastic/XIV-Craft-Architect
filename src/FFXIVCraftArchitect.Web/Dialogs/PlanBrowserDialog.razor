@using FFXIVCraftArchitect.Web.Services
@inject AppState AppState
@inject IndexedDbService IndexedDb
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudDialog Style="min-width: 500px; max-width: 600px;">
    <DialogContent>
        <div style="display: flex; flex-direction: column; gap: 16px;">
            <!-- Header -->
            <MudText Typo="Typo.h5" Style="color: #fff; font-weight: 600;">Saved Plans</MudText>
            
            <!-- Plan List -->
            <MudPaper Elevation="0" Style="background: #2d2d2d; border-radius: 4px; overflow: hidden;">
                @if (_savedPlans?.Any() != true)
                {
                    <div style="padding: 24px; text-align: center;">
                        <MudText Typo="Typo.body2" Style="color: #666;">
                            No saved plans found
                        </MudText>
                    </div>
                }
                else
                {
                    <MudList T="StoredPlanSummary" Dense="true" Style="padding: 0;">
                        @foreach (var plan in _savedPlans.OrderByDescending(p => p.ModifiedAt))
                        {
                            var isSelected = _selectedPlan?.Id == plan.Id;
                            <MudListItem T="StoredPlanSummary" 
                                         Style="@GetItemStyle(isSelected)"
                                         OnClick="() => SelectPlan(plan)">
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px;">
                                    <div style="display: flex; flex-direction: column; gap: 2px;">
                                        <MudText Typo="Typo.body1" 
                                                 Style="@GetNameStyle(isSelected)">
                                            @plan.Name
                                            @if (plan.Id == AppState.CurrentPlanId)
                                            {
                                                <span style="color: #4caf50; font-size: 11px; margin-left: 8px;">(current)</span>
                                            }
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #888;">
                                            @plan.ItemCount items Â· @plan.DataCenter
                                        </MudText>
                                    </div>
                                    <MudText Typo="Typo.caption" Style="color: #666; font-size: 11px;">
                                        @plan.ModifiedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                                    </MudText>
                                </div>
                            </MudListItem>
                        }
                    </MudList>
                }
            </MudPaper>
        </div>
    </DialogContent>
    <DialogActions>
        <div style="display: flex; gap: 8px; width: 100%; padding: 8px 16px;">
            <MudButton OnClick="OnRenamePlan"
                       Color="Color.Secondary"
                       Variant="Variant.Outlined"
                       Size="Size.Small"
                       Disabled="@(_selectedPlan == null)"
                       StartIcon="@Icons.Material.Filled.Edit">
                Rename
            </MudButton>
            <MudButton OnClick="OnDeletePlan"
                       Color="Color.Error"
                       Variant="Variant.Outlined"
                       Size="Size.Small"
                       Disabled="@(_selectedPlan == null)"
                       StartIcon="@Icons.Material.Filled.Delete">
                Delete
            </MudButton>
            <MudSpacer />
            <MudButton OnClick="Close"
                       Color="Color.Secondary"
                       Variant="Variant.Text"
                       Size="Size.Small">
                Cancel
            </MudButton>
            <MudButton OnClick="OnLoadPlan"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       Size="Size.Small"
                       Disabled="@(_selectedPlan == null)"
                       StartIcon="@Icons.Material.Filled.FolderOpen">
                Load
            </MudButton>
        </div>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    
    private List<StoredPlanSummary> _savedPlans = new();
    private StoredPlanSummary? _selectedPlan;
    
    protected override async Task OnInitializedAsync()
    {
        await RefreshSavedPlansListAsync();
    }
    
    private async Task RefreshSavedPlansListAsync()
    {
        try
        {
            var plans = await IndexedDb.LoadAllPlansAsync();
            _savedPlans = plans
                .Where(p => p.Id != "autosave")
                .Select(p => new StoredPlanSummary
                {
                    Id = p.Id,
                    Name = p.Name,
                    ModifiedAt = p.ModifiedAt,
                    SavedAt = p.SavedAt,
                    DataCenter = p.DataCenter,
                    ItemCount = p.ProjectItems.Count
                })
                .ToList();
            
            // Clear selection if plan no longer exists
            if (_selectedPlan != null && !_savedPlans.Any(p => p.Id == _selectedPlan.Id))
            {
                _selectedPlan = null;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load saved plans: {ex.Message}", Severity.Error);
        }
    }
    
    private void SelectPlan(StoredPlanSummary plan)
    {
        _selectedPlan = plan;
    }
    
    private string GetItemStyle(bool isSelected)
    {
        if (isSelected)
            return "background: #3d3d3d; cursor: pointer;";
        return "cursor: pointer;";
    }
    
    private string GetNameStyle(bool isSelected)
    {
        if (isSelected)
            return "color: #d4a73a; font-weight: 600;";
        return "color: #fff; font-weight: 500;";
    }
    
    private async Task OnRenamePlan()
    {
        if (_selectedPlan == null) return;
        
        var parameters = new DialogParameters
        {
            ["CurrentName"] = _selectedPlan.Name
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<RenamePlanDialog>("Rename Plan", parameters, options);
        var result = await dialog.Result;
        
        if (result?.Data is string newName && !string.IsNullOrWhiteSpace(newName) && newName != _selectedPlan.Name)
        {
            try
            {
                // Load, rename, and save
                var plan = await IndexedDb.LoadPlanAsync(_selectedPlan.Id);
                if (plan == null)
                {
                    Snackbar.Add("Plan not found", Severity.Error);
                    return;
                }
                
                var oldName = plan.Name;
                plan.Name = newName;
                plan.ModifiedAt = DateTime.UtcNow;
                
                var success = await IndexedDb.SavePlanAsync(plan);
                if (success)
                {
                    Snackbar.Add($"Renamed '{oldName}' to '{newName}'", Severity.Success);
                    
                    // Update current plan name if this is the current plan
                    if (_selectedPlan.Id == AppState.CurrentPlanId)
                    {
                        AppState.CurrentPlanName = newName;
                    }
                    
                    await RefreshSavedPlansListAsync();
                    
                    // Re-select the renamed plan
                    _selectedPlan = _savedPlans.FirstOrDefault(p => p.Id == _selectedPlan.Id);
                }
                else
                {
                    Snackbar.Add("Failed to rename plan", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Rename failed: {ex.Message}", Severity.Error);
            }
        }
    }
    
    private async Task OnDeletePlan()
    {
        if (_selectedPlan == null) return;
        
        // Check if deleting current plan
        var isCurrentPlan = _selectedPlan.Id == AppState.CurrentPlanId;
        var message = isCurrentPlan 
            ? $"'{_selectedPlan.Name}' is your current plan. Deleting it will not affect your current work, but you won't be able to overwrite it anymore. Continue?"
            : $"Are you sure you want to delete '{_selectedPlan.Name}'?";
        
        var confirm = await DialogService.ShowMessageBox(
            "Delete Plan",
            message,
            yesText: "Delete",
            cancelText: "Cancel");
        
        if (confirm == true)
        {
            try
            {
                var success = await IndexedDb.DeletePlanAsync(_selectedPlan.Id);
                if (success)
                {
                    Snackbar.Add($"Deleted '{_selectedPlan.Name}'", Severity.Success);
                    
                    // If we deleted the current plan, clear the tracking
                    if (isCurrentPlan)
                    {
                        AppState.ClearCurrentPlanId();
                    }
                    
                    _selectedPlan = null;
                    await RefreshSavedPlansListAsync();
                }
                else
                {
                    Snackbar.Add("Failed to delete plan", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Delete failed: {ex.Message}", Severity.Error);
            }
        }
    }
    
    private async Task OnLoadPlan()
    {
        if (_selectedPlan == null) return;
        
        try
        {
            var storedPlan = await IndexedDb.LoadPlanAsync(_selectedPlan.Id);
            if (storedPlan == null)
            {
                Snackbar.Add("Plan not found", Severity.Error);
                return;
            }
            
            CraftingPlan? plan = null;
            if (!string.IsNullOrEmpty(storedPlan.PlanJson))
            {
                try
                {
                    plan = System.Text.Json.JsonSerializer.Deserialize<CraftingPlan>(storedPlan.PlanJson);
                }
                catch { /* Plan JSON may be incompatible, that's ok */ }
            }
            
            AppState.LoadStoredPlan(storedPlan, plan);
            Snackbar.Add($"Loaded '{storedPlan.Name}'", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load plan: {ex.Message}", Severity.Error);
        }
    }
    
    private void Close()
    {
        MudDialog.Close();
    }
}
