@using FFXIVCraftArchitect.Web.Services
@using FFXIVCraftArchitect.Core.Models
@inject AppState AppState
@inject IndexedDbService IndexedDb
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudDialog Style="min-width: 500px; max-width: 600px;">
    <DialogContent>
        <div style="display: flex; flex-direction: column; gap: 16px;">
            <!-- Header -->
            <MudText Typo="Typo.h5" Style="color: #fff; font-weight: 600;">Saved Plans</MudText>
            
            <!-- Plan List -->
            <MudPaper Elevation="0" Style="background: #2d2d2d; border-radius: 4px; overflow: hidden;">
                @if (_savedPlans?.Any() != true)
                {
                    <div style="padding: 24px; text-align: center;">
                        <MudText Typo="Typo.body2" Style="color: #666;">
                            No saved plans found
                        </MudText>
                    </div>
                }
                else
                {
                    <MudList T="StoredPlanSummary" Dense="true" Style="padding: 0;">
                        @foreach (var plan in _savedPlans.OrderByDescending(p => p.ModifiedAt))
                        {
                            var isSelected = _selectedPlan?.Id == plan.Id;
                            <MudListItem T="StoredPlanSummary" 
                                         Style="@GetItemStyle(isSelected)"
                                         OnClick="() => SelectPlan(plan)">
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px;">
                                    <div style="display: flex; flex-direction: column; gap: 2px;">
                                        <MudText Typo="Typo.body1" 
                                                 Style="@GetNameStyle(isSelected)">
                                            @plan.Name
                                            @if (plan.Id == AppState.CurrentPlanId)
                                            {
                                                <span style="color: #4caf50; font-size: 11px; margin-left: 8px;">(current)</span>
                                            }
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #888;">
                                            @plan.ItemCount items Â· @plan.DataCenter
                                        </MudText>
                                    </div>
                                    <MudText Typo="Typo.caption" Style="color: #666; font-size: 11px;">
                                        @plan.ModifiedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                                    </MudText>
                                </div>
                            </MudListItem>
                        }
                    </MudList>
                }
            </MudPaper>
        </div>
    </DialogContent>
    <DialogActions>
        <div style="display: flex; gap: 8px; width: 100%; padding: 8px 16px;">
            <!-- Save: Enabled when there are items to save -->
            <MudButton OnClick="OnSaveCurrentPlan"
                       Color="Color.Success"
                       Variant="Variant.Outlined"
                       Size="Size.Small"
                       Disabled="@(!AppState.ProjectItems.Any())"
                       StartIcon="@Icons.Material.Filled.Save"
                       title="Save current plan">
                @(AppState.CurrentPlanId != null ? "Save" : "Save As")
            </MudButton>
            <!-- Rename/Delete: Enabled when a plan is selected -->
            <MudButton OnClick="OnRenamePlan"
                       Color="Color.Secondary"
                       Variant="Variant.Outlined"
                       Size="Size.Small"
                       Disabled="@(_selectedPlan == null)"
                       StartIcon="@Icons.Material.Filled.Edit">
                Rename
            </MudButton>
            <MudButton OnClick="OnDeletePlan"
                       Color="Color.Error"
                       Variant="Variant.Outlined"
                       Size="Size.Small"
                       Disabled="@(_selectedPlan == null)"
                       StartIcon="@Icons.Material.Filled.Delete">
                Delete
            </MudButton>
            <MudSpacer />
            <MudButton OnClick="Close"
                       Color="Color.Secondary"
                       Variant="Variant.Text"
                       Size="Size.Small">
                Cancel
            </MudButton>
            <MudButton OnClick="OnLoadPlan"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       Size="Size.Small"
                       Disabled="@(_selectedPlan == null)"
                       StartIcon="@Icons.Material.Filled.FolderOpen">
                Load
            </MudButton>
        </div>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    
    private List<StoredPlanSummary> _savedPlans = new();
    private StoredPlanSummary? _selectedPlan;
    
    protected override async Task OnInitializedAsync()
    {
        await RefreshSavedPlansListAsync();
    }
    
    private async Task RefreshSavedPlansListAsync()
    {
        try
        {
            var plans = await IndexedDb.LoadAllPlansAsync();
            _savedPlans = plans
                .Where(p => p.Id != "autosave")
                .Select(p => new StoredPlanSummary
                {
                    Id = p.Id,
                    Name = p.Name,
                    ModifiedAt = p.ModifiedAt,
                    SavedAt = p.SavedAt,
                    DataCenter = p.DataCenter,
                    ItemCount = p.ProjectItems.Count
                })
                .ToList();
            
            // Clear selection if plan no longer exists
            if (_selectedPlan != null && !_savedPlans.Any(p => p.Id == _selectedPlan.Id))
            {
                _selectedPlan = null;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load saved plans: {ex.Message}", Severity.Error);
        }
    }
    
    private void SelectPlan(StoredPlanSummary plan)
    {
        _selectedPlan = plan;
    }
    
    private string GetItemStyle(bool isSelected)
    {
        if (isSelected)
            return "background: #3d3d3d; cursor: pointer;";
        return "cursor: pointer;";
    }
    
    private string GetNameStyle(bool isSelected)
    {
        if (isSelected)
            return "color: #d4a73a; font-weight: 600;";
        return "color: #fff; font-weight: 500;";
    }

    private async Task OnSaveCurrentPlan()
    {
        if (!AppState.ProjectItems.Any())
        {
            Snackbar.Add("No items to save", Severity.Warning);
            return;
        }

        try
        {
            // Check if there's a current plan to potentially overwrite
            StoredPlanSummary? currentPlan = null;
            if (AppState.CurrentPlanId != null)
            {
                currentPlan = _savedPlans.FirstOrDefault(p => p.Id == AppState.CurrentPlanId);
            }

            // If there's a selected plan that's not the current one, ask if user wants to overwrite it
            // or save as current/new
            if (_selectedPlan != null && _selectedPlan.Id != AppState.CurrentPlanId)
            {
                var confirm = await DialogService.ShowMessageBox(
                    "Save Plan",
                    $"Overwrite '{_selectedPlan.Name}' or save as '{currentPlan?.Name ?? "current plan"}'?",
                    yesText: $"Overwrite '{_selectedPlan.Name}'",
                    noText: $"Save '{currentPlan?.Name ?? "current"}'",
                    cancelText: "Save As New");

                if (confirm == true)
                {
                    // Overwrite the selected plan
                    await SavePlanToIdAsync(_selectedPlan.Id, _selectedPlan.Name);
                    return;
                }
                else if (confirm == false && currentPlan != null)
                {
                    // Save to current plan
                    await SavePlanToIdAsync(currentPlan.Id, currentPlan.Name);
                    return;
                }
                // else: fall through to Save As New
            }
            else if (currentPlan != null)
            {
                // Current plan is selected or no selection - just update it
                await SavePlanToIdAsync(currentPlan.Id, currentPlan.Name);
                return;
            }

            // No current plan or user chose "Save As New" - show save dialog
            var dialog = await DialogService.ShowAsync<SavePlanDialog>("Save Plan");
            var result = await dialog.Result;

            if (result?.Data is string newName && !string.IsNullOrWhiteSpace(newName))
            {
                await SavePlanToIdAsync(Guid.NewGuid().ToString(), newName);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Save failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task SavePlanToIdAsync(string planId, string planName)
    {
        try
        {
            // Load existing plan to preserve any extra data
            var existingPlan = await IndexedDb.LoadPlanAsync(planId);

            var planData = new StoredPlan
            {
                Id = planId,
                Name = planName,
                DataCenter = AppState.SelectedDataCenter,
                ModifiedAt = DateTime.UtcNow,
                SavedAt = existingPlan?.SavedAt ?? DateTime.UtcNow,
                ProjectItems = AppState.ProjectItems.Select(p => new StoredProjectItem
                {
                    Id = p.Id,
                    Name = p.Name,
                    IconId = p.IconId,
                    Quantity = p.Quantity,
                    MustBeHq = p.MustBeHq
                }).ToList(),
                PlanJson = AppState.CurrentPlan != null
                    ? System.Text.Json.JsonSerializer.Serialize(AppState.CurrentPlan)
                    : existingPlan?.PlanJson,
                MarketPlansJson = existingPlan?.MarketPlansJson,
                SavedRecommendationMode = existingPlan?.SavedRecommendationMode ?? RecommendationMode.MinimizeTotalCost
            };

            var success = await IndexedDb.SavePlanAsync(planData);
            if (success)
            {
                var action = AppState.CurrentPlanId == planId ? "Updated" : "Saved";
                Snackbar.Add($"{action} '{planName}'", Severity.Success);

                // Update current plan tracking
                AppState.CurrentPlanId = planId;
                AppState.CurrentPlanName = planName;

                await RefreshSavedPlansListAsync();

                // Select the saved plan
                _selectedPlan = _savedPlans.FirstOrDefault(p => p.Id == planId);
            }
            else
            {
                Snackbar.Add("Failed to save plan", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Save failed: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task OnRenamePlan()
    {
        if (_selectedPlan == null) return;
        
        var parameters = new DialogParameters
        {
            ["CurrentName"] = _selectedPlan.Name
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<RenamePlanDialog>("Rename Plan", parameters, options);
        var result = await dialog.Result;
        
        if (result?.Data is string newName && !string.IsNullOrWhiteSpace(newName) && newName != _selectedPlan.Name)
        {
            try
            {
                // Load, rename, and save
                var plan = await IndexedDb.LoadPlanAsync(_selectedPlan.Id);
                if (plan == null)
                {
                    Snackbar.Add("Plan not found", Severity.Error);
                    return;
                }
                
                var oldName = plan.Name;
                plan.Name = newName;
                plan.ModifiedAt = DateTime.UtcNow;
                
                var success = await IndexedDb.SavePlanAsync(plan);
                if (success)
                {
                    Snackbar.Add($"Renamed '{oldName}' to '{newName}'", Severity.Success);
                    
                    // Update current plan name if this is the current plan
                    if (_selectedPlan.Id == AppState.CurrentPlanId)
                    {
                        AppState.CurrentPlanName = newName;
                    }
                    
                    await RefreshSavedPlansListAsync();
                    
                    // Re-select the renamed plan
                    _selectedPlan = _savedPlans.FirstOrDefault(p => p.Id == _selectedPlan.Id);
                }
                else
                {
                    Snackbar.Add("Failed to rename plan", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Rename failed: {ex.Message}", Severity.Error);
            }
        }
    }
    
    private async Task OnDeletePlan()
    {
        if (_selectedPlan == null) return;
        
        // Check if deleting current plan
        var isCurrentPlan = _selectedPlan.Id == AppState.CurrentPlanId;
        var message = isCurrentPlan 
            ? $"'{_selectedPlan.Name}' is your current plan. Deleting it will not affect your current work, but you won't be able to overwrite it anymore. Continue?"
            : $"Are you sure you want to delete '{_selectedPlan.Name}'?";
        
        var confirm = await DialogService.ShowMessageBox(
            "Delete Plan",
            message,
            yesText: "Delete",
            cancelText: "Cancel");
        
        if (confirm == true)
        {
            try
            {
                var success = await IndexedDb.DeletePlanAsync(_selectedPlan.Id);
                if (success)
                {
                    Snackbar.Add($"Deleted '{_selectedPlan.Name}'", Severity.Success);
                    
                    // If we deleted the current plan, clear the tracking
                    if (isCurrentPlan)
                    {
                        AppState.ClearCurrentPlanId();
                    }
                    
                    _selectedPlan = null;
                    await RefreshSavedPlansListAsync();
                }
                else
                {
                    Snackbar.Add("Failed to delete plan", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Delete failed: {ex.Message}", Severity.Error);
            }
        }
    }
    
    private async Task OnLoadPlan()
    {
        if (_selectedPlan == null) return;
        
        try
        {
            var storedPlan = await IndexedDb.LoadPlanAsync(_selectedPlan.Id);
            if (storedPlan == null)
            {
                Snackbar.Add("Plan not found", Severity.Error);
                return;
            }
            
            CraftingPlan? plan = null;
            if (!string.IsNullOrEmpty(storedPlan.PlanJson))
            {
                try
                {
                    plan = System.Text.Json.JsonSerializer.Deserialize<CraftingPlan>(storedPlan.PlanJson);
                }
                catch { /* Plan JSON may be incompatible, that's ok */ }
            }
            
            AppState.LoadStoredPlan(storedPlan, plan);
            Snackbar.Add($"Loaded '{storedPlan.Name}'", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load plan: {ex.Message}", Severity.Error);
        }
    }
    
    private void Close()
    {
        MudDialog.Close();
    }
}
