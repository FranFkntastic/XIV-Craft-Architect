@using FFXIVCraftArchitect.Core.Services
@inject GarlandService GarlandService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" @bind-ActivePanelIndex="_activeTab">
            <MudTabPanel Text="Teamcraft Text">
                <MudText Typo="Typo.body2" Class="mb-4">
                    Paste a Teamcraft list (format: "Item Name xQuantity" or "Item Name x Quantity", one per line)
                </MudText>
                <MudTextField @bind-Value="_teamcraftText"
                              Label="Teamcraft List"
                              Variant="Variant.Outlined"
                              Lines="10"
                              Placeholder="Rarefied Cedar Lumber x5&#10;Cedar Lumber x10&#10;..." />
            </MudTabPanel>
            
            <MudTabPanel Text="Artisan JSON">
                <MudText Typo="Typo.body2" Class="mb-4">
                    Paste an Artisan crafting list JSON export
                </MudText>
                <MudTextField @bind-Value="_artisanJson"
                              Label="Artisan JSON"
                              Variant="Variant.Outlined"
                              Lines="10"
                              Placeholder="Paste JSON here..." />
            </MudTabPanel>
        </MudTabs>
        
        @if (_isProcessing)
        {
            <MudProgressLinear Indeterminate="true" Class="mt-4" />
            <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-2 d-block">
                @_processingMessage
            </MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   OnClick="Import" 
                   Disabled="_isProcessing || (string.IsNullOrWhiteSpace(_teamcraftText) && string.IsNullOrWhiteSpace(_artisanJson))">
            Import
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public int ActiveTab { get; set; } = 0;
    
    private int _activeTab = 0;
    private string _teamcraftText = "";
    private string _artisanJson = "";
    private bool _isProcessing = false;
    private string _processingMessage = "";
    
    protected override void OnInitialized()
    {
        _activeTab = ActiveTab;
    }
    
    private async Task Import()
    {
        _isProcessing = true;
        StateHasChanged();
        
        try
        {
            var items = new List<ImportItem>();
            
            if (!string.IsNullOrWhiteSpace(_teamcraftText))
            {
                items = await ImportTeamcraftAsync();
            }
            else if (!string.IsNullOrWhiteSpace(_artisanJson))
            {
                items = await ImportArtisanAsync();
            }
            
            if (items.Count > 0)
            {
                MudDialog.Close(DialogResult.Ok(items));
            }
            else
            {
                Snackbar.Add("No valid items found to import", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Import failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }
    
    private async Task<List<ImportItem>> ImportTeamcraftAsync()
    {
        var items = new List<ImportItem>();
        var lines = _teamcraftText.Split('\n', StringSplitOptions.RemoveEmptyEntries);
        
        foreach (var line in lines)
        {
            var trimmed = line.Trim();
            if (string.IsNullOrWhiteSpace(trimmed)) continue;
            
            // Parse format: "Item Name x5" or "Item Name x 5" or "Item Name 5"
            var (name, quantity) = ParseTeamcraftLine(trimmed);
            
            if (!string.IsNullOrWhiteSpace(name) && quantity > 0)
            {
                // Search for item
                try
                {
                    _processingMessage = $"Searching: {name}...";
                    StateHasChanged();
                    
                    var results = await GarlandService.SearchAsync(name);
                    var match = results.FirstOrDefault(r => 
                        r.Object.Name.Equals(name, StringComparison.OrdinalIgnoreCase));
                    
                    if (match != null)
                    {
                        items.Add(new ImportItem
                        {
                            Id = match.Id,
                            Name = match.Object.Name,
                            IconId = match.Object.IconId,
                            Quantity = quantity
                        });
                    }
                }
                catch { /* Skip items that fail to resolve */ }
            }
        }
        
        return items;
    }
    
    private static (string name, int quantity) ParseTeamcraftLine(string line)
    {
        // Try to find quantity at the end
        // Patterns: "Name x5", "Name x 5", "Name 5"
        var parts = line.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        
        if (parts.Length >= 2)
        {
            // Check last part for number
            if (int.TryParse(parts[^1], out var qty))
            {
                return (string.Join(' ', parts[..^1]), qty);
            }
            
            // Check for "x5" format
            var lastPart = parts[^1];
            if (lastPart.StartsWith('x') || lastPart.StartsWith('X'))
            {
                if (int.TryParse(lastPart[1..], out var xQty))
                {
                    return (string.Join(' ', parts[..^1]), xQty);
                }
            }
            
            // Check for "x 5" format (two parts)
            if (parts.Length >= 3 && 
                (parts[^2].Equals("x", StringComparison.OrdinalIgnoreCase) ||
                 parts[^2].Equals("Ã—", StringComparison.OrdinalIgnoreCase)))
            {
                if (int.TryParse(parts[^1], out var xSpaceQty))
                {
                    return (string.Join(' ', parts[..^2]), xSpaceQty);
                }
            }
        }
        
        // Default: whole line as name, quantity 1
        return (line, 1);
    }
    
    private async Task<List<ImportItem>> ImportArtisanAsync()
    {
        var items = new List<ImportItem>();
        
        try
        {
            using var doc = System.Text.Json.JsonDocument.Parse(_artisanJson);
            var root = doc.RootElement;
            
            // Artisan format has items array with itemId
            if (root.TryGetProperty("items", out var itemsArray))
            {
                foreach (var item in itemsArray.EnumerateArray())
                {
                    if (item.TryGetProperty("itemId", out var itemIdElement))
                    {
                        var itemId = itemIdElement.GetInt32();
                        var quantity = 1;
                        
                        if (item.TryGetProperty("quantity", out var qtyElement))
                        {
                            quantity = qtyElement.GetInt32();
                        }
                        
                        // Look up item name from Garland
                        try
                        {
                            _processingMessage = $"Resolving item {itemId}...";
                            StateHasChanged();
                            
                            var results = await GarlandService.SearchAsync(itemId.ToString());
                            var match = results.FirstOrDefault(r => r.Id == itemId);
                            
                            if (match != null)
                            {
                                items.Add(new ImportItem
                                {
                                    Id = itemId,
                                    Name = match.Object.Name,
                                    IconId = match.Object.IconId,
                                    Quantity = quantity
                                });
                            }
                        }
                        catch { /* Skip items that fail to resolve */ }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            throw new Exception("Invalid JSON format: " + ex.Message);
        }
        
        return items;
    }
    
    private void Cancel()
    {
        MudDialog.Cancel();
    }
    
    public class ImportItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public int IconId { get; set; }
        public int Quantity { get; set; }
    }
}
