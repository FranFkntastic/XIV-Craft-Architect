@using FFXIVCraftArchitect.Web.Services
@inject AppState AppState
@inject IndexedDbService IndexedDb
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
            <MudTabPanel Text="General">
                <MudSwitch @bind-Value="_autoSaveEnabled" 
                           Label="Auto-save plans" 
                           Color="Color.Primary"
                           Class="my-2" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Automatically save your work every 30 seconds
                </MudText>
                
                <MudDivider Class="my-4" />
                
                <MudSelect @bind-Value="_defaultDataCenter" 
                           Label="Default Data Center"
                           Variant="Variant.Outlined"
                           Class="my-2">
                    <MudSelectItem Value="@("Aether")">Aether</MudSelectItem>
                    <MudSelectItem Value="@("Primal")">Primal</MudSelectItem>
                    <MudSelectItem Value="@("Crystal")">Crystal</MudSelectItem>
                    <MudSelectItem Value="@("Dynamis")">Dynamis</MudSelectItem>
                </MudSelect>
            </MudTabPanel>
            
            <MudTabPanel Text="Storage">
                <MudText Typo="Typo.body2" Class="mb-4">
                    Manage your saved plans and application data.
                </MudText>
                
                <MudButton Color="Color.Error" 
                           Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.DeleteSweep"
                           OnClick="ClearAllPlans"
                           Disabled="_isClearing">
                    @if (_isClearing)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Delete All Saved Plans
                </MudButton>
                
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2 d-block">
                    This will permanently delete all your saved plans. This action cannot be undone.
                </MudText>
            </MudTabPanel>
            
            <MudTabPanel Text="About">
                <div class="d-flex flex-column align-center py-4">
                    <MudText Typo="Typo.h5" Class="mb-2">FFXIV Craft Architect</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        Web Companion v0.2.0
                    </MudText>
                    
                    <MudText Typo="Typo.body2" Align="Align.Center">
                        A crafting calculator for Final Fantasy XIV with market integration.
                    </MudText>
                    
                    <MudDivider Class="my-4" Style="width: 100%" />
                    
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Data sources: Garland Tools, Universalis, XIVAPI
                    </MudText>
                </div>
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Save">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    
    private bool _autoSaveEnabled = true;
    private string _defaultDataCenter = "Aether";
    private bool _isClearing = false;
    
    protected override void OnInitialized()
    {
        _autoSaveEnabled = AppState.IsAutoSaveEnabled;
        _defaultDataCenter = AppState.SelectedDataCenter;
    }
    
    private async Task ClearAllPlans()
    {
        _isClearing = true;
        StateHasChanged();
        
        try
        {
            var result = await IndexedDb.ClearAllPlansAsync();
            if (result)
            {
                Snackbar.Add("All plans deleted", Severity.Success);
                AppState.SavedPlans.Clear();
                AppState.NotifySavedPlansChanged();
            }
            else
            {
                Snackbar.Add("Failed to delete plans", Severity.Error);
            }
        }
        finally
        {
            _isClearing = false;
        }
    }
    
    private void Save()
    {
        AppState.IsAutoSaveEnabled = _autoSaveEnabled;
        AppState.SelectedDataCenter = _defaultDataCenter;
        
        // Persist settings
        _ = IndexedDb.SaveSettingAsync("autoSave", _autoSaveEnabled);
        _ = IndexedDb.SaveSettingAsync("defaultDataCenter", _defaultDataCenter);
        
        Snackbar.Add("Settings saved", Severity.Success);
        MudDialog.Close(DialogResult.Ok(true));
    }
    
    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
