@using FFXIVCraftArchitect.Web.Services
@using FFXIVCraftArchitect.Core.Services.Interfaces
@inject AppState AppState
@inject ISettingsService Settings
@inject IndexedDbService IndexedDb
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
            <MudTabPanel Text="General">
                <MudSwitch @bind-Value="_autoSaveEnabled" 
                           Label="Auto-save plans" 
                           Color="Color.Primary"
                           Class="my-2" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Automatically save your work every 30 seconds
                </MudText>
            </MudTabPanel>
            
            <MudTabPanel Text="Market">
                <MudText Typo="Typo.body2" Class="mb-4" Color="Color.Secondary">
                    Configure your default market settings for price lookups.
                </MudText>
                
                <!-- Region Selection -->
                <MudSelect @bind-Value="_selectedRegion" 
                           Label="Region"
                           Variant="Variant.Outlined"
                           Class="my-3"
                           AdornmentIcon="@Icons.Material.Filled.Language">
                    <MudSelectItem Value="@("North America")">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" />
                            North America
                        </div>
                    </MudSelectItem>
                    <MudSelectItem Value="@("Europe")">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" />
                            Europe
                        </div>
                    </MudSelectItem>
                    <MudSelectItem Value="@("Japan")">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" />
                            Japan
                        </div>
                    </MudSelectItem>
                    <MudSelectItem Value="@("Oceania")">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" />
                            Oceania
                        </div>
                    </MudSelectItem>
                </MudSelect>
                
                <!-- Data Center Selection -->
                <MudSelect @bind-Value="_defaultDataCenter" 
                           Label="Default Data Center"
                           Variant="Variant.Outlined"
                           Class="my-3"
                           AdornmentIcon="@Icons.Material.Filled.DataUsage">
                    @foreach (var dc in GetAvailableDataCenters())
                    {
                        <MudSelectItem Value="@dc">@dc</MudSelectItem>
                    }
                </MudSelect>
                
                <MudDivider Class="my-4" />
                
                <!-- Auto-fetch prices on rebuild -->
                <MudSwitch @bind-Value="_autoFetchPricesOnRebuild" 
                           Label="Auto-fetch prices on plan import/rebuild" 
                           Color="Color.Primary"
                           Class="my-2" />
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Automatically fetch market prices after importing or rebuilding a plan. Vendor prices are always fetched.
                </MudText>
                
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-4">
                    These settings determine which market board prices are shown by default.
                </MudText>
            </MudTabPanel>
            
            <MudTabPanel Text="Storage">
                <MudText Typo="Typo.body2" Class="mb-4">
                    Manage your saved plans and application data.
                </MudText>
                
                <MudButton Color="Color.Error" 
                           Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.DeleteSweep"
                           OnClick="ClearAllPlans"
                           Disabled="_isClearing">
                    @if (_isClearing)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Delete All Saved Plans
                </MudButton>
                
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2 d-block">
                    This will permanently delete all your saved plans. This action cannot be undone.
                </MudText>
            </MudTabPanel>
            
            <MudTabPanel Text="About">
                <div class="d-flex flex-column align-center py-4">
                    <MudText Typo="Typo.h5" Class="mb-2">FFXIV Craft Architect</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        Web Companion v0.2.0
                    </MudText>
                    
                    <MudText Typo="Typo.body2" Align="Align.Center">
                        A crafting calculator for Final Fantasy XIV with market integration.
                    </MudText>
                    
                    <MudDivider Class="my-4" Style="width: 100%" />
                    
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Data sources: Garland Tools, Universalis, XIVAPI
                    </MudText>
                </div>
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Save">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    
    private bool _autoSaveEnabled = true;
    private string _defaultDataCenter = "Aether";
    private string _selectedRegion = "North America";
    private bool _autoFetchPricesOnRebuild = true;
    private bool _isClearing = false;
    
    // Region to Data Centers mapping
    private static readonly Dictionary<string, List<string>> RegionToDataCenters = new()
    {
        ["North America"] = new() { "Aether", "Primal", "Crystal", "Dynamis" },
        ["Europe"] = new() { "Chaos", "Light" },
        ["Japan"] = new() { "Elemental", "Gaia", "Mana", "Meteor" },
        ["Oceania"] = new() { "Materia" }
    };
    
    protected override async Task OnInitializedAsync()
    {
        _autoSaveEnabled = await Settings.GetAsync("ui.auto_save_enabled", true);
        _defaultDataCenter = await Settings.GetAsync("market.default_datacenter", "Aether") ?? "Aether";
        _selectedRegion = await Settings.GetAsync("market.region", "North America") ?? "North America";
        _autoFetchPricesOnRebuild = await Settings.GetAsync("market.auto_fetch_prices", true);
        
        // Also sync to AppState for runtime use
        AppState.IsAutoSaveEnabled = _autoSaveEnabled;
        AppState.SelectedDataCenter = _defaultDataCenter;
        AppState.SelectedRegion = _selectedRegion;
        AppState.AutoFetchPricesOnRebuild = _autoFetchPricesOnRebuild;
    }
    
    private List<string> GetAvailableDataCenters()
    {
        return RegionToDataCenters.GetValueOrDefault(_selectedRegion, new List<string> { "Aether" });
    }
    
    private string GetRegionForDataCenter(string dataCenter)
    {
        foreach (var (region, dataCenters) in RegionToDataCenters)
        {
            if (dataCenters.Contains(dataCenter))
                return region;
        }
        return "North America";
    }
    
    private async Task ClearAllPlans()
    {
        _isClearing = true;
        StateHasChanged();
        
        try
        {
            var result = await IndexedDb.ClearAllPlansAsync();
            if (result)
            {
                Snackbar.Add("All plans deleted", Severity.Success);
                AppState.SavedPlans.Clear();
                AppState.NotifySavedPlansChanged();
            }
            else
            {
                Snackbar.Add("Failed to delete plans", Severity.Error);
            }
        }
        finally
        {
            _isClearing = false;
        }
    }
    
    private async Task Save()
    {
        // Update AppState for runtime use
        AppState.IsAutoSaveEnabled = _autoSaveEnabled;
        AppState.SelectedDataCenter = _defaultDataCenter;
        AppState.SelectedRegion = _selectedRegion;
        AppState.AutoFetchPricesOnRebuild = _autoFetchPricesOnRebuild;
        
        // Persist settings via ISettingsService
        await Settings.SetAsync("ui.auto_save_enabled", _autoSaveEnabled);
        await Settings.SetAsync("market.default_datacenter", _defaultDataCenter);
        await Settings.SetAsync("market.region", _selectedRegion);
        await Settings.SetAsync("market.auto_fetch_prices", _autoFetchPricesOnRebuild);
        
        Snackbar.Add("Settings saved", Severity.Success);
        MudDialog.Close(DialogResult.Ok(true));
    }
    
    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
