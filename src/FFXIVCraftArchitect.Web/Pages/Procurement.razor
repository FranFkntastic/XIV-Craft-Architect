@page "/procurement"
@using FFXIVCraftArchitect.Core.Models
@using FFXIVCraftArchitect.Core.Services
@using FFXIVCraftArchitect.Web.Services
@using FFXIVCraftArchitect.Web.Shared
@using Microsoft.AspNetCore.Components.Forms
@inject GarlandService GarlandService
@inject UniversalisService UniversalisService
@inject RecipeCalculationService RecipeCalculationService
@inject MarketShoppingService MarketShoppingService
@inject ProcurementAnalysisService ProcurementService
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@inject AppState AppState
@inject NavigationManager NavigationManager
@implements IDisposable

<style>
    .search-results-container .search-result-item:hover {
        background: linear-gradient(135deg, #3a3020 0%, #2d2520 100%) !important;
    }
    .search-results-container .mud-list-item {
        transition: background-color 0.2s ease;
    }
</style>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="pa-0" Style="height: calc(100vh - 64px - 28px);">
    <div style="display: grid; grid-template-columns: 280px 350px 1fr; height: 100%; width: 100%;">
        
        <!-- Left Column: Controls (280px) -->
        <div Class="pa-4" Style="border-right: 1px solid #444; overflow-y: auto; min-width: 280px; max-width: 280px;">
            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-4">Procurement Planner</MudText>
            
            @if (_isLoadingWorlds)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="my-4" />
                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">Loading worlds...</MudText>
            }
            else
            {
                <MudSelect T="string"
                           @bind-Value="AppState.SelectedDataCenter"
                           Label="Data Center"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Class="mb-3"
                           AdornmentColor="Color.Primary">
                    @foreach (var dc in _worldData?.DataCenters ?? new List<string>())
                    {
                        <MudSelectItem Value="@dc">@dc</MudSelectItem>
                    }
                </MudSelect>
                
                <MudSelect T="string"
                           @bind-Value="_selectedWorld"
                           Label="World"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Class="mb-3"
                           Disabled="string.IsNullOrEmpty(AppState.SelectedDataCenter)">
                    <MudSelectItem Value="@string.Empty">Any World</MudSelectItem>
                    @foreach (var world in GetWorldsForSelectedDc())
                    {
                        <MudSelectItem Value="@world">@world</MudSelectItem>
                    }
                </MudSelect>
                
                <MudSelect T="RecommendationMode"
                           @bind-Value="AppState.RecommendationMode"
                           Label="Mode"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Class="mb-4">
                    <MudSelectItem Value="@RecommendationMode.MinimizeTotalCost">Minimize Cost</MudSelectItem>
                    <MudSelectItem Value="@RecommendationMode.MaximizeValue">Maximize Value</MudSelectItem>
                    <MudSelectItem Value="@RecommendationMode.BestUnitPrice">Best Unit Price</MudSelectItem>
                </MudSelect>
            }
            
            <MudTextField @bind-Value="_searchQuery"
                          Label="Item Name"
                          Placeholder="Enter item..."
                          Variant="Variant.Outlined"
                          Dense="true"
                          Class="mb-2"
                          OnKeyDown="OnSearchKeyDown"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          AdornmentColor="Color.Primary"
                          OnAdornmentClick="SearchItemsAsync" />
            
            <MudButton OnClick="SearchItemsAsync"
                       Disabled="_isSearching"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       FullWidth="true"
                       Class="mb-4"
                       StartIcon="@Icons.Material.Filled.Search">
                @if (_isSearching)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Searching...</span>
                }
                else
                {
                    <span>Search</span>
                }
            </MudButton>
            
            @if (_searchResults.Any())
            {
                <MudPaper Elevation="4" 
                          Class="mt-2 search-results-container" 
                          Style="max-height: 300px; overflow-y: auto; border-radius: 8px; border: 1px solid #d4a73a; background: #2d2d2d; z-index: 100;">
                    <div class="px-3 py-2" Style="background: linear-gradient(135deg, #3a3020 0%, #2d2520 100%); border-bottom: 1px solid #d4a73a; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Small" Color="Color.Primary" />
                            <MudText Typo="Typo.body2" Style="color: #d4a73a; font-weight: 600;">Search Results</MudText>
                            <MudBadge Content="@_searchResults.Count" Color="Color.Primary" Style="margin-left: 4px;" />
                        </div>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                       Size="Size.Small" 
                                       Color="Color.Secondary"
                                       OnClick="() => _searchResults.Clear()"
                                       Style="padding: 4px;" />
                    </div>
                    <MudList T="GarlandSearchResult" Dense="true" Style="padding: 4px;">
                        @foreach (var result in _searchResults)
                        {
                            <MudListItem T="GarlandSearchResult" 
                                         OnClick="() => AddItemToList(result)"
                                         Style="border-radius: 6px; margin: 2px 4px; cursor: pointer;"
                                         Class="search-result-item">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <MudIcon Icon="@Icons.Material.Filled.AddCircle" 
                                             Size="Size.Small" 
                                             Color="Color.Primary"
                                             Style="opacity: 0.7;" />
                                    <div style="flex: 1; min-width: 0;">
                                        <MudText Typo="Typo.body2" Style="font-weight: 500; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@result.Object.Name</MudText>
                                        <MudText Typo="Typo.caption" Style="color: #888;">ID: @result.Id</MudText>
                                    </div>
                                </div>
                            </MudListItem>
                        }
                    </MudList>
                    <div class="px-3 py-2" Style="background: #252525; border-top: 1px solid #444; text-align: center;">
                        <MudText Typo="Typo.caption" Style="color: #888;">Click an item to add it to your list</MudText>
                    </div>
                </MudPaper>
            }

            @if (AppState.ShoppingItems.Any())
            {
                <MudDivider Class="my-4" />
                <MudButton OnClick="GoToPlanner"
                           Color="Color.Info"
                           Variant="Variant.Filled"
                           FullWidth="true"
                           EndIcon="@Icons.Material.Filled.ArrowForward">
                    Open in Recipe Planner
                </MudButton>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center" Class="mt-2 d-block">
                    @AppState.ShoppingItems.Count items ready
                </MudText>
            }
        </div>
        
        <!-- Middle Column: Shopping List (350px) -->
        <div Class="pa-4" Style="border-right: 1px solid #444; overflow-y: auto; min-width: 350px; max-width: 350px;">
            <MudPaper Elevation="2" Class="pa-0" Style="height: 100%; display: flex; flex-direction: column; border-radius: 12px; overflow: hidden;">
                <!-- Header -->
                <div class="px-4 py-3" Style="background: linear-gradient(135deg, #2d2d2d 0%, #252525 100%); border-bottom: 1px solid #444;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Primary" Size="Size.Small" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600; color: #d4a73a;">Shopping List</MudText>
                            @if (AppState.ShoppingItems.Any())
                            {
                                <MudBadge Content="@AppState.ShoppingItems.Count" Color="Color.Primary" Overlap="true" Origin="Origin.TopRight" 
                                          Style="margin-left: 4px;" />
                            }
                        </div>
                        <MudButtonGroup Size="Size.Small" Variant="Variant.Outlined" Color="Color.Secondary" Style="border-radius: 8px;">
                            <MudIconButton OnClick="ClearAllItems"
                                           Disabled="!AppState.ShoppingItems.Any()"
                                           Icon="@Icons.Material.Filled.DeleteSweep"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           Title="Clear All" />
                            <MudIconButton Component="label"
                                           For="import-file"
                                           Icon="@Icons.Material.Filled.Upload"
                                           Color="Color.Secondary"
                                           Size="Size.Small"
                                           Title="Import Plan" />
                            <InputFile id="import-file" OnChange="ImportPlanAsync" accept=".json" style="display: none;" />
                            <MudIconButton OnClick="ExportPlanAsync"
                                           Disabled="!AppState.ShoppingItems.Any()"
                                           Icon="@Icons.Material.Filled.Download"
                                           Color="Color.Secondary"
                                           Size="Size.Small"
                                           Title="Export Plan" />
                        </MudButtonGroup>
                    </div>
                </div>
                
                <div style="padding: 12px; flex: 1; overflow-y: auto;">
                    @if (!AppState.ShoppingItems.Any())
                    {
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 24px; text-align: center;">
                            <MudIcon Icon="@Icons.Material.Filled.ShoppingBasket" 
                                     Size="Size.Large" 
                                     Color="Color.Secondary" 
                                     Style="opacity: 0.5; margin-bottom: 12px;" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Your shopping list is empty
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Style="opacity: 0.7; margin-top: 4px;">
                                Search for items to add them here
                            </MudText>
                        </div>
                    }
                    else
                    {
                        <MudStack Spacing="2">
                            @foreach (var item in AppState.ShoppingItems)
                            {
                                <MudPaper Elevation="0" 
                                          Class="pa-3 d-flex align-center gap-3" 
                                          Style="background: #2a2a2a; border-radius: 8px; border: 1px solid #383838;">
                                    <MudText Typo="Typo.body2" Class="flex-grow-1" Style="font-weight: 500;">@item.Name</MudText>
                                    <MudNumericField @bind-Value="item.Quantity"
                                                     Min="1"
                                                     Max="9999"
                                                     Variant="Variant.Outlined"
                                                     Dense="true"
                                                     Style="width: 70px;"
                                                     Adornment="Adornment.End"
                                                     AdornmentText="x" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   OnClick="() => RemoveItem(item)"
                                                   Color="Color.Error"
                                                   Size="Size.Small"
                                                   Variant="Variant.Outlined" />
                                </MudPaper>
                            }
                        </MudStack>
                    }
                </div>
                
                <div class="pa-4" style="background: linear-gradient(180deg, #252525 0%, #2d2d2d 100%); border-top: 1px solid #444;">
                    <MudButton OnClick="AnalyzeMarketAsync"
                               Disabled="!AppState.ShoppingItems.Any() || _isAnalyzing || string.IsNullOrWhiteSpace(AppState.SelectedDataCenter)"
                               Color="Color.Primary"
                               Variant="Variant.Filled"
                               FullWidth="true"
                               Style="border-radius: 8px; height: 40px;"
                               StartIcon="@(_isAnalyzing ? "" : Icons.Material.Filled.Analytics)">
                        @if (_isAnalyzing)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Analyzing Market...</span>
                        }
                        else
                        {
                            <span>Analyze Market</span>
                        }
                    </MudButton>
                    @if (!string.IsNullOrWhiteSpace(AppState.SelectedDataCenter))
                    {
                        <MudText Typo="Typo.caption" 
                                 Color="Color.Secondary" 
                                 Align="Align.Center" 
                                 Class="d-block mt-2"
                                 Style="opacity: 0.7;">
                            Using @AppState.SelectedDataCenter data center
                        </MudText>
                    }
                </div>
            </MudPaper>
        </div>
        
        <!-- Right Column: Market Results (flex: 1) -->
        <div Class="pa-4" Style="overflow: hidden; min-width: 0;">
            <!-- View Toggle -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <MudButtonGroup Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                    <MudButton OnClick="() => _showProcurementResults = true"
                               Variant="@(_showProcurementResults ? Variant.Filled : Variant.Outlined)">
                        <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Small" Class="mr-1" />
                        Procurement Plan
                    </MudButton>
                    <MudButton OnClick="() => _showProcurementResults = false"
                               Variant="@(!_showProcurementResults ? Variant.Filled : Variant.Outlined)">
                        <MudIcon Icon="@Icons.Material.Filled.Analytics" Size="Size.Small" Class="mr-1" />
                        Market Analysis
                    </MudButton>
                </MudButtonGroup>
                
                @if (!_showProcurementResults)
                {
                    <MudCheckBox T="bool"
                                Value="ShowAnalysisSections"
                                ValueChanged="v => ShowAnalysisSections = v"
                                Dense="true"
                                Size="Size.Small"
                                Style="color: #888;">
                        Show Analysis Sections
                    </MudCheckBox>
                }
            </div>
            
            @if (_showProcurementResults)
            {
                <ProcurementResultsPanel Analysis="AppState.CurrentProcurementAnalysis" />
            }
            else
            {
                <MarketLogisticsPanel ShoppingPlans="AppState.ShoppingPlans"
                                      CraftAnalyses="AppState.CraftAnalyses"
                                      InitialMode="AppState.RecommendationMode"
                                      OnModeChanged="OnRecommendationModeChanged"
                                      ShowAnalysisSections="ShowAnalysisSections" />
            }
        </div>
    </div>
</MudContainer>

@code {
    private WorldData? _worldData;
    private bool _isLoadingWorlds = true;
    private string _selectedWorld = string.Empty;

    private string _searchQuery = string.Empty;
    private bool _isSearching = false;
    private List<GarlandSearchResult> _searchResults = new();
    
    private bool _isAnalyzing = false;
    private bool _showProcurementResults = true;
    private bool ShowAnalysisSections { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _worldData = await UniversalisService.GetWorldDataAsync();
            _isLoadingWorlds = false;
            
            if (string.IsNullOrEmpty(AppState.SelectedDataCenter))
            {
                AppState.SelectedDataCenter = _worldData.DataCenters.FirstOrDefault() ?? "Aether";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Index.razor: ERROR - {ex}");
            
            _worldData = new WorldData
            {
                DataCenterToWorlds = new Dictionary<string, List<string>>
                {
                    ["Aether"] = new() { "Adamantoise", "Cactuar", "Faerie", "Gilgamesh", "Jenova", "Midgardsormr", "Sargatanas", "Siren" },
                    ["Primal"] = new() { "Behemoth", "Excalibur", "Exodus", "Famfrit", "Hyperion", "Lamia", "Leviathan", "Ultros" },
                    ["Crystal"] = new() { "Balmung", "Brynhildr", "Coeurl", "Diabolos", "Goblin", "Malboro", "Mateus", "Zalera" },
                    ["Dynamis"] = new() { "Cuchulainn", "Golem", "Halicarnassus", "Kraken", "Maduin", "Marilith", "Rafflesia", "Seraph" }
                }
            };
            AppState.SelectedDataCenter = "Aether";
            _isLoadingWorlds = false;
            
            Snackbar.Add($"Using fallback world data. API error: {ex.Message}", Severity.Warning);
        }

        AppState.OnShoppingListChanged += OnShoppingListChanged;
        AppState.OnProcurementAnalysisChanged += OnProcurementAnalysisChanged;
        
        // Auto-run analysis if we have a plan but no analysis yet
        if (AppState.CurrentPlan != null && AppState.CurrentProcurementAnalysis == null)
        {
            _ = Task.Run(async () => await RunProcurementAnalysisAsync());
        }
        // Or auto-run market analysis if we have shopping items but no shopping plans
        else if (AppState.ShoppingItems.Any() && !AppState.ShoppingPlans.Any())
        {
            _ = Task.Run(async () => await AnalyzeMarketAsync());
        }
    }

    private void OnShoppingListChanged()
    {
        InvokeAsync(StateHasChanged);
    }
    
    private void OnProcurementAnalysisChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AppState.OnShoppingListChanged -= OnShoppingListChanged;
        AppState.OnProcurementAnalysisChanged -= OnProcurementAnalysisChanged;
    }

    private List<string> GetWorldsForSelectedDc()
    {
        if (_worldData?.DataCenterToWorlds == null || string.IsNullOrEmpty(AppState.SelectedDataCenter))
            return new List<string>();
        
        return _worldData.DataCenterToWorlds.TryGetValue(AppState.SelectedDataCenter, out var worlds) 
            ? worlds.OrderBy(w => w).ToList() 
            : new List<string>();
    }

    private async Task SearchItemsAsync()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
            return;

        _isSearching = true;
        _searchResults.Clear();
        await InvokeAsync(StateHasChanged); // Force UI update to show loading state
        
        AppState.BeginOperation("Searching", $"Searching for '{_searchQuery}'...");
        
        try
        {
            var results = await GarlandService.SearchAsync(_searchQuery);
            _searchResults = results.Take(10).ToList();
            AppState.EndOperation($"Found {_searchResults.Count} results for '{_searchQuery}'");
            await InvokeAsync(StateHasChanged); // Force UI update to show results
        }
        catch (Exception ex)
        {
            AppState.SetStatus($"Search failed: {ex.Message}");
            Snackbar.Add($"Search failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSearching = false;
            await InvokeAsync(StateHasChanged); // Ensure UI is updated
        }
    }

    private async Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchItemsAsync();
        }
    }

    private void AddItemToList(GarlandSearchResult result)
    {
        var existing = AppState.ShoppingItems.FirstOrDefault(i => i.Id == result.Id);
        if (existing != null)
        {
            existing.Quantity++;
            AppState.SetStatus($"Increased {result.Object.Name} quantity to {existing.Quantity}");
        }
        else
        {
            AppState.ShoppingItems.Add(new MarketShoppingItem
            {
                Id = result.Id,
                Name = result.Object.Name,
                IconId = result.Object.IconId,
                Quantity = 1
            });
            AppState.SetStatus($"Added {result.Object.Name} to shopping list");
        }
        
        _searchResults.Clear();
        _searchQuery = string.Empty;
        AppState.ShoppingPlans.Clear();
        AppState.NotifyShoppingListChanged();
    }

    private void RemoveItem(MarketShoppingItem item)
    {
        AppState.ShoppingItems.Remove(item);
        AppState.ShoppingPlans.Clear();
        AppState.SetStatus($"Removed {item.Name} from shopping list");
        AppState.NotifyShoppingListChanged();
    }

    private void ClearAllItems()
    {
        var count = AppState.ShoppingItems.Count;
        AppState.ShoppingItems.Clear();
        AppState.ShoppingPlans.Clear();
        AppState.SetStatus($"Cleared {count} items from shopping list");
        AppState.NotifyShoppingListChanged();
    }
    
    private async Task RunProcurementAnalysisAsync()
    {
        if (AppState.CurrentPlan == null || string.IsNullOrWhiteSpace(AppState.SelectedDataCenter))
            return;

        _isAnalyzing = true;
        AppState.BeginOperation("Procurement Analysis", "Analyzing optimal acquisition strategy...");

        try
        {
            var progress = new Progress<string>(msg => AppState.SetStatus(msg, busy: true));
            
            AppState.CurrentProcurementAnalysis = await ProcurementService.AnalyzePlanAsync(
                AppState.CurrentPlan,
                AppState.SelectedDataCenter,
                AppState.RecommendationMode,
                progress);
            
            AppState.NotifyProcurementAnalysisChanged();
            
            var analysis = AppState.CurrentProcurementAnalysis;
            AppState.EndOperation($"Analysis complete! {analysis.ItemsToCraft} to craft, {analysis.ItemsToBuy} to buy");
            Snackbar.Add($"Procurement analysis complete. Total cost: {analysis.OptimalTotalCost:N0}g", Severity.Success);
        }
        catch (Exception ex)
        {
            AppState.EndOperation($"Analysis failed: {ex.Message}");
            Snackbar.Add($"Procurement analysis failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isAnalyzing = false;
        }
    }

    private async Task AnalyzeMarketAsync()
    {
        if (!AppState.ShoppingItems.Any() || string.IsNullOrWhiteSpace(AppState.SelectedDataCenter))
            return;

        _isAnalyzing = true;
        AppState.ShoppingPlans.Clear();
        AppState.BeginOperation("Market Analysis", $"Analyzing {AppState.ShoppingItems.Count} items on {AppState.SelectedDataCenter}...");

        try
        {
            var materials = AppState.ShoppingItems.Select(i => new MaterialAggregate
            {
                ItemId = i.Id,
                Name = i.Name,
                IconId = i.IconId,
                TotalQuantity = i.Quantity
            }).ToList();

            var progress = new Progress<string>(msg => { });
            
            AppState.ShoppingPlans = await MarketShoppingService.CalculateDetailedShoppingPlansAsync(
                materials,
                AppState.SelectedDataCenter,
                progress,
                mode: AppState.RecommendationMode);
                
            AppState.NotifyShoppingListChanged();
            
            var bestValue = AppState.ShoppingPlans.Sum(p => p.RecommendedWorld?.TotalCost ?? 0);
            AppState.EndOperation($"Analysis complete! Potential savings found.");
            Snackbar.Add($"Analysis complete. Found deals for {AppState.ShoppingPlans.Count} items.", Severity.Success);
        }
        catch (Exception ex)
        {
            AppState.SetStatus($"Analysis failed: {ex.Message}");
            Snackbar.Add($"Market analysis failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isAnalyzing = false;
        }
    }

    private void OnRecommendationModeChanged(RecommendationMode mode)
    {
        AppState.RecommendationMode = mode;
        if (AppState.ShoppingItems.Any())
        {
            _ = AnalyzeMarketAsync();
        }
    }

    private async Task ImportPlanAsync(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024);
            using var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();
            var plan = RecipeCalculationService.DeserializePlan(json);
            
            if (plan == null)
            {
                Snackbar.Add("Failed to import plan. Invalid format.", Severity.Error);
                return;
            }

            AppState.ShoppingItems.Clear();
            foreach (var node in plan.RootItems)
            {
                AppState.ShoppingItems.Add(new MarketShoppingItem
                {
                    Id = node.ItemId,
                    Name = node.Name,
                    IconId = node.IconId,
                    Quantity = node.Quantity
                });
            }

            AppState.SelectedDataCenter = plan.DataCenter;
            AppState.NotifyShoppingListChanged();
            
            Snackbar.Add($"Imported plan: {plan.Name} ({AppState.ShoppingItems.Count} items)", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Import failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportPlanAsync()
    {
        try
        {
            var targetItems = AppState.ShoppingItems.Select(i => (i.Id, i.Name, i.Quantity, false)).ToList();
            var plan = await RecipeCalculationService.BuildPlanAsync(
                targetItems, 
                AppState.SelectedDataCenter, 
                string.Empty);

            plan.Name = $"WebPlan_{DateTime.Now:yyyyMMdd_HHmmss}";
            var json = RecipeCalculationService.SerializePlan(plan);
            
            var bytes = System.Text.Encoding.UTF8.GetBytes(json);
            var stream = new MemoryStream(bytes);
            
            using var streamRef = new DotNetStreamReference(stream);
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", $"{plan.Name}.json", streamRef);
            
            Snackbar.Add("Plan exported successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
    }

    private void GoToPlanner()
    {
        AppState.SyncShoppingToProject();
        NavigationManager.NavigateTo("/");
    }
}
