@page "/"
@using FFXIVCraftArchitect.Core.Models
@using FFXIVCraftArchitect.Core.Services
@using FFXIVCraftArchitect.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@inject GarlandService GarlandService
@inject UniversalisService UniversalisService
@inject RecipeCalculationService RecipeCalculationService
@inject MarketShoppingService MarketShoppingService
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@inject AppState AppState
@inject NavigationManager NavigationManager
@implements IDisposable

<!-- 3-Column Layout matching WPF -->
<div style="display: grid; grid-template-columns: 280px 350px 1fr; gap: 0; height: calc(100vh - 64px);">
    
    <!-- Left Column: Controls -->
    <div style="padding: 16px; overflow-y: auto; border-right: 1px solid #333;">
        <div style="font-size: 16px; font-weight: 600; color: #d4a73a; margin-bottom: 16px;">Market Logistics</div>
        
        <div style="color: #cccccc; font-size: 14px; margin: 20px 0 4px 0;">Data Center:</div>
        @if (_isLoadingWorlds)
        {
            <div style="color: #888;">Loading worlds...</div>
        }
        else
        {
            <select @bind="AppState.SelectedDataCenter" 
                    style="width: 100%; padding: 8px; background: #2d2d2d; color: white; border: 1px solid #444; border-radius: 4px;">
                @foreach (var dc in _worldData?.DataCenters ?? new List<string>())
                {
                    <option value="@dc">@dc</option>
                }
            </select>
            
            <div style="color: #cccccc; font-size: 14px; margin: 16px 0 4px 0;">World:</div>
            <select style="width: 100%; padding: 8px; background: #2d2d2d; color: white; border: 1px solid #444; border-radius: 4px;">
                <option>Select world...</option>
            </select>
            
            <div style="color: #cccccc; font-size: 14px; margin: 16px 0 4px 0;">Recommendation Mode:</div>
            <select @bind="AppState.RecommendationMode" 
                    style="width: 100%; padding: 8px; background: #2d2d2d; color: white; border: 1px solid #444; border-radius: 4px;">
                <option value="@RecommendationMode.MinimizeTotalCost">Minimize Total Cost</option>
                <option value="@RecommendationMode.MaximizeValue">Maximize Value</option>
                <option value="@RecommendationMode.BestUnitPrice">Best Unit Price</option>
            </select>
        }
        
        <div style="color: #cccccc; font-size: 14px; margin: 24px 0 4px 0;">Item Name:</div>
        <input type="text" 
               @bind="_searchQuery"
               @bind:event="oninput"
               @onkeyup="OnSearchKeyUp"
               placeholder="Enter item..."
               style="width: 100%; padding: 8px; background: #2d2d2d; color: white; border: 1px solid #444; border-radius: 4px; box-sizing: border-box;" />
        
        <button @onclick="SearchItemsAsync" 
                disabled="@_isSearching"
                style="width: 100%; padding: 8px; margin-top: 8px; background: #d4a73a; color: #1a1a1a; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
            @if (_isSearching)
            {
                <span>Searching...</span>
            }
            else
            {
                <span>Search</span>
            }
        </button>
        
        @if (_searchResults.Any())
        {
            <div style="margin-top: 16px; background: #2d2d2d; border-radius: 4px; border: 1px solid #d4a73a; max-height: 200px; overflow-y: auto;">
                @foreach (var result in _searchResults)
                {
                    <div @onclick="() => AddItemToList(result)" 
                         style="padding: 8px; cursor: pointer; border-bottom: 1px solid #444;"
                         onmouseover="this.style.backgroundColor='#3d3d3d'" 
                         onmouseout="this.style.backgroundColor='transparent'">
                        <div style="color: white;">@result.Object.Name</div>
                        <div style="color: #888; font-size: 12px;">ID: @result.Id</div>
                    </div>
                }
            </div>
        }

        <!-- Sync to Recipe Planner Button -->
        @if (AppState.ShoppingItems.Any())
        {
            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #444;">
                <button @onclick="GoToPlanner"
                        style="width: 100%; padding: 10px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Open in Recipe Planner â†’
                </button>
                <div style="color: #888; font-size: 12px; text-align: center; margin-top: 4px;">
                    @AppState.ShoppingItems.Count items ready
                </div>
            </div>
        }
    </div>
    
    <!-- Middle Column: Shopping List -->
    <div style="padding: 16px; overflow-y: auto; border-right: 1px solid #333;">
        <div style="background: #2d2d2d; border-radius: 4px; border: 1px solid #444;">
            <!-- Shopping List Header -->
            <div style="background: #363636; padding: 12px 16px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #cccccc; font-weight: 500;">Shopping List</span>
                <div style="display: flex; gap: 8px;">
                    <button @onclick="ClearAllItems" 
                            disabled="@(!AppState.ShoppingItems.Any())"
                            style="background: transparent; border: 1px solid #555; color: #ccc; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Clear</button>
                    <label style="background: transparent; border: 1px solid #555; color: #ccc; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        Import
                        <InputFile OnChange="ImportPlanAsync" accept=".json" style="display: none;" />
                    </label>
                    <button @onclick="ExportPlanAsync" 
                            disabled="@(!AppState.ShoppingItems.Any())"
                            style="background: transparent; border: 1px solid #555; color: #ccc; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Export</button>
                </div>
            </div>
            
            <!-- Shopping List Content -->
            <div style="padding: 16px;">
                @if (!AppState.ShoppingItems.Any())
                {
                    <div style="background: #363636; padding: 16px; border-radius: 4px; color: #ccc; font-size: 14px;">
                        Search for items and add them to your shopping list. Then click "Analyze Market" to get world recommendations.
                    </div>
                }
                else
                {
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid #444;">
                                <th style="text-align: left; padding: 8px; color: #ccc; font-weight: 500;">Item</th>
                                <th style="text-align: left; padding: 8px; color: #ccc; font-weight: 500;">Quantity</th>
                                <th style="text-align: right; padding: 8px; color: #ccc; font-weight: 500;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in AppState.ShoppingItems)
                            {
                                <tr style="border-bottom: 1px solid #333;">
                                    <td style="padding: 8px; color: white;">@item.Name</td>
                                    <td style="padding: 8px;">
                                        <input type="number" @bind="item.Quantity" min="1" max="9999" 
                                               style="width: 60px; padding: 4px; background: #1e1e1e; color: white; border: 1px solid #444; border-radius: 4px;" />
                                    </td>
                                    <td style="padding: 8px; text-align: right;">
                                        <button @onclick="() => RemoveItem(item)" 
                                                style="background: transparent; border: none; color: #ff6b6b; cursor: pointer; font-size: 12px;">Remove</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
            
            <!-- Analyze Button -->
            <div style="padding: 16px; border-top: 1px solid #444;">
                <button @onclick="AnalyzeMarketAsync"
                        disabled="@(!AppState.ShoppingItems.Any() || _isAnalyzing || string.IsNullOrWhiteSpace(AppState.SelectedDataCenter))"
                        style="width: 100%; padding: 10px; background: #d4a73a; color: #1a1a1a; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    @if (_isAnalyzing)
                    {
                        <span>Analyzing...</span>
                    }
                    else
                    {
                        <span>Analyze Market</span>
                    }
                </button>
            </div>
        </div>
        
        <!-- Results Panel -->
        @if (AppState.ShoppingPlans.Any())
        {
            <div style="margin-top: 16px;">
                <div style="background: #2d2d2d; padding: 12px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #d4a73a;">
                    <div style="color: white; font-weight: 500;">Market Analysis Results</div>
                </div>
                
                @foreach (var plan in AppState.ShoppingPlans)
                {
                    <div style="background: #2d2d2d; padding: 12px; border-radius: 4px; margin-bottom: 12px; border: 1px solid #444;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <div style="color: white; font-weight: 500;">@plan.Name</div>
                                <div style="color: #888; font-size: 12px;">
                                    Need: @plan.QuantityNeeded | DC Avg: @plan.DCAveragePrice.ToString("N0")g
                                </div>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(plan.Error))
                        {
                            <div style="background: #5c2b2b; color: #ff9999; padding: 8px; border-radius: 4px; font-size: 14px;">
                                @plan.Error
                            </div>
                        }
                        else if (plan.HasOptions)
                        {
                            @foreach (var world in plan.WorldOptions.Take(5))
                            {
                                <div style="border: 1px solid #444; border-radius: 4px; margin-bottom: 8px; overflow: hidden;">
                                    <div style="background: #363636; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="color: white; font-weight: 500;">@world.WorldName</span>
                                            @if (world.IsCompetitive)
                                            {
                                                <span style="color: #4caf50; font-size: 12px;">Best Value</span>
                                            }
                                        </div>
                                        <span style="color: #4caf50; font-weight: 600;">@world.CostDisplay</span>
                                    </div>
                                    <div style="padding: 8px 12px; font-size: 12px; color: #888;">
                                        @(world.ListingsUsed) listing(s) | @world.ExcessQuantity excess
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        }
    </div>
    
    <!-- Right Column: Market Logistics Results -->
    <div style="padding: 16px; overflow-y: auto;">
        <div style="color: #888; text-align: center; margin-top: 40px;">
            Market Logistics panel
            <br />
            <span style="font-size: 12px;">(Click "Analyze Market" to see results)</span>
        </div>
    </div>
</div>

@code {
    private WorldData? _worldData;
    private bool _isLoadingWorlds = true;

    private string _searchQuery = string.Empty;
    private bool _isSearching = false;
    private List<GarlandSearchResult> _searchResults = new();
    
    private bool _isAnalyzing = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _worldData = await UniversalisService.GetWorldDataAsync();
            _isLoadingWorlds = false;
            
            if (string.IsNullOrEmpty(AppState.SelectedDataCenter))
            {
                AppState.SelectedDataCenter = _worldData.DataCenters.FirstOrDefault() ?? "Aether";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Index.razor: ERROR - {ex}");
            
            // Fallback for development
            _worldData = new WorldData
            {
                DataCenterToWorlds = new Dictionary<string, List<string>>
                {
                    ["Aether"] = new() { "Adamantoise", "Cactuar", "Faerie", "Gilgamesh", "Jenova", "Midgardsormr", "Sargatanas", "Siren" },
                    ["Primal"] = new() { "Behemoth", "Excalibur", "Exodus", "Famfrit", "Hyperion", "Lamia", "Leviathan", "Ultros" },
                    ["Crystal"] = new() { "Balmung", "Brynhildr", "Coeurl", "Diabolos", "Goblin", "Malboro", "Mateus", "Zalera" },
                    ["Dynamis"] = new() { "Cuchulainn", "Golem", "Halicarnassus", "Kraken", "Maduin", "Marilith", "Rafflesia", "Seraph" }
                }
            };
            AppState.SelectedDataCenter = "Aether";
            _isLoadingWorlds = false;
            
            Snackbar.Add($"Using fallback world data. API error: {ex.Message}", Severity.Warning);
        }

        // Subscribe to state changes
        AppState.OnShoppingListChanged += OnShoppingListChanged;
    }

    private void OnShoppingListChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AppState.OnShoppingListChanged -= OnShoppingListChanged;
    }

    private async Task SearchItemsAsync()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
            return;

        _isSearching = true;
        _searchResults.Clear();
        
        try
        {
            var results = await GarlandService.SearchAsync(_searchQuery);
            _searchResults = results.Take(10).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Search failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSearching = false;
        }
    }

    private void OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _ = SearchItemsAsync();
        }
    }

    private void AddItemToList(GarlandSearchResult result)
    {
        var existing = AppState.ShoppingItems.FirstOrDefault(i => i.Id == result.Id);
        if (existing != null)
        {
            existing.Quantity++;
        }
        else
        {
            AppState.ShoppingItems.Add(new MarketShoppingItem
            {
                Id = result.Id,
                Name = result.Object.Name,
                IconId = result.Object.IconId,
                Quantity = 1
            });
        }
        
        _searchResults.Clear();
        _searchQuery = string.Empty;
        AppState.ShoppingPlans.Clear();
        AppState.NotifyShoppingListChanged();
    }

    private void RemoveItem(MarketShoppingItem item)
    {
        AppState.ShoppingItems.Remove(item);
        AppState.ShoppingPlans.Clear();
        AppState.NotifyShoppingListChanged();
    }

    private void ClearAllItems()
    {
        AppState.ShoppingItems.Clear();
        AppState.ShoppingPlans.Clear();
        AppState.NotifyShoppingListChanged();
    }

    private async Task AnalyzeMarketAsync()
    {
        if (!AppState.ShoppingItems.Any() || string.IsNullOrWhiteSpace(AppState.SelectedDataCenter))
            return;

        _isAnalyzing = true;
        AppState.ShoppingPlans.Clear();

        try
        {
            var materials = AppState.ShoppingItems.Select(i => new MaterialAggregate
            {
                ItemId = i.Id,
                Name = i.Name,
                IconId = i.IconId,
                TotalQuantity = i.Quantity
            }).ToList();

            var progress = new Progress<string>(msg => { });
            
            AppState.ShoppingPlans = await MarketShoppingService.CalculateDetailedShoppingPlansAsync(
                materials,
                AppState.SelectedDataCenter,
                progress,
                mode: AppState.RecommendationMode);
                
            AppState.NotifyShoppingListChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Market analysis failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isAnalyzing = false;
        }
    }

    private async Task ImportPlanAsync(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024);
            using var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();
            var plan = RecipeCalculationService.DeserializePlan(json);
            
            if (plan == null)
            {
                Snackbar.Add("Failed to import plan. Invalid format.", Severity.Error);
                return;
            }

            AppState.ShoppingItems.Clear();
            foreach (var node in plan.RootItems)
            {
                AppState.ShoppingItems.Add(new MarketShoppingItem
                {
                    Id = node.ItemId,
                    Name = node.Name,
                    IconId = node.IconId,
                    Quantity = node.Quantity
                });
            }

            AppState.SelectedDataCenter = plan.DataCenter;
            AppState.NotifyShoppingListChanged();
            
            Snackbar.Add($"Imported plan: {plan.Name} ({AppState.ShoppingItems.Count} items)", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Import failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportPlanAsync()
    {
        try
        {
            var targetItems = AppState.ShoppingItems.Select(i => (i.Id, i.Name, i.Quantity, false)).ToList();
            var plan = await RecipeCalculationService.BuildPlanAsync(
                targetItems, 
                AppState.SelectedDataCenter, 
                string.Empty);

            plan.Name = $"WebPlan_{DateTime.Now:yyyyMMdd_HHmmss}";
            var json = RecipeCalculationService.SerializePlan(plan);
            
            var bytes = System.Text.Encoding.UTF8.GetBytes(json);
            var stream = new MemoryStream(bytes);
            
            using var streamRef = new DotNetStreamReference(stream);
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", $"{plan.Name}.json", streamRef);
            
            Snackbar.Add("Plan exported successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
    }

    private void GoToPlanner()
    {
        // Sync shopping items to project items
        AppState.SyncShoppingToProject();
        NavigationManager.NavigateTo("/planner");
    }
}
