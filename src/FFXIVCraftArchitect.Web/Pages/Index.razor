@page "/"
@using FFXIVCraftArchitect.Core.Models
@using FFXIVCraftArchitect.Core.Services
@using FFXIVCraftArchitect.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@inject GarlandService GarlandService
@inject UniversalisService UniversalisService
@inject RecipeCalculationService RecipeCalculationService
@inject MarketShoppingService MarketShoppingService
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@inject AppState AppState
@inject IndexedDbService IndexedDb
@inject IMarketCacheService MarketCache
@inject NavigationManager NavigationManager
@inject ILogger<Index> Logger
@implements IDisposable

<!-- 3-Column Layout matching WPF -->
<div style="display: grid; grid-template-columns: 280px 1fr 350px; gap: 0; height: calc(100vh - 64px);">
    
    <!-- Left Column: Project Items -->
    <div style="padding: 16px; overflow-y: auto; border-right: 1px solid #333;">
        <div style="font-size: 16px; font-weight: 600; color: #d4a73a; margin-bottom: 16px;">Project Items</div>
        
        <!-- Add Item Section -->
        <div style="margin-bottom: 16px;">
            <div style="color: #cccccc; font-size: 14px; margin-bottom: 4px;">Item Name:</div>
            <input type="text" 
                   @bind="_searchQuery"
                   @bind:event="oninput"
                   @onkeyup="OnSearchKeyUp"
                   placeholder="Enter item..."
                   style="width: 100%; padding: 8px; background: #2d2d2d; color: white; border: 1px solid #444; border-radius: 4px; box-sizing: border-box;" />
            
            <button type="button" 
                    @onclick="SearchItemsAsync" 
                    disabled="@_isSearching"
                    style="width: 100%; padding: 8px; margin-top: 8px; background: #d4a73a; color: #1a1a1a; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                @if (_isSearching)
                {
                    <span>Searching...</span>
                }
                else
                {
                    <span>Search</span>
                }
            </button>
            
            @if (_searchResults.Any())
            {
                <div style="margin-top: 8px; background: #2d2d2d; border-radius: 4px; border: 1px solid #d4a73a; max-height: 200px; overflow-y: auto;">
                    @foreach (var result in _searchResults)
                    {
                        <div @onclick="() => AddProjectItem(result)" 
                             style="padding: 8px; cursor: pointer; border-bottom: 1px solid #444;"
                             onmouseover="this.style.backgroundColor='#3d3d3d'" 
                             onmouseout="this.style.backgroundColor='transparent'">
                            <div style="color: white;">@result.Object.Name</div>
                            <div style="color: #888; font-size: 12px;">ID: @result.Id</div>
                        </div>
                    }
                </div>
            }
        </div>
        
        <!-- Project Items List -->
        <div style="background: #2d2d2d; border-radius: 4px; border: 1px solid #444;">
            <div style="background: #363636; padding: 12px; border-bottom: 1px solid #444;">
                <span style="color: #cccccc; font-weight: 500;">Target Items</span>
            </div>
            <div style="padding: 8px;">
                @if (!AppState.ProjectItems.Any())
                {
                    <div style="color: #888; text-align: center; padding: 24px; font-size: 14px;">
                        Search for items to add to your project.
                    </div>
                }
                else
                {
                    @foreach (var item in AppState.ProjectItems)
                    {
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #1e1e1e; border-radius: 4px; margin-bottom: 8px;">
                            <button @onclick="() => ToggleItemHq(item)"
                                    style="background: transparent; border: none; cursor: pointer; color: @(item.MustBeHq ? "#d4a73a" : "#666"); font-size: 14px; padding: 0; width: 20px;">
                                ★
                            </button>
                            <div style="flex: 1; color: @(item.MustBeHq ? "#d4a73a" : "white");">
                                @item.Name
                            </div>
                            <input type="number" 
                                   @bind="item.Quantity"
                                   min="1"
                                   max="9999"
                                   style="width: 60px; padding: 4px; background: #2d2d2d; color: white; border: 1px solid #444; border-radius: 4px; text-align: center;" />
                            <button @onclick="() => RemoveProjectItem(item)"
                                    style="background: transparent; border: none; color: #ff6b6b; cursor: pointer; font-size: 12px;">
                                ×
                            </button>
                        </div>
                    }
                }
            </div>
            
            <!-- Build Plan Button -->
            <div style="padding: 12px; border-top: 1px solid #444;">
                <button @onclick="BuildPlanAsync"
                        disabled="@(!AppState.ProjectItems.Any() || _isBuildingPlan)"
                        style="width: 100%; padding: 10px; background: #d4a73a; color: #1a1a1a; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    @if (_isBuildingPlan)
                    {
                        <span>Building...</span>
                    }
                    else
                    {
                        <span>Build Project Plan</span>
                    }
                </button>
            </div>
        </div>
        

        
        <!-- Plan Actions -->
        @if (AppState.CurrentPlan != null || AppState.ProjectItems.Any())
        {
            <div style="margin-top: 16px; display: flex; gap: 8px;">
                <button @onclick="SaveToBrowserAsync"
                        style="flex: 1; padding: 8px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    Save
                </button>
                <button @onclick="ExportPlanAsync"
                        style="flex: 1; padding: 8px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    Export
                </button>
            </div>
            
            @if (AppState.LastAutoSave.HasValue)
            {
                <div style="color: #888; font-size: 11px; text-align: center; margin-top: 8px;">
                    Auto-saved: @AppState.LastAutoSave.Value.ToString("HH:mm:ss")
                </div>
            }
        }
    </div>
    
    <!-- Middle Column: Recipe Tree -->
    <div style="padding: 16px; overflow-y: auto; border-right: 1px solid #333;" id="recipe-tree-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div style="font-size: 16px; font-weight: 600; color: #d4a73a;">Recipe Plan</div>
            @if (AppState.CurrentPlan != null)
            {
                <div style="display: flex; gap: 4px;">
                    <button @onclick="() => AppState.ExpandAllRecipeNodes()"
                            title="Expand All"
                            style="padding: 4px 8px; background: #2d2d2d; color: #ccc; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        + Expand All
                    </button>
                    <button @onclick="() => AppState.CollapseAllRecipeNodes()"
                            title="Collapse All"
                            style="padding: 4px 8px; background: #2d2d2d; color: #ccc; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        − Collapse All
                    </button>
                </div>
            }
        </div>
        
        @if (AppState.CurrentPlan == null)
        {
            <div style="color: #888; text-align: center; padding: 40px;">
                <div style="font-size: 18px; margin-bottom: 8px;">No Plan Built Yet</div>
                <div style="font-size: 14px;">Add items to your project and click "Build Project Plan" to see the recipe tree.</div>
                
                <!-- Saved Plans Section -->
                @if (AppState.SavedPlans.Any())
                {
                    <div style="margin-top: 32px; text-align: left;">
                        <div style="color: #d4a73a; font-size: 14px; margin-bottom: 12px;">Saved Plans:</div>
                        @foreach (var plan in AppState.SavedPlans)
                        {
                            <div style="background: #2d2d2d; padding: 12px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #444; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: white; font-weight: 500;">@plan.Name</div>
                                    <div style="color: #888; font-size: 12px;">
                                        @plan.DataCenter • @plan.ItemCount items • @plan.SavedAt.ToString("MMM dd, HH:mm")
                                    </div>
                                </div>
                                <div style="display: flex; gap: 4px;">
                                    <button @onclick="() => LoadSavedPlanAsync(plan.Id)"
                                            style="padding: 4px 12px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        Load
                                    </button>
                                    <button @onclick="() => DeleteSavedPlanAsync(plan.Id)"
                                            style="padding: 4px 8px; background: transparent; color: #ff6b6b; border: 1px solid #ff6b6b; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        ×
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <!-- Recipe Tree -->
            <div style="background: #2d2d2d; border-radius: 4px; border: 1px solid #444; padding: 12px;">
                @foreach (var rootItem in AppState.CurrentPlan.RootItems)
                {
                    <RecipeNodeView Node="rootItem" 
                                    Depth="0"
                                    OnSourceChanged="OnNodeSourceChanged"
                                    OnHqChanged="OnNodeHqChanged" />
                }
            </div>
            
            <!-- Craft vs Buy Analysis -->
            <CraftAnalysisPanel Analyses="AppState.CraftAnalyses" />
        }
    </div>
    
    <!-- Right Column: Shopping List -->
    <div style="padding: 16px; overflow-y: auto;">
        <div style="font-size: 16px; font-weight: 600; color: #d4a73a; margin-bottom: 16px;">Shopping List</div>
        
        @if (AppState.CurrentPlan == null)
        {
            <div style="color: #888; text-align: center; padding: 24px;">
                Build a plan to see your shopping list.
            </div>
        }
        else
        {
            var materials = AppState.CurrentPlan.AggregatedMaterials.Where(m => m.TotalQuantity > 0).ToList();
            
            @if (!materials.Any())
            {
                <div style="color: #888; text-align: center; padding: 24px;">
                    All items are set to be crafted.
                    <br />
                    <span style="font-size: 12px;">Change acquisition sources to generate a shopping list.</span>
                </div>
            }
            else
            {
                <div style="background: #2d2d2d; border-radius: 4px; border: 1px solid #444;">
                    <!-- Header -->
                    <div style="background: #363636; padding: 12px; border-bottom: 1px solid #444;">
                        <div style="display: flex; justify-content: space-between; color: #ccc; font-size: 12px; font-weight: 500;">
                            <span>Item</span>
                            <span>Qty</span>
                            <span>Price</span>
                        </div>
                    </div>
                    
                    <!-- Items -->
                    <div style="padding: 8px;">
                        @foreach (var material in materials)
                        {
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #1e1e1e; border-radius: 4px; margin-bottom: 6px;">
                                <div style="flex: 1; color: @(material.RequiresHq ? "#d4a73a" : "white"); font-size: 13px;">
                                    @if (material.RequiresHq)
                                    {
                                        <span>★</span>
                                    }
                                    @material.Name
                                </div>
                                <div style="color: #ccc; font-size: 13px; min-width: 50px; text-align: center;">
                                    @material.TotalQuantity
                                </div>
                                <div style="color: #4caf50; font-size: 12px; min-width: 80px; text-align: right;">
                                    @if (material.UnitPrice > 0)
                                    {
                                        <span>@material.TotalCost.ToString("N0")g</span>
                                    }
                                    else
                                    {
                                        <span style="color: #888;">-</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                    
                    <!-- Total -->
                    <div style="background: #363636; padding: 12px; border-top: 1px solid #444;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #ccc; font-size: 14px;">Total Cost:</span>
                            <span style="color: #4caf50; font-weight: 600; font-size: 16px;">
                                @materials.Sum(m => m.TotalCost).ToString("N0")g
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Export Buttons -->
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    <button @onclick="ExportToArtisanAsync"
                            style="flex: 1; padding: 8px; background: #673ab7; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        Export to Artisan
                    </button>
                    <button @onclick="ExportToCsvAsync"
                            style="flex: 1; padding: 8px; background: #2d2d2d; color: #ccc; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        Export CSV
                    </button>
                </div>
                
                <!-- Navigation to Market Analysis & Procurement -->
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #444;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 8px;">Market Tools:</div>
                    <div style="display: flex; gap: 8px;">
                        <button @onclick="GoToMarketAnalysis"
                                disabled="@(!AppState.ShoppingItems.Any())"
                                style="flex: 1; padding: 10px; background: #d4a73a; color: #1a1a1a; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                            Market Analysis →
                        </button>
                        <button @onclick="GoToProcurement"
                                disabled="@(!AppState.ShoppingItems.Any())"
                                style="flex: 1; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                            Procurement Plan →
                        </button>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private string _searchQuery = string.Empty;
    private bool _isSearching = false;
    private List<GarlandSearchResult> _searchResults = new();
    
    private bool _isBuildingPlan = false;
    private bool _isRefreshingPrices = false;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to state changes
        AppState.OnPlanChanged += OnPlanChanged;
        
        // Load saved plans list
        await RefreshSavedPlansListAsync();
        
        // Note: WorldData, auto-save restoration, and auto-save timer are now
        // all handled centrally in MainLayout.razor
    }

    private void OnPlanChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AppState.OnPlanChanged -= OnPlanChanged;
        
        // Note: Auto-save timer is now managed centrally in MainLayout.razor
    }

    private async Task RefreshSavedPlansListAsync()
    {
        var plans = await IndexedDb.LoadAllPlansAsync();
        AppState.SavedPlans = plans
            .Where(p => p.Id != "autosave") // Don't show autosave in list
            .Select(p => new StoredPlanSummary
            {
                Id = p.Id,
                Name = p.Name,
                ModifiedAt = p.ModifiedAt,
                SavedAt = p.SavedAt,
                DataCenter = p.DataCenter,
                ItemCount = p.ProjectItems.Count
            })
            .ToList();
        AppState.NotifySavedPlansChanged();
    }

    private async Task SearchItemsAsync()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
            return;

        _isSearching = true;
        _searchResults.Clear();
        
        try
        {
            var results = await GarlandService.SearchAsync(_searchQuery);
            _searchResults = results.Take(10).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Search failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSearching = false;
            StateHasChanged(); // Force re-render to update button text and results
        }
    }

    private void OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _ = SearchItemsAsync();
        }
    }

    private void AddProjectItem(GarlandSearchResult result)
    {
        if (!AppState.ProjectItems.Any(i => i.Id == result.Id))
        {
            AppState.ProjectItems.Add(new ProjectItem
            {
                Id = result.Id,
                Name = result.Object.Name,
                IconId = result.Object.IconId,
                Quantity = 1,
                MustBeHq = false
            });
            AppState.NotifyPlanChanged();
        }
        
        _searchResults.Clear();
        _searchQuery = string.Empty;
    }

    private void RemoveProjectItem(ProjectItem item)
    {
        AppState.ProjectItems.Remove(item);
        AppState.NotifyPlanChanged();
    }

    private void ToggleItemHq(ProjectItem item)
    {
        item.MustBeHq = !item.MustBeHq;
        AppState.NotifyPlanChanged();
    }

    private async Task BuildPlanAsync()
    {
        if (!AppState.ProjectItems.Any() || _isBuildingPlan)
            return;

        _isBuildingPlan = true;
        StateHasChanged();
        
        try
        {
            var targetItems = AppState.ProjectItems.Select(i => (i.Id, i.Name, i.Quantity, i.MustBeHq)).ToList();
            
            // Step 1: Build the recipe tree
            AppState.CurrentPlan = await RecipeCalculationService.BuildPlanAsync(
                targetItems, 
                AppState.SelectedDataCenter, 
                string.Empty);
            
            // Step 2: Fetch prices for all items (craftable and buyable)
            AppState.BeginOperation("Fetching Prices", "Loading market prices for all materials...");
            await RefreshPricesAsync();
            
            // Step 3: Clear previous shopping plans
            AppState.ShoppingPlans.Clear();
            
            // Step 4: Populate shopping list with items marked as "buy" from recipe plan
            // These will be shown in Procurement Planner for potential analysis
            PopulateShoppingListFromPlan();
            
            AppState.EndOperation($"Plan built with {AppState.CurrentPlan.RootItems.Count} items. Go to Procurement Planner to analyze.");
            Snackbar.Add($"Plan built! Prices fetched. Go to Procurement Planner to run market analysis.", Severity.Success);
        }
        catch (Exception ex)
        {
            AppState.EndOperation($"Failed: {ex.Message}");
            Snackbar.Add($"Failed to build plan: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isBuildingPlan = false;
        }
    }
    
    private void PopulateShoppingListFromPlan()
    {
        // Collect all items from the plan that are marked for buying
        // This includes leaf nodes (materials) and any craftable nodes the user set to "buy"
        var buyItems = new List<MarketShoppingItem>();
        
        foreach (var root in AppState.CurrentPlan?.RootItems ?? new List<PlanNode>())
        {
            CollectBuyItems(root, buyItems);
        }
        
        AppState.ShoppingItems = buyItems;
        AppState.NotifyShoppingListChanged();
    }
    
    private void CollectBuyItems(PlanNode node, List<MarketShoppingItem> buyItems)
    {
        // If this node is set to buy (or is uncraftable), add it to the shopping list
        if (node.Source == AcquisitionSource.MarketBuyNq || node.Source == AcquisitionSource.MarketBuyHq || node.IsUncraftable)
        {
            // Only add if not already in the list (aggregate quantities)
            var existing = buyItems.FirstOrDefault(i => i.Id == node.ItemId);
            if (existing != null)
            {
                existing.Quantity += node.Quantity;
            }
            else
            {
                buyItems.Add(new MarketShoppingItem
                {
                    Id = node.ItemId,
                    Name = node.Name,
                    IconId = node.IconId,
                    Quantity = node.Quantity
                });
            }
        }
        
        // Recursively check children
        if (node.Children?.Any() == true)
        {
            foreach (var child in node.Children)
            {
                CollectBuyItems(child, buyItems);
            }
        }
    }

    private async Task RefreshPricesAsync()
    {
        if (AppState.CurrentPlan == null)
            return;

        _isRefreshingPrices = true;
        
        try
        {
            // Fetch vendor prices (cheap, from Garland)
            await RecipeCalculationService.FetchVendorPricesAsync(AppState.CurrentPlan);
            
            // Fetch market prices (from Universalis)
            var allItemIds = CollectAllItemIds(AppState.CurrentPlan.RootItems);
            var responses = await UniversalisService.GetMarketDataBulkAsync(AppState.SelectedDataCenter, allItemIds);

            // Update nodes with market prices
            foreach (var root in AppState.CurrentPlan.RootItems)
            {
                UpdateNodePrices(root, responses);
            }

            // Cache fetched market data in IndexedDB for use by Market Analysis
            foreach (var kvp in responses)
            {
                var cachedData = ConvertResponseToCachedData(kvp.Key, AppState.SelectedDataCenter, kvp.Value);
                await MarketCache.SetAsync(kvp.Key, AppState.SelectedDataCenter, cachedData);
            }

            Logger.LogInformation("Cached {Count} market entries to IndexedDB", responses.Count);

            // Recalculate craft vs buy analysis
            await CalculateCraftVsBuyAnalysisAsync();
            
            AppState.NotifyPlanChanged();
            
            Snackbar.Add("Prices updated (vendor + market)", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to fetch prices: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isRefreshingPrices = false;
        }
    }

    private static List<int> CollectAllItemIds(List<PlanNode> nodes)
    {
        var ids = new HashSet<int>();
        foreach (var node in nodes)
        {
            CollectItemIdsRecursive(node, ids);
        }
        return ids.ToList();
    }

    private static void CollectItemIdsRecursive(PlanNode node, HashSet<int> ids)
    {
        ids.Add(node.ItemId);
        foreach (var child in node.Children)
        {
            CollectItemIdsRecursive(child, ids);
        }
    }

    private static void UpdateNodePrices(PlanNode node, Dictionary<int, UniversalisResponse> responses)
    {
        if (responses.TryGetValue(node.ItemId, out var response))
        {
            node.MarketPrice = (decimal)response.AveragePrice;
            var hqListings = response.Listings.Where(l => l.IsHq).ToList();
            if (hqListings.Any())
            {
                node.HqMarketPrice = (decimal)hqListings.Average(l => l.PricePerUnit);
            }
        }
        
        foreach (var child in node.Children)
        {
            UpdateNodePrices(child, responses);
        }
    }

    /// <summary>
    /// Converts UniversalisResponse to CachedMarketData for IndexedDB storage.
    /// </summary>
    private static CachedMarketData ConvertResponseToCachedData(int itemId, string dataCenter, UniversalisResponse response)
    {
        var worlds = new List<CachedWorldData>();

        foreach (var worldListing in response.Listings.GroupBy(l => l.WorldName))
        {
            worlds.Add(new CachedWorldData
            {
                WorldName = worldListing.Key ?? "Unknown",
                Listings = worldListing.Select(l => new CachedListing
                {
                    Quantity = l.Quantity,
                    PricePerUnit = l.PricePerUnit,
                    RetainerName = l.RetainerName ?? "Unknown",
                    IsHq = l.IsHq
                }).ToList()
            });
        }

        return new CachedMarketData
        {
            ItemId = itemId,
            DataCenter = dataCenter,
            FetchedAtUnix = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
            DCAveragePrice = (decimal)(response.AveragePriceNq > 0 ? response.AveragePriceNq : response.AveragePrice),
            HQAveragePrice = response.AveragePriceHq > 0 ? (decimal)response.AveragePriceHq : null,
            Worlds = worlds
        };
    }

    private async Task CalculateCraftVsBuyAnalysisAsync()
    {
        if (AppState.CurrentPlan == null)
            return;

        AppState.CraftAnalyses.Clear();
        
        foreach (var root in AppState.CurrentPlan.RootItems)
        {
            await AnalyzeNodeAsync(root);
        }
    }

    private async Task AnalyzeNodeAsync(PlanNode node)
    {
        if (node.Children.Any())
        {
            // Calculate craft cost (sum of child costs)
            var craftCost = await CalculateNodeCraftCostAsync(node);
            
            // Buy cost
            var buyCostNq = node.MarketPrice * node.Quantity;
            var buyCostHq = node.HqMarketPrice > 0 ? node.HqMarketPrice * node.Quantity : buyCostNq;
            
            var analysis = new CraftVsBuyAnalysis
            {
                ItemId = node.ItemId,
                ItemName = node.Name,
                Quantity = node.Quantity,
                BuyCostNq = buyCostNq,
                BuyCostHq = buyCostHq,
                CraftCost = craftCost,
                PotentialSavingsNq = buyCostNq - craftCost,
                PotentialSavingsHq = buyCostHq - craftCost,
                SavingsPercentNq = buyCostNq > 0 ? ((buyCostNq - craftCost) / buyCostNq) * 100 : 0,
                SavingsPercentHq = buyCostHq > 0 ? ((buyCostHq - craftCost) / buyCostHq) * 100 : 0,
                RecommendationNq = craftCost < buyCostNq ? CraftRecommendation.Craft : CraftRecommendation.Buy,
                RecommendationHq = craftCost < buyCostHq ? CraftRecommendation.Craft : CraftRecommendation.Buy,
                IsCurrentlySetToCraft = node.Source == AcquisitionSource.Craft,
                IsHqRequired = node.MustBeHq,
                HasHqData = node.HqMarketPrice > 0
            };
            
            AppState.CraftAnalyses.Add(analysis);
        }
        
        // Recurse into children
        foreach (var child in node.Children)
        {
            await AnalyzeNodeAsync(child);
        }
    }

    private async Task<decimal> CalculateNodeCraftCostAsync(PlanNode node)
    {
        decimal cost = 0;
        
        foreach (var child in node.Children)
        {
            cost += child.Source switch
            {
                AcquisitionSource.Craft => await CalculateNodeCraftCostAsync(child),
                AcquisitionSource.MarketBuyNq => child.MarketPrice * child.Quantity,
                AcquisitionSource.MarketBuyHq => (child.HqMarketPrice > 0 ? child.HqMarketPrice : child.MarketPrice) * child.Quantity,
                _ => 0
            };
        }
        
        return cost;
    }

    private void OnNodeSourceChanged(PlanNode node)
    {
        // Recalculate shopping list when acquisition source changes
        PopulateShoppingListFromPlan();
        AppState.NotifyPlanChanged();
    }

    private void OnNodeHqChanged(PlanNode node)
    {
        AppState.NotifyPlanChanged();
    }

    private async Task SaveToBrowserAsync()
    {
        if (!AppState.ProjectItems.Any())
            return;

        try
        {
            // Use existing plan ID if available (overwrite), otherwise generate new
            var planId = AppState.CurrentPlanId ?? Guid.NewGuid().ToString();
            var planName = AppState.CurrentPlanName ?? AppState.CurrentPlan?.Name ?? $"Plan_{DateTime.Now:yyyyMMdd_HHmm}";
            
            // If this is a new save (no CurrentPlanId), set it for future overwrites
            if (AppState.CurrentPlanId == null)
            {
                AppState.CurrentPlanId = planId;
                AppState.CurrentPlanName = planName;
            }
            
            var planData = new StoredPlan
            {
                Id = planId,
                Name = planName,
                DataCenter = AppState.SelectedDataCenter,
                ModifiedAt = DateTime.UtcNow,
                ProjectItems = AppState.ProjectItems.Select(p => new StoredProjectItem
                {
                    Id = p.Id,
                    Name = p.Name,
                    IconId = p.IconId,
                    Quantity = p.Quantity,
                    MustBeHq = p.MustBeHq
                }).ToList(),
                PlanJson = AppState.CurrentPlan != null 
                    ? System.Text.Json.JsonSerializer.Serialize(AppState.CurrentPlan) 
                    : null
            };

            var success = await IndexedDb.SavePlanAsync(planData);
            if (success)
            {
                var action = AppState.CurrentPlanId == planId ? "Updated" : "Saved";
                Snackbar.Add($"{action} '{planName}' to browser storage", Severity.Success);
                await RefreshSavedPlansListAsync();
            }
            else
            {
                Snackbar.Add("Failed to save plan", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Save failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadSavedPlanAsync(string planId)
    {
        try
        {
            var storedPlan = await IndexedDb.LoadPlanAsync(planId);
            if (storedPlan == null)
            {
                Snackbar.Add("Plan not found", Severity.Error);
                return;
            }

            CraftingPlan? plan = null;
            if (!string.IsNullOrEmpty(storedPlan.PlanJson))
            {
                try
                {
                    plan = System.Text.Json.JsonSerializer.Deserialize<CraftingPlan>(storedPlan.PlanJson);
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Warning: Could not load full plan data: {ex.Message}", Severity.Warning);
                }
            }

            AppState.LoadStoredPlan(storedPlan, plan);
            
            // Restore market analysis if available
            if (!string.IsNullOrEmpty(storedPlan.MarketPlansJson))
            {
                try
                {
                    var marketPlans = System.Text.Json.JsonSerializer.Deserialize<List<DetailedShoppingPlan>>(storedPlan.MarketPlansJson);
                    if (marketPlans?.Any() == true)
                    {
                        AppState.ShoppingPlans = marketPlans;
                        AppState.RecommendationMode = storedPlan.SavedRecommendationMode;
                        AppState.NotifyShoppingListChanged();
                    }
                }
                catch (Exception ex)
                {
                    Logger?.LogWarning(ex, "Failed to restore market analysis");
                }
            }
            
            if (plan != null)
            {
                // Recalculate analysis
                await CalculateCraftVsBuyAnalysisAsync();
            }
            
            Snackbar.Add($"Loaded '{storedPlan.Name}'", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Load failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteSavedPlanAsync(string planId)
    {
        try
        {
            var success = await IndexedDb.DeletePlanAsync(planId);
            if (success)
            {
                Snackbar.Add("Plan deleted", Severity.Success);
                await RefreshSavedPlansListAsync();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Delete failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportPlanAsync()
    {
        if (AppState.CurrentPlan == null)
            return;

        try
        {
            var json = RecipeCalculationService.SerializePlan(AppState.CurrentPlan);
            var bytes = System.Text.Encoding.UTF8.GetBytes(json);
            var stream = new MemoryStream(bytes);
            
            using var streamRef = new DotNetStreamReference(stream);
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", $"{AppState.CurrentPlan.Name}.json", streamRef);
            
            Snackbar.Add("Plan exported to Downloads!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportToArtisanAsync()
    {
        if (AppState.CurrentPlan == null)
            return;

        try
        {
            var targetItems = AppState.CurrentPlan.RootItems.Select(r => (r.ItemId, r.Name, r.Quantity, r.MustBeHq)).ToList();
            var exportPlan = await RecipeCalculationService.BuildPlanAsync(targetItems, AppState.SelectedDataCenter, string.Empty);
            
            var json = RecipeCalculationService.SerializePlan(exportPlan);
            var bytes = System.Text.Encoding.UTF8.GetBytes(json);
            var stream = new MemoryStream(bytes);
            
            using var streamRef = new DotNetStreamReference(stream);
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", "artisan_import.json", streamRef);
            
            Snackbar.Add("Exported for Artisan!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportToCsvAsync()
    {
        if (AppState.CurrentPlan == null)
            return;

        try
        {
            var materials = AppState.CurrentPlan.AggregatedMaterials.Where(m => m.TotalQuantity > 0);
            var csv = new System.Text.StringBuilder();
            csv.AppendLine("Item,Quantity,Unit Price,Total Cost");
            
            foreach (var m in materials)
            {
                csv.AppendLine($"{m.Name},{m.TotalQuantity},{m.UnitPrice},{m.TotalCost}");
            }
            
            var bytes = System.Text.Encoding.UTF8.GetBytes(csv.ToString());
            var stream = new MemoryStream(bytes);
            
            using var streamRef = new DotNetStreamReference(stream);
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", "shopping_list.csv", streamRef);
            
            Snackbar.Add("CSV exported!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
    }

    private void GoToMarketAnalysis()
    {
        // Use relative path (no leading slash) so it resolves against base href correctly
        NavigationManager.NavigateTo("market");
    }

    private void GoToProcurement()
    {
        // Use relative path (no leading slash) so it resolves against base href correctly
        NavigationManager.NavigateTo("procurement");
    }
}
