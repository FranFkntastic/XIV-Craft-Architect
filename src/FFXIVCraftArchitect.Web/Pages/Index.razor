@page "/"
@using FFXIVCraftArchitect.Core.Models
@using FFXIVCraftArchitect.Core.Services
@using FFXIVCraftArchitect.Web.Services
@using FFXIVCraftArchitect.Web.Shared
@using Microsoft.AspNetCore.Components.Forms
@inject GarlandService GarlandService
@inject UniversalisService UniversalisService
@inject RecipeCalculationService RecipeCalculationService
@inject MarketShoppingService MarketShoppingService
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@inject AppState AppState
@inject NavigationManager NavigationManager
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="pa-0" Style="height: calc(100vh - 64px);">
    <div style="display: grid; grid-template-columns: 280px 350px 1fr; height: 100%; width: 100%;">
        
        <!-- Left Column: Controls (280px) -->
        <div Class="pa-4" Style="border-right: 1px solid #444; overflow-y: auto; min-width: 280px; max-width: 280px;">
            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-4">Market Logistics</MudText>
            
            @if (_isLoadingWorlds)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="my-4" />
                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">Loading worlds...</MudText>
            }
            else
            {
                <MudSelect T="string"
                           @bind-Value="AppState.SelectedDataCenter"
                           Label="Data Center"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Class="mb-3"
                           AdornmentColor="Color.Primary">
                    @foreach (var dc in _worldData?.DataCenters ?? new List<string>())
                    {
                        <MudSelectItem Value="@dc">@dc</MudSelectItem>
                    }
                </MudSelect>
                
                <MudSelect T="string"
                           @bind-Value="_selectedWorld"
                           Label="World"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Class="mb-3"
                           Disabled="string.IsNullOrEmpty(AppState.SelectedDataCenter)">
                    <MudSelectItem Value="@string.Empty">Any World</MudSelectItem>
                    @foreach (var world in GetWorldsForSelectedDc())
                    {
                        <MudSelectItem Value="@world">@world</MudSelectItem>
                    }
                </MudSelect>
                
                <MudSelect T="RecommendationMode"
                           @bind-Value="AppState.RecommendationMode"
                           Label="Mode"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Class="mb-4">
                    <MudSelectItem Value="@RecommendationMode.MinimizeTotalCost">Minimize Cost</MudSelectItem>
                    <MudSelectItem Value="@RecommendationMode.MaximizeValue">Maximize Value</MudSelectItem>
                    <MudSelectItem Value="@RecommendationMode.BestUnitPrice">Best Unit Price</MudSelectItem>
                </MudSelect>
            }
            
            <MudTextField @bind-Value="_searchQuery"
                          Label="Item Name"
                          Placeholder="Enter item..."
                          Variant="Variant.Outlined"
                          Dense="true"
                          Class="mb-2"
                          @onkeyup="OnSearchKeyUp"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          AdornmentColor="Color.Primary" />
            
            <MudButton OnClick="SearchItemsAsync"
                       Disabled="_isSearching"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       FullWidth="true"
                       Class="mb-4"
                       StartIcon="@Icons.Material.Filled.Search">
                @if (_isSearching)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Searching...</span>
                }
                else
                {
                    <span>Search</span>
                }
            </MudButton>
            
            @if (_searchResults.Any())
            {
                <MudPaper Elevation="2" Class="mb-4" Style="max-height: 200px; overflow-y: auto;">
                    <MudList T="GarlandSearchResult" Dense="true">
                        @foreach (var result in _searchResults)
                        {
                            <MudListItem T="GarlandSearchResult" OnClick="() => AddItemToList(result)">
                                <MudText Typo="Typo.body2">@result.Object.Name</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @result.Id</MudText>
                            </MudListItem>
                        }
                    </MudList>
                </MudPaper>
            }

            @if (AppState.ShoppingItems.Any())
            {
                <MudDivider Class="my-4" />
                <MudButton OnClick="GoToPlanner"
                           Color="Color.Info"
                           Variant="Variant.Filled"
                           FullWidth="true"
                           EndIcon="@Icons.Material.Filled.ArrowForward">
                    Open in Recipe Planner
                </MudButton>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center" Class="mt-2 d-block">
                    @AppState.ShoppingItems.Count items ready
                </MudText>
            }
        </div>
        
        <!-- Middle Column: Shopping List (350px) -->
        <div Class="pa-4" Style="border-right: 1px solid #444; overflow-y: auto; min-width: 350px; max-width: 350px;">
            <MudPaper Elevation="1" Class="pa-0" Style="height: 100%; display: flex; flex-direction: column;">
                <MudToolBar Dense="true" Class="px-4" Style="border-bottom: 1px solid #444;">
                    <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Shopping List</MudText>
                    <MudSpacer />
                    <MudButtonGroup Size="Size.Small">
                        <MudButton OnClick="ClearAllItems"
                                   Disabled="!AppState.ShoppingItems.Any()"
                                   Variant="Variant.Outlined"
                                   Color="Color.Secondary"
                                   Size="Size.Small">
                            Clear
                        </MudButton>
                        <MudButton Component="label"
                                   For="import-file"
                                   Variant="Variant.Outlined"
                                   Color="Color.Secondary"
                                   Size="Size.Small">
                            Import
                            <InputFile id="import-file" OnChange="ImportPlanAsync" accept=".json" style="display: none;" />
                        </MudButton>
                        <MudButton OnClick="ExportPlanAsync"
                                   Disabled="!AppState.ShoppingItems.Any()"
                                   Variant="Variant.Outlined"
                                   Color="Color.Secondary"
                                   Size="Size.Small">
                            Export
                        </MudButton>
                    </MudButtonGroup>
                </MudToolBar>
                
                <div style="padding: 16px; flex: 1; overflow-y: auto;">
                    @if (!AppState.ShoppingItems.Any())
                    {
                        <MudAlert Severity="Severity.Info" Dense="true" Class="my-2">
                            Search for items and add them to your shopping list.
                        </MudAlert>
                    }
                    else
                    {
                        <MudStack Spacing="1">
                            @foreach (var item in AppState.ShoppingItems)
                            {
                                <MudPaper Elevation="0" Class="pa-2 d-flex align-center gap-2">
                                    <MudText Typo="Typo.body2" Class="flex-grow-1">@item.Name</MudText>
                                    <MudNumericField @bind-Value="item.Quantity"
                                                     Min="1"
                                                     Max="9999"
                                                     Variant="Variant.Outlined"
                                                     Dense="true"
                                                     Style="width: 70px;" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   OnClick="() => RemoveItem(item)"
                                                   Color="Color.Error"
                                                   Size="Size.Small" />
                                </MudPaper>
                            }
                        </MudStack>
                    }
                </div>
                
                <div class="pa-4" style="border-top: 1px solid #444;">
                    <MudButton OnClick="AnalyzeMarketAsync"
                               Disabled="!AppState.ShoppingItems.Any() || _isAnalyzing || string.IsNullOrWhiteSpace(AppState.SelectedDataCenter)"
                               Color="Color.Primary"
                               Variant="Variant.Filled"
                               FullWidth="true">
                        @if (_isAnalyzing)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Analyzing...</span>
                        }
                        else
                        {
                            <span>Analyze Market</span>
                        }
                    </MudButton>
                </div>
            </MudPaper>
        </div>
        
        <!-- Right Column: Market Results (flex: 1) -->
        <div Class="pa-4" Style="overflow: hidden; min-width: 0;">
            <MarketLogisticsPanel ShoppingPlans="AppState.ShoppingPlans"
                                  CraftAnalyses="AppState.CraftAnalyses"
                                  InitialMode="AppState.RecommendationMode"
                                  OnModeChanged="OnRecommendationModeChanged" />
        </div>
    </div>
</MudContainer>

@code {
    private WorldData? _worldData;
    private bool _isLoadingWorlds = true;
    private string _selectedWorld = string.Empty;

    private string _searchQuery = string.Empty;
    private bool _isSearching = false;
    private List<GarlandSearchResult> _searchResults = new();
    
    private bool _isAnalyzing = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _worldData = await UniversalisService.GetWorldDataAsync();
            _isLoadingWorlds = false;
            
            if (string.IsNullOrEmpty(AppState.SelectedDataCenter))
            {
                AppState.SelectedDataCenter = _worldData.DataCenters.FirstOrDefault() ?? "Aether";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Index.razor: ERROR - {ex}");
            
            _worldData = new WorldData
            {
                DataCenterToWorlds = new Dictionary<string, List<string>>
                {
                    ["Aether"] = new() { "Adamantoise", "Cactuar", "Faerie", "Gilgamesh", "Jenova", "Midgardsormr", "Sargatanas", "Siren" },
                    ["Primal"] = new() { "Behemoth", "Excalibur", "Exodus", "Famfrit", "Hyperion", "Lamia", "Leviathan", "Ultros" },
                    ["Crystal"] = new() { "Balmung", "Brynhildr", "Coeurl", "Diabolos", "Goblin", "Malboro", "Mateus", "Zalera" },
                    ["Dynamis"] = new() { "Cuchulainn", "Golem", "Halicarnassus", "Kraken", "Maduin", "Marilith", "Rafflesia", "Seraph" }
                }
            };
            AppState.SelectedDataCenter = "Aether";
            _isLoadingWorlds = false;
            
            Snackbar.Add($"Using fallback world data. API error: {ex.Message}", Severity.Warning);
        }

        AppState.OnShoppingListChanged += OnShoppingListChanged;
    }

    private void OnShoppingListChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AppState.OnShoppingListChanged -= OnShoppingListChanged;
    }

    private List<string> GetWorldsForSelectedDc()
    {
        if (_worldData?.DataCenterToWorlds == null || string.IsNullOrEmpty(AppState.SelectedDataCenter))
            return new List<string>();
        
        return _worldData.DataCenterToWorlds.TryGetValue(AppState.SelectedDataCenter, out var worlds) 
            ? worlds.OrderBy(w => w).ToList() 
            : new List<string>();
    }

    private async Task SearchItemsAsync()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
            return;

        _isSearching = true;
        _searchResults.Clear();
        
        try
        {
            var results = await GarlandService.SearchAsync(_searchQuery);
            _searchResults = results.Take(10).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Search failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSearching = false;
        }
    }

    private void OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _ = SearchItemsAsync();
        }
    }

    private void AddItemToList(GarlandSearchResult result)
    {
        var existing = AppState.ShoppingItems.FirstOrDefault(i => i.Id == result.Id);
        if (existing != null)
        {
            existing.Quantity++;
        }
        else
        {
            AppState.ShoppingItems.Add(new MarketShoppingItem
            {
                Id = result.Id,
                Name = result.Object.Name,
                IconId = result.Object.IconId,
                Quantity = 1
            });
        }
        
        _searchResults.Clear();
        _searchQuery = string.Empty;
        AppState.ShoppingPlans.Clear();
        AppState.NotifyShoppingListChanged();
    }

    private void RemoveItem(MarketShoppingItem item)
    {
        AppState.ShoppingItems.Remove(item);
        AppState.ShoppingPlans.Clear();
        AppState.NotifyShoppingListChanged();
    }

    private void ClearAllItems()
    {
        AppState.ShoppingItems.Clear();
        AppState.ShoppingPlans.Clear();
        AppState.NotifyShoppingListChanged();
    }

    private async Task AnalyzeMarketAsync()
    {
        if (!AppState.ShoppingItems.Any() || string.IsNullOrWhiteSpace(AppState.SelectedDataCenter))
            return;

        _isAnalyzing = true;
        AppState.ShoppingPlans.Clear();

        try
        {
            var materials = AppState.ShoppingItems.Select(i => new MaterialAggregate
            {
                ItemId = i.Id,
                Name = i.Name,
                IconId = i.IconId,
                TotalQuantity = i.Quantity
            }).ToList();

            var progress = new Progress<string>(msg => { });
            
            AppState.ShoppingPlans = await MarketShoppingService.CalculateDetailedShoppingPlansAsync(
                materials,
                AppState.SelectedDataCenter,
                progress,
                mode: AppState.RecommendationMode);
                
            AppState.NotifyShoppingListChanged();
            
            Snackbar.Add($"Analysis complete. Found deals for {AppState.ShoppingPlans.Count} items.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Market analysis failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isAnalyzing = false;
        }
    }

    private void OnRecommendationModeChanged(RecommendationMode mode)
    {
        AppState.RecommendationMode = mode;
        if (AppState.ShoppingItems.Any())
        {
            _ = AnalyzeMarketAsync();
        }
    }

    private async Task ImportPlanAsync(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024);
            using var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();
            var plan = RecipeCalculationService.DeserializePlan(json);
            
            if (plan == null)
            {
                Snackbar.Add("Failed to import plan. Invalid format.", Severity.Error);
                return;
            }

            AppState.ShoppingItems.Clear();
            foreach (var node in plan.RootItems)
            {
                AppState.ShoppingItems.Add(new MarketShoppingItem
                {
                    Id = node.ItemId,
                    Name = node.Name,
                    IconId = node.IconId,
                    Quantity = node.Quantity
                });
            }

            AppState.SelectedDataCenter = plan.DataCenter;
            AppState.NotifyShoppingListChanged();
            
            Snackbar.Add($"Imported plan: {plan.Name} ({AppState.ShoppingItems.Count} items)", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Import failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportPlanAsync()
    {
        try
        {
            var targetItems = AppState.ShoppingItems.Select(i => (i.Id, i.Name, i.Quantity, false)).ToList();
            var plan = await RecipeCalculationService.BuildPlanAsync(
                targetItems, 
                AppState.SelectedDataCenter, 
                string.Empty);

            plan.Name = $"WebPlan_{DateTime.Now:yyyyMMdd_HHmmss}";
            var json = RecipeCalculationService.SerializePlan(plan);
            
            var bytes = System.Text.Encoding.UTF8.GetBytes(json);
            var stream = new MemoryStream(bytes);
            
            using var streamRef = new DotNetStreamReference(stream);
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", $"{plan.Name}.json", streamRef);
            
            Snackbar.Add("Plan exported successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
    }

    private void GoToPlanner()
    {
        AppState.SyncShoppingToProject();
        NavigationManager.NavigateTo("/planner");
    }
}
