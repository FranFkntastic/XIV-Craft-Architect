@using FFXIV_Craft_Architect.Core.Models

@* Two-line card for market/vendor purchases *@
<div style="background: @(IsSelected ? "#3a3a30" : "#2a2a25"); border-radius: 4px; border: 1px solid @(IsSelected ? "#d4a73a" : Plan.HasSufficientStock ? "#444" : "#5a3a3a"); overflow: hidden; min-height: 56px;">
    
    @* Line 1: Item Name (full width) with stock warning *@
    <div style="padding: 6px 10px 2px 10px; border-bottom: 1px solid #3a3a3a; display: flex; align-items: center; gap: 8px;">
        <MudText Typo="Typo.body2" Style="color: #fff; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;">
            @Plan.Name
        </MudText>
        @if (!Plan.HasSufficientStock)
        {
            <span style="background: #5a3a3a; color: #ff9800; font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; white-space: nowrap;">
                SHORT @Plan.StockShortfall
            </span>
        }
    </div>
    
    @* Line 2: Details row *@
    <div style="display: flex; align-items: center; padding: 4px 10px 6px 10px;">
        
        <!-- Source icon -->
        @if (Plan.RecommendedWorld?.WorldName == "Vendor")
        {
            <MudIcon Icon="@Icons.Material.Filled.Store" 
                     Style="color: #d4a73a; margin-right: 8px;" 
                     Size="Size.Small" />
        }
        else if (Plan.RequiresSplitPurchase && Plan.RecommendedSplit?.Any() == true)
        {
            <MudIcon Icon="@Icons.Material.Filled.CallSplit" 
                     Style="color: #ff9800; margin-right: 8px;" 
                     Size="Size.Small" />
        }
        else
        {
            <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" 
                     Style="color: #87ceeb; margin-right: 8px;" 
                     Size="Size.Small" />
        }
        
        <!-- Quantity -->
        <MudText Typo="Typo.caption" Style="color: #d4a73a; margin-right: 12px; min-width: 40px;">
            Ã—@(Plan.QuantityNeeded)
        </MudText>
        
        <!-- World indicator (simplified for collapsed view) -->
        <div style="flex: 1; min-width: 0; overflow: hidden;">
            @if (Plan.RequiresSplitPurchase && Plan.RecommendedSplit?.Any() == true)
            {
                <MudText Typo="Typo.caption" Style="color: #ff9800; font-weight: 500;">
                    @Plan.RecommendedSplit.Count worlds
                </MudText>
            }
            else if (Plan.RecommendedWorld != null)
            {
                @if (Plan.RecommendedWorld.WorldName == "Vendor" && Plan.Vendors?.Any() == true)
                {
                    var primaryVendor = Plan.Vendors.First();
                    var vendorTooltip = $"{primaryVendor.Name} - {primaryVendor.Location}";
                    <MudText Typo="Typo.caption" Style="color: #90EE90; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                             title="@vendorTooltip">
                        @primaryVendor.Name (@primaryVendor.Location)
                    </MudText>
                }
                else
                {
                    <MudText Typo="Typo.caption" Style="color: #90EE90; font-weight: 500;">
                        @Plan.RecommendedWorld.WorldName
                    </MudText>
                }
            }
        </div>
        
        <!-- Price info -->
        <div style="text-align: right;">
            @if (Plan.RequiresSplitPurchase && Plan.SplitTotalCost.HasValue)
            {
                <MudText Typo="Typo.body2" Style="color: #ff9800; font-weight: 600;">
                    @Plan.SplitTotalCost.Value.ToString("N0")g
                </MudText>
            }
            else if (Plan.RecommendedWorld != null)
            {
                <MudText Typo="Typo.body2" Style="color: #d4a73a; font-weight: 600;">
                    @Plan.RecommendedWorld.TotalCost.ToString("N0")g
                </MudText>
                <MudText Typo="Typo.caption" Style="color: #888; font-size: 10px; display: block;">
                    @Plan.RecommendedWorld.AveragePricePerUnit.ToString("N0")g/ea
                </MudText>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public DetailedShoppingPlan Plan { get; set; } = null!;
    
    [Parameter]
    public bool IsCollapsed { get; set; } = true;
    
    [Parameter]
    public bool IsSelected { get; set; } = false;
}
