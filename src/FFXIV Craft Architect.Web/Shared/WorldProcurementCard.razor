@using FFXIV_Craft_Architect.Core.Models
@inject IJSRuntime JSRuntime

@* World-centric procurement card with expandable details *@
<div style="background: @GetBackgroundColor(); border-radius: 6px; border: 1px solid @GetBorderColor(); overflow: hidden; @(IsExpanded ? "margin-bottom: 8px;" : "")">
    
    @* Header - Line 1: World Name and Status *@
    <div @onclick="ToggleExpanded" 
         style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; cursor: pointer; background: @GetHeaderBackground(); border-bottom: @(IsExpanded ? "1px solid #3a3a3a" : "none");"
         class="hoverable-header">
        
        <!-- Left: World Info -->
        <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
            @if (Card.IsVendor)
            {
                <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Small" Style="color: #d4a73a;" />
                <MudText Typo="Typo.body1" Style="color: #d4a73a; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    VENDOR
                </MudText>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" Style="color: #87ceeb;" />
                <MudText Typo="Typo.body1" Style="color: #fff; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    @Card.WorldName
                </MudText>
                @if (Card.HasSplitPurchases)
                {
                    <MudIcon Icon="@Icons.Material.Filled.CallSplit" Size="Size.Small" Style="color: #ff9800; margin-left: 4px;" />
                }
            }
            
            @* Congestion Warning *@
            @if (Card.IsCongested)
            {
                <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Style="color: #f44336;" />
                <MudText Typo="Typo.caption" Style="color: #f44336;">Congested</MudText>
            }
        </div>
        
        <!-- Right: Total Cost and Actions -->
        <div style="display: flex; align-items: center; gap: 12px;">
            <MudText Typo="Typo.body1" Style="color: #d4a73a; font-weight: 700;">
                @Card.TotalCost.ToString("N0")g
            </MudText>
            
            @* Re-analysis Dropdown for Congested Worlds *@
            @if (Card.IsCongested && !Card.IsVendor)
            {
                <MudMenu Icon="@Icons.Material.Filled.MoreVert" 
                         Dense="true"
                         Size="Size.Small"
                         AnchorOrigin="Origin.BottomRight"
                         TransformOrigin="Origin.TopRight">
                    <MudMenuItem OnClick="OnReanalyzeWithoutWorld">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <MudIcon Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" Style="color: #ff9800;" />
                            <span>Re-analyze without @Card.WorldName</span>
                        </div>
                    </MudMenuItem>
                </MudMenu>
            }
            
            @* Expand/Collapse Icon *@
            <MudIcon Icon="@(IsExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                     Size="Size.Small" 
                     Style="color: #888;" />
        </div>
    </div>
    
    @* Header - Line 2: Summary (Qty, Items Count) *@
    @if (!IsExpanded)
    {
        <div @onclick="ToggleExpanded" style="display: flex; align-items: center; justify-content: space-between; padding: 4px 12px 8px 12px; cursor: pointer;">
            <MudText Typo="Typo.caption" Style="color: #888;">
                @Card.ItemCount items · @Card.TotalQuantity total qty
            </MudText>
            @if (Card.HasSplitPurchases)
            {
                <MudText Typo="Typo.caption" Style="color: #ff9800;">
                    Split purchases
                </MudText>
            }
        </div>
    }
    
    @* Expanded Content - Items Table (ONLY for non-vendor cards) *@
    @if (IsExpanded && !Card.IsVendor)
    {
        <div style="padding: 8px;">
            @* Congestion Warning Banner *@
            @if (Card.IsCongested)
            {
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #3a2020; border-radius: 4px; margin-bottom: 8px; border: 1px solid #5a3a3a;">
                    <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Style="color: #f44336;" />
                    <MudText Typo="Typo.caption" Style="color: #ff9800; flex: 1;">
                        Cannot travel to congested worlds. Click the menu (⋮) to re-analyze without this world.
                    </MudText>
                </div>
            }
            
            @* Items Table *@
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="color: #888; font-size: 10px; text-align: left;">
                        <th style="padding: 4px 8px; font-weight: 500;">Item</th>
                        <th style="padding: 4px 8px; font-weight: 500; text-align: center; width: 80px;">Qty</th>
                        <th style="padding: 4px 8px; font-weight: 500; text-align: right; width: 80px;">Unit</th>
                        <th style="padding: 4px 8px; font-weight: 500; text-align: right; width: 80px;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Card.Items)
                    {
                        <tr @onclick="() => OnItemClick(item)" 
                            style="background: @(Card.Items.IndexOf(item) % 2 == 0 ? "transparent" : "#2a2a2a"); cursor: pointer;"
                            class="hoverable-row">
                            <td style="padding: 6px 8px; color: #fff;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    @if (item.IsSplitPurchase)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.CallSplit" Size="Size.Small" Style="color: #ff9800;" />
                                    }
                                    <span style="flex: 1;">@item.ItemName</span>
                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" 
                                                   Size="Size.Small" 
                                                   Style="color: #666; padding: 2px;"
                                                   OnClick="() => CopyItemName(item.ItemName)"
                                                   OnClick:StopPropagation="true"
                                                   Title="Copy item name" />
                                </div>
                            </td>
                            <td style="padding: 6px 8px; color: #d4a73a; text-align: center;">
                                @item.QuantityDisplay
                            </td>
                            <td style="padding: 6px 8px; color: #aaa; text-align: right; font-size: 11px;">
                                @item.PricePerUnit.ToString("N0")g
                            </td>
                            <td style="padding: 6px 8px; color: #4caf50; text-align: right; font-weight: 500;">
                                @item.TotalCost.ToString("N0")g
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    
    @* Expanded Content - Vendor Details (ONLY for vendor cards) *@
    @if (IsExpanded && Card.IsVendor)
    {
        <div style="padding: 8px;">
            @* Items List for Vendor *@
            <div style="margin-bottom: 12px;">
                @foreach (var item in Card.Items)
                {
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: @(Card.Items.IndexOf(item) % 2 == 0 ? "transparent" : "#2a2a2a"); border-radius: 4px;">
                        <div style="display: flex; flex-direction: column; gap: 2px; flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Small" Style="color: #d4a73a; flex-shrink: 0;" />
                                <span style="color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@item.ItemName</span>
                                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" 
                                               Size="Size.Small" 
                                               Style="color: #666; padding: 2px; flex-shrink: 0;"
                                               OnClick="() => CopyItemName(item.ItemName)"
                                               Title="Copy item name" />
                            </div>
                            @if (item.Vendor != null)
                            {
                                <div style="display: flex; align-items: center; gap: 4px; margin-left: 22px;">
                                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Style="color: #4caf50;" />
                                    <MudText Typo="Typo.caption" Style="color: #90EE90;">
                                        @item.Vendor.Name - @item.Vendor.Location
                                    </MudText>
                                </div>
                            }
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
                            <span style="color: #d4a73a;">@item.SimpleQuantityDisplay</span>
                            <span style="color: #aaa; font-size: 11px;">@item.PricePerUnit.ToString("N0")g</span>
                            <span style="color: #4caf50; font-weight: 500;">@item.TotalCost.ToString("N0")g</span>
                        </div>
                    </div>
                }
            </div>
            
            @* Vendor Info Notice *@
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #2a2520; border-radius: 4px; border: 1px solid #5a4a3a;">
                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Style="color: #d4a73a;" />
                <MudText Typo="Typo.caption" Style="color: #90EE90; flex: 1;">
                    Purchased from vendor. No market board listings required.
                </MudText>
            </div>
        </div>
    }
</div>

<style>
    .hoverable-header:hover {
        background: #3a3a3a !important;
    }
    .hoverable-row:hover {
        background: #3a3a3a !important;
    }
</style>

@code {
    [Parameter] public FFXIV_Craft_Architect.Core.Models.WorldProcurementCardModel Card { get; set; } = null!;
    [Parameter] public bool IsExpanded { get; set; } = false;
    [Parameter] public EventCallback<bool> IsExpandedChanged { get; set; }
    [Parameter] public EventCallback<WorldItemPurchase> OnItemSelected { get; set; }
    [Parameter] public EventCallback<string> OnReanalyzeRequested { get; set; }
    
    private async Task ToggleExpanded()
    {
        IsExpanded = !IsExpanded;
        await IsExpandedChanged.InvokeAsync(IsExpanded);
    }
    
    private async Task OnItemClick(WorldItemPurchase item)
    {
        await OnItemSelected.InvokeAsync(item);
    }
    
    private async Task OnReanalyzeWithoutWorld()
    {
        await OnReanalyzeRequested.InvokeAsync(Card.WorldName);
    }
    
    private async Task CopyItemName(string itemName)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", itemName);
    }
    
    private string GetBackgroundColor()
    {
        if (Card.IsVendor) return "#2a2520";
        if (Card.IsCongested) return "#2a2020";
        return "#20252a";
    }
    
    private string GetBorderColor()
    {
        if (Card.IsVendor) return "#5a4a3a";
        if (Card.IsCongested) return "#5a3a3a";
        return "#3a4a5a";
    }
    
    private string GetHeaderBackground()
    {
        if (Card.IsVendor) return "#3a352a";
        if (Card.IsCongested) return "#3a2a2a";
        return "#2a353a";
    }
}
