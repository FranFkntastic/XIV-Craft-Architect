@inherits LayoutComponentBase
@using FFXIV_Craft_Architect.Web.Services
@using FFXIV_Craft_Architect.Web.Dialogs
@using FFXIV_Craft_Architect.Core.Models
@using FFXIV_Craft_Architect.Core.Services
@using FFXIV_Craft_Architect.Core.Services.Interfaces
@inject NavigationManager NavigationManager
@inject AppState AppState
@inject ISettingsService Settings
@inject IndexedDbService IndexedDb
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject RecipeCalculationService RecipeService
@inject UniversalisService UniversalisService
@inject IMarketCacheService MarketCache
@inject ILogger<MainLayout> Logger
@implements IDisposable

<MudThemeProvider @ref="_mudThemeProvider" Theme="_theme" @bind-IsDarkMode="_isDarkMode" />
<MudDialogProvider />
<MudSnackbarProvider MaxDisplayedSnackbars="3" 
                     SnackbarDefaults="new SnackbarOptions { ShowCloseIcon = false, HideIcon = true }" />

<MudLayout Style="height: 100vh; display: flex; flex-direction: column;">
    <!-- Title Bar with Menu - Fixed at top -->
    <MudAppBar Elevation="0" Style="background-color: #1a1a1a; border-bottom: 1px solid #d4a73a; flex-shrink: 0;">
        <MudText Style="color: #d4a73a; font-weight: 600; margin-right: 24px;">FFXIV Craft Architect</MudText>
        
        <!-- Navigation Tabs -->
        <MudButtonGroup Size="Size.Small" Style="margin-right: 24px;">
            <MudButton OnClick="@(() => NavigateTo(""))"
                       Color="@GetTabColor("planner")"
                       Variant="@GetTabVariant("planner")">
                Recipe Planner
            </MudButton>
            <MudButton OnClick="@(() => NavigateTo("market"))"
                       Color="@GetTabColor("market")"
                       Variant="@GetTabVariant("market")">
                Market Analysis
            </MudButton>
            <MudButton OnClick="@(() => NavigateTo("procurement"))"
                       Color="@GetTabColor("procurement")"
                       Variant="@GetTabVariant("procurement")">
                Procurement Plan
            </MudButton>
        </MudButtonGroup>
        
        <!-- Menu Bar using MudMenu -->
        <div style="display: flex; gap: 4px; flex-shrink: 0;">
            <MudMenu Dense="true" 
                     AnchorOrigin="Origin.BottomLeft"
                     TransformOrigin="Origin.TopLeft"
                     Color="Color.Secondary">
                <ActivatorContent>
                    <MudButton Style="color: #cccccc; text-transform: none;" 
                               EndIcon="@Icons.Material.Filled.KeyboardArrowDown">File</MudButton>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem OnClick="OnNewPlan" Icon="@Icons.Material.Filled.Add">New Plan</MudMenuItem>
                    <MudMenuItem OnClick="OnOpenPlanBrowser" Icon="@Icons.Material.Filled.FolderOpen">Plan Browser...</MudMenuItem>
                    <MudDivider />
                    <MudMenuItem OnClick="OnViewLogs" Icon="@Icons.Material.Filled.Article">View Logs</MudMenuItem>
                </ChildContent>
            </MudMenu>
            
            <MudMenu Dense="true"
                     AnchorOrigin="Origin.BottomLeft"
                     TransformOrigin="Origin.TopLeft"
                     Color="Color.Secondary">
                <ActivatorContent>
                    <MudButton Style="color: #cccccc; text-transform: none;"
                               EndIcon="@Icons.Material.Filled.KeyboardArrowDown">Import</MudButton>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem OnClick="() => ShowImportDialog(0)" Icon="@Icons.Material.Filled.FolderOpen">
                        From Craft Architect (Native)...
                    </MudMenuItem>
                    <MudMenuItem OnClick="() => ShowImportDialog(1)" Icon="@Icons.Material.Filled.ContentPaste">
                        From Teamcraft (Text)...
                    </MudMenuItem>
                    <MudMenuItem OnClick="() => ShowImportDialog(2)" Icon="@Icons.Material.Filled.Code">
                        From Artisan (JSON)...
                    </MudMenuItem>
                </ChildContent>
            </MudMenu>
            
            <MudMenu Dense="true"
                     AnchorOrigin="Origin.BottomLeft"
                     TransformOrigin="Origin.TopLeft"
                     Color="Color.Secondary">
                <ActivatorContent>
                    <MudButton Style="color: #cccccc; text-transform: none;"
                               EndIcon="@Icons.Material.Filled.KeyboardArrowDown">Export</MudButton>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem OnClick="OnExportNative" Icon="@Icons.Material.Filled.FolderOpen">
                        To Craft Architect (Native)...
                    </MudMenuItem>
                    <MudDivider />
                    <MudMenuItem OnClick="OnExportTeamcraft" Icon="@Icons.Material.Filled.Link">
                        To Teamcraft URL...
                    </MudMenuItem>
                    <MudMenuItem OnClick="OnExportArtisan" Icon="@Icons.Material.Filled.Code">
                        To Artisan (JSON)...
                    </MudMenuItem>
                    <MudDivider />
                    <MudMenuItem OnClick="OnCopyPlainText" Icon="@Icons.Material.Filled.ContentCopy">
                        Copy as Plain Text
                    </MudMenuItem>
                    <MudMenuItem OnClick="OnCopyCsv" Icon="@Icons.Material.Filled.GridOn">
                        Copy as CSV
                    </MudMenuItem>
                </ChildContent>
            </MudMenu>
            
            <MudMenu Dense="true"
                     AnchorOrigin="Origin.BottomLeft"
                     TransformOrigin="Origin.TopLeft"
                     Color="Color.Secondary">
                <ActivatorContent>
                    <MudButton Style="color: #cccccc; text-transform: none;"
                               EndIcon="@Icons.Material.Filled.KeyboardArrowDown">Tools</MudButton>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem OnClick="OnFetchPrices" Icon="@Icons.Material.Filled.Refresh" Disabled="true">
                        Fetch Prices
                    </MudMenuItem>
                    <MudMenuItem Disabled="true" Icon="@Icons.Material.Filled.BarChart">
                        View Plan Market Data
                    </MudMenuItem>
                    <MudDivider />
                    <MudMenuItem OnClick="OnOptions" Icon="@Icons.Material.Filled.Settings">
                        Options...
                    </MudMenuItem>
                </ChildContent>
            </MudMenu>
        </div>
        
        <MudSpacer />
        
        <MudLink Href="https://github.com/FranFkntastic/FFXIV_Craft_Architect" 
                 Target="_blank" 
                 Style="color: #d4a73a; text-decoration: none; font-size: 14px;">GitHub</MudLink>
    </MudAppBar>
    
    <MudMainContent Style="background-color: #1e1e1e; flex: 1; overflow-y: auto; overflow-x: hidden;">
        @Body
    </MudMainContent>
    
    <!-- Status Bar -->
    <StatusBar />
</MudLayout>

@code {
    private bool _isDarkMode = true;
    private MudThemeProvider _mudThemeProvider = null!;
    private string _activeTab = "market";
    private bool _disposed = false;
    
    private readonly MudTheme _theme = AppTheme.CreateTheme();

    protected override void OnInitialized()
    {
        Console.WriteLine("[DIAG] MainLayout.OnInitialized()");
        
        // Set initial active tab based on current URL
        UpdateActiveTab(NavigationManager.Uri);
        
        // Listen for navigation changes
        NavigationManager.LocationChanged += OnLocationChanged;
    }
    
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            Console.WriteLine("[DIAG] MainLayout.OnAfterRender(firstRender=true)");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Load settings
            await LoadSettingsAsync();
            
            // Initialize world data (shared across all pages)
            await AppState.InitializeWorldDataAsync(UniversalisService);
            
            // Restore auto-saved plan (if any) - this runs regardless of which page user is on
            await RestoreAutoSaveAsync();
            
            // Start auto-save timer (app-wide)
            AppState.StartAutoSaveTimer(AutoSaveCallback);
        }
    }
    
    private async Task AutoSaveCallback()
    {
        if (!AppState.IsAutoSaveEnabled)
            return;
            
        try
        {
            var success = await IndexedDb.AutoSaveStateAsync(AppState);
            if (success)
            {
                AppState.LastAutoSave = DateTime.Now;
                Logger?.LogDebug("Auto-saved state at {Time}", AppState.LastAutoSave.Value.ToString("HH:mm:ss"));
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Auto-save failed");
        }
    }

    private async Task LoadSettingsAsync()
    {
        try
        {
            var autoSave = await Settings.GetAsync("ui.auto_save_enabled", true);
            var defaultDc = await Settings.GetAsync("market.default_datacenter", "Aether") ?? "Aether";
            var region = await Settings.GetAsync("market.region", "North America") ?? "North America";
            var autoFetch = await Settings.GetAsync("market.auto_fetch_prices", true);
            
            AppState.IsAutoSaveEnabled = autoSave;
            AppState.AutoFetchPricesOnRebuild = autoFetch;
            AppState.SelectedRegion = region;
            
            if (string.IsNullOrEmpty(AppState.SelectedDataCenter))
            {
                AppState.SelectedDataCenter = defaultDc;
            }
        }
        catch { /* Ignore settings load errors */ }
    }

    private async Task RestoreAutoSaveAsync()
    {
        try
        {
            // Only restore if no plan is currently loaded
            if (AppState.CurrentPlan != null || AppState.ProjectItems.Any())
                return;

            var autoSave = await IndexedDb.LoadAutoSaveAsync();
            if (autoSave?.ProjectItems.Any() != true)
                return;

            // Deserialize the plan
            CraftingPlan? plan = null;
            if (!string.IsNullOrEmpty(autoSave.PlanJson))
            {
                try
                {
                    plan = System.Text.Json.JsonSerializer.Deserialize<CraftingPlan>(autoSave.PlanJson);
                }
                catch (Exception ex)
                {
                    Logger?.LogWarning(ex, "Failed to deserialize plan JSON from auto-save");
                }
            }

            // Restore market analysis if available
            if (!string.IsNullOrEmpty(autoSave.MarketPlansJson))
            {
                try
                {
                    var marketPlans = System.Text.Json.JsonSerializer.Deserialize<List<DetailedShoppingPlan>>(autoSave.MarketPlansJson);
                    if (marketPlans?.Any() == true)
                    {
                        AppState.ShoppingPlans = marketPlans;
                        AppState.RecommendationMode = autoSave.SavedRecommendationMode;
                    }
                }
                catch (Exception ex)
                {
                    Logger?.LogWarning(ex, "Failed to restore market analysis from auto-save");
                }
            }

            // Load the plan into AppState
            AppState.LoadStoredPlan(autoSave, plan);
            
            // Notify that plan has changed (will refresh UI)
            AppState.NotifyPlanChanged();
            AppState.NotifyShoppingListChanged();
            
            Snackbar.Add("Restored previous session", Severity.Info);
            Logger?.LogInformation("Auto-restored plan '{PlanName}' with {ProjectItemCount} items and {MarketPlanCount} market plans", 
                autoSave.Name, 
                autoSave.ProjectItems.Count,
                AppState.ShoppingPlans.Count);
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Failed to restore auto-save");
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        if (_disposed) return;
        
        UpdateActiveTab(e.Location);
        _ = InvokeAsync(StateHasChanged);
    }

    private void UpdateActiveTab(string uri)
    {
        var uriLower = uri.ToLowerInvariant();
        if (uriLower.Contains("/procurement"))
            _activeTab = "procurement";
        else if (uriLower.Contains("/market"))
            _activeTab = "market";
        else
            _activeTab = "planner";
    }
    
    private bool HasPlan()
    {
        return AppState.CurrentPlan != null || AppState.ShoppingItems.Any();
    }

    private bool IsActiveTab(string tab)
    {
        return _activeTab == tab;
    }

    private Color GetTabColor(string tab)
    {
        return IsActiveTab(tab) ? Color.Primary : Color.Secondary;
    }

    private Variant GetTabVariant(string tab)
    {
        return IsActiveTab(tab) ? Variant.Filled : Variant.Text;
    }

    private void NavigateTo(string page)
    {
        // Use relative path (no leading slash) so it resolves against base href correctly
        NavigationManager.NavigateTo(string.IsNullOrEmpty(page) ? "./" : page);
    }

    // ==================== FILE MENU ====================
    
    private void OnNewPlan()
    {
        AppState.ClearPlan();
        Snackbar.Add("New plan started", Severity.Info);
    }

    private async Task OnOpenPlanBrowser()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Large };
        await DialogService.ShowAsync<PlanBrowserDialog>("Plan Browser", options);
    }
    
    private async Task LoadPlanByIdAsync(string planId)
    {
        try
        {
            var storedPlan = await IndexedDb.LoadPlanAsync(planId);
            if (storedPlan == null)
            {
                Snackbar.Add("Plan not found", Severity.Error);
                return;
            }
            
            CraftingPlan? plan = null;
            if (!string.IsNullOrEmpty(storedPlan.PlanJson))
            {
                try
                {
                    plan = System.Text.Json.JsonSerializer.Deserialize<CraftingPlan>(storedPlan.PlanJson);
                }
                catch { /* Plan JSON may be incompatible, that's ok */ }
            }
            
            AppState.LoadStoredPlan(storedPlan, plan);
            Snackbar.Add($"Loaded '{storedPlan.Name}'", Severity.Success);
            
            // Navigate to planner if we have a plan
            if (plan != null || AppState.ProjectItems.Any())
            {
                // Use relative path (no leading slash) so it resolves against base href correctly
                NavigationManager.NavigateTo("./");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load plan: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task RefreshSavedPlansListAsync()
    {
        var plans = await IndexedDb.LoadAllPlansAsync();
        AppState.SavedPlans = plans
            .Where(p => p.Id != "autosave")
            .Select(p => new StoredPlanSummary
            {
                Id = p.Id,
                Name = p.Name,
                ModifiedAt = p.ModifiedAt,
                SavedAt = p.SavedAt,
                DataCenter = p.DataCenter,
                ItemCount = p.ProjectItems.Count
            })
            .ToList();
        AppState.NotifySavedPlansChanged();
    }

    private async Task OnViewLogs()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium };
        DialogService.Show<LogsDialog>("Logs", options);
    }

    // ==================== IMPORT MENU ====================
    
    private async Task ShowImportDialog(int activeTab)
    {
        var parameters = new DialogParameters { ["ActiveTab"] = activeTab };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium };
        var dialog = DialogService.Show<ImportDialog>("Import", parameters, options);
        var result = await dialog.Result;
        
        if (result?.Data is ImportDialog.ImportResult importResult)
        {
            var items = importResult.Items;
            
            // If we have a native plan, restore it fully
            if (importResult.NativePlan != null)
            {
                AppState.CurrentPlan = importResult.NativePlan;
                
                // Use the plan's root items
                AppState.ProjectItems = importResult.NativePlan.RootItems.Select(r => new ProjectItem
                {
                    Id = r.ItemId,
                    Name = r.Name,
                    IconId = r.IconId,
                    Quantity = r.Quantity,
                    MustBeHq = r.MustBeHq
                }).ToList();
                
                // Restore data center if available
                if (!string.IsNullOrEmpty(importResult.NativePlan.DataCenter))
                {
                    AppState.SelectedDataCenter = importResult.NativePlan.DataCenter;
                }
                
                AppState.NotifyPlanChanged();
                Snackbar.Add($"Imported native plan '{importResult.NativePlan.Name}' with {items.Count} items", Severity.Success);
                
                // RE-BUILD: Fetch vendor prices and initialize nodes properly
                if (AppState.CurrentPlan != null)
                {
                    AppState.SetStatus("Rebuilding plan...", busy: true);
                    try
                    {
                        // Always fetch vendor prices (fast, local data)
                        await RecipeService.FetchVendorPricesAsync(AppState.CurrentPlan);
                        Snackbar.Add("Vendor prices updated", Severity.Success);
                        
                        // Optionally fetch market prices based on setting
                        if (AppState.AutoFetchPricesOnRebuild)
                        {
                            AppState.SetStatus("Fetching market prices...", busy: true);
                            var responses = await UniversalisService.GetMarketDataBulkAsync(
                                AppState.SelectedDataCenter,
                                AppState.CurrentPlan.GetAllItemIds().ToList());
                            
                            UpdateNodeMarketPrices(AppState.CurrentPlan.RootItems, responses);
                            
                            // Cache fetched market data for subsequent operations
                            foreach (var kvp in responses)
                            {
                                var cachedData = ConvertResponseToCachedData(kvp.Key, AppState.SelectedDataCenter, kvp.Value);
                                await MarketCache.SetAsync(kvp.Key, AppState.SelectedDataCenter, cachedData);
                            }
                            Logger.LogInformation("Cached {Count} market entries to IndexedDB", responses.Count);
                            
                            Snackbar.Add("Market prices updated", Severity.Success);
                        }
                        
                        AppState.NotifyPlanChanged();
                    }
                    catch (Exception ex)
                    {
                        Snackbar.Add($"Failed to rebuild plan: {ex.Message}", Severity.Warning);
                    }
                    finally
                    {
                        AppState.SetStatus("Ready", busy: false);
                    }
                }
            }
            else
            {
                // Clear existing project items before importing (replace current plan)
                AppState.ProjectItems.Clear();
                AppState.CurrentPlan = null;
                 
                // Add imported items to project (for non-native formats)
                foreach (var item in items)
                {
                    AppState.ProjectItems.Add(new ProjectItem
                    {
                        Id = item.Id,
                        Name = item.Name,
                        IconId = item.IconId,
                        Quantity = item.Quantity,
                        MustBeHq = item.MustBeHq
                    });
                }
                 
                AppState.NotifyPlanChanged();
                Snackbar.Add($"Imported {items.Count} items", Severity.Success);
                 
                // Rebuild plan from new project items
                if (AppState.ProjectItems.Any())
                {
                    AppState.SetStatus("Rebuilding plan...", busy: true);
                    try
                    {
                        // Convert ProjectItems to BuildPlanAsync format
                        var targetItems = AppState.ProjectItems
                            .Select(p => (p.Id, p.Name, p.Quantity, p.MustBeHq))
                            .ToList();
                        
                        var newPlan = await RecipeService.BuildPlanAsync(
                            targetItems,
                            AppState.SelectedDataCenter ?? "Aether",
                            string.Empty);
                        
                        AppState.CurrentPlan = newPlan;
                        AppState.NotifyPlanChanged();
                        
                        // Fetch market prices for all materials (matches manual plan build flow)
                        await RefreshPricesAsync();
                        
                        Snackbar.Add("Plan rebuilt from imported items", Severity.Success);
                    }
                    catch (Exception ex)
                    {
                        Snackbar.Add($"Failed to rebuild plan: {ex.Message}", Severity.Error);
                        Logger.LogError(ex, "Failed to rebuild plan from imported items");
                    }
                    finally
                    {
                        AppState.SetStatus("Ready", busy: false);
                    }
                }
            }
            
            // Navigate to planner
            if (items.Count > 0)
            {
                // Use relative path (no leading slash) so it resolves against base href correctly
                NavigationManager.NavigateTo("./");
            }
        }
    }
    
    private void UpdateNodeMarketPrices(List<PlanNode> nodes, Dictionary<int, UniversalisResponse> responses)
    {
        foreach (var node in nodes)
        {
            if (responses.TryGetValue(node.ItemId, out var response))
            {
                node.MarketPrice = (decimal)response.AveragePrice;
                
                // Calculate HQ price if available
                var hqListings = response.Listings.Where(l => l.IsHq).ToList();
                if (hqListings.Any())
                {
                    node.HqMarketPrice = (decimal)hqListings.Average(l => l.PricePerUnit);
                }
            }
            
            // Recursively update children
            if (node.Children?.Any() == true)
            {
                UpdateNodeMarketPrices(node.Children, responses);
            }
        }
    }

    // ==================== EXPORT MENU ====================
    
    private async Task OnExportNative()
    {
        await ShowExportDialog(0); // Native tab
    }

    private async Task OnExportTeamcraft()
    {
        await ShowExportDialog(1); // Teamcraft tab
    }

    private async Task OnExportArtisan()
    {
        await ShowExportDialog(2); // Artisan tab
    }
    
    private async Task ShowExportDialog(int activeTab)
    {
        var parameters = new DialogParameters { ["ActiveTab"] = activeTab };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium };
        DialogService.Show<ExportDialog>("Export", parameters, options);
    }

    private async Task OnCopyPlainText()
    {
        var materials = AppState.CurrentPlan?.AggregatedMaterials.Where(m => m.TotalQuantity > 0).ToList();
        
        if ((materials == null || materials.Count == 0) && AppState.ShoppingItems.Any())
        {
            // Use shopping items instead
            materials = AppState.ShoppingItems.Select(s => new Core.Models.MaterialAggregate
            {
                ItemId = s.Id,
                Name = s.Name,
                TotalQuantity = s.Quantity,
                UnitPrice = 0
            }).ToList();
        }
        
        if (materials == null || materials.Count == 0)
        {
            Snackbar.Add("Nothing to copy. Add items to your shopping list first.", Severity.Warning);
            return;
        }
        
        var sb = new System.Text.StringBuilder();
        sb.AppendLine("Shopping List:");
        sb.AppendLine();
        
        foreach (var item in materials)
        {
            sb.AppendLine($"{item.Name} x{item.TotalQuantity}");
        }
        
        await CopyTextToClipboardAsync(sb.ToString(), "Shopping list copied!");
    }

    private async Task OnCopyCsv()
    {
        var materials = AppState.CurrentPlan?.AggregatedMaterials.Where(m => m.TotalQuantity > 0).ToList()
            ?? new List<Core.Models.MaterialAggregate>();
        
        if (materials.Count == 0 && AppState.ShoppingItems.Any())
        {
            // Convert shopping items to material format
            materials = AppState.ShoppingItems.Select(s => new Core.Models.MaterialAggregate
            {
                ItemId = s.Id,
                Name = s.Name,
                TotalQuantity = s.Quantity,
                UnitPrice = 0
            }).ToList();
        }
        
        if (materials.Count == 0)
        {
            Snackbar.Add("Nothing to copy. Add items to your shopping list first.", Severity.Warning);
            return;
        }
        
        var csv = new System.Text.StringBuilder();
        csv.AppendLine("Item,Quantity,Unit Price,Total Cost");
        
        foreach (var m in materials)
        {
            csv.AppendLine($"\"{m.Name}\",{m.TotalQuantity},{m.UnitPrice},{m.TotalCost}");
        }
        
        await CopyTextToClipboardAsync(csv.ToString(), "CSV copied to clipboard!");
    }
    
    private async Task CopyTextToClipboardAsync(string text, string successMessage)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
            Snackbar.Add(successMessage, Severity.Success);
        }
        catch
        {
            Snackbar.Add("Failed to copy to clipboard", Severity.Error);
        }
    }

    // ==================== TOOLS MENU ====================
    
    private void OnFetchPrices()
    {
        if (AppState.CurrentPlan == null && !AppState.ShoppingItems.Any())
        {
            Snackbar.Add("No plan to fetch prices for. Create a plan first.", Severity.Warning);
            return;
        }
        
        Snackbar.Add("Fetching prices...", Severity.Info);
        AppState.NotifyShoppingListChanged();
        AppState.NotifyPlanChanged();
    }

    private async Task OnOptions()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = DialogService.Show<OptionsDialog>("Options", options);
        await dialog.Result;
    }

    public void Dispose()
    {
        if (!_disposed)
        {
            NavigationManager.LocationChanged -= OnLocationChanged;
            
            // Stop auto-save timer
            AppState.StopAutoSaveTimer();
            
            // Final auto-save on dispose
            if (AppState.IsAutoSaveEnabled)
            {
            _ = IndexedDb.AutoSaveStateAsync(AppState);
            }
            
            _disposed = true;
        }
    }
    
    /// <summary>
    /// Converts a UniversalisResponse to CachedMarketData for storage in IndexedDB.
    /// </summary>
    private static CachedMarketData ConvertResponseToCachedData(int itemId, string dataCenter, UniversalisResponse response)
    {
        var worlds = new List<CachedWorldData>();

        foreach (var worldListing in response.Listings.GroupBy(l => l.WorldName))
        {
            worlds.Add(new CachedWorldData
            {
                WorldName = worldListing.Key ?? "Unknown",
                Listings = worldListing.Select(l => new CachedListing
                {
                    Quantity = l.Quantity,
                    PricePerUnit = l.PricePerUnit,
                    RetainerName = l.RetainerName ?? "Unknown",
                    IsHq = l.IsHq
                }).ToList()
            });
        }

        return new CachedMarketData
        {
            ItemId = itemId,
            DataCenter = dataCenter,
            FetchedAtUnix = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
            DCAveragePrice = (decimal)(response.AveragePriceNq > 0 ? response.AveragePriceNq : response.AveragePrice),
            HQAveragePrice = response.AveragePriceHq > 0 ? (decimal)response.AveragePriceHq : null,
            Worlds = worlds
        };
    }
}
