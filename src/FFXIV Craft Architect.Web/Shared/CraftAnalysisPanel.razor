@using FFXIV_Craft_Architect.Core.Models

@if (Analyses.Any())
{
    <div style="font-size: 12px;">
        <!-- Compact Analysis List -->
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 6px;">
            @foreach (var analysis in Analyses.Where(a => a.IsSignificantSavings).OrderByDescending(a => Math.Abs(a.EffectivePotentialSavings)))
            {
                <div style="background: #252520; border-radius: 3px; padding: 8px; border-left: 3px solid @(GetRecommendationColor(analysis));">
                    <!-- Item Row -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <div style="color: white; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;">
                            @if (analysis.IsHqRequired)
                            {
                                <span style="color: #d4a73a;">★</span>
                            }
                            @analysis.ItemName
                            <span style="color: #888; font-weight: normal;">×@analysis.Quantity</span>
                        </div>
                        <div style="color: @(analysis.EffectivePotentialSavings > 0 ? "#4caf50" : "#ff6b6b"); font-weight: 600; margin-left: 8px;">
                            @GetSavingsDisplay(analysis)
                        </div>
                    </div>
                    
                    <!-- Price Row -->
                    <div style="display: flex; gap: 8px; font-size: 11px;">
                        <span style="color: #888;">Buy:</span>
                        <span style="color: @(analysis.EffectiveRecommendation == CraftRecommendation.Buy ? "#ff6b6b" : "#ccc");">
                            @GetBuyCostDisplay(analysis)
                        </span>
                        <span style="color: #444;">|</span>
                        <span style="color: #888;">Craft:</span>
                        <span style="color: @(analysis.EffectiveRecommendation == CraftRecommendation.Craft ? "#4caf50" : "#ccc");">
                            @analysis.CraftCost.ToString("N0")g
                        </span>
                        @if (analysis.EffectivePotentialSavings != 0)
                        {
                            <span style="color: #666; margin-left: auto;">
                                @GetSavingsPercentDisplay(analysis)
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
        
        @if (!Analyses.Any(a => a.IsSignificantSavings))
        {
            <div style="color: #888; text-align: center; padding: 16px; font-size: 12px;">
                No significant craft vs buy differences found.
            </div>
        }
    </div>
}

@code {
    [Parameter] public List<CraftVsBuyAnalysis> Analyses { get; set; } = new();
    
    protected override void OnParametersSet()
    {
        Analyses ??= new List<CraftVsBuyAnalysis>();
    }

    private static string GetRecommendationColor(CraftVsBuyAnalysis analysis)
    {
        return analysis.EffectiveRecommendation switch
        {
            CraftRecommendation.Buy => "#ff6b6b",
            CraftRecommendation.Craft => "#4caf50",
            _ => "#888888"
        };
    }

    private static string GetSavingsDisplay(CraftVsBuyAnalysis analysis)
    {
        var prefix = analysis.EffectivePotentialSavings >= 0 ? "Save " : "Cost ";
        return $"{prefix}{Math.Abs(analysis.EffectivePotentialSavings):N0}g";
    }

    private static string GetSavingsPercentDisplay(CraftVsBuyAnalysis analysis)
    {
        var sign = analysis.EffectivePotentialSavings >= 0 ? "-" : "+";
        return $"{sign}{Math.Abs(analysis.EffectiveSavingsPercent):F0}%";
    }

    private static string GetBuyCostDisplay(CraftVsBuyAnalysis analysis)
    {
        var cost = analysis.GetBuyCost(analysis.IsHqRequired);
        return cost.ToString("N0") + "g";
    }
}
