@using FFXIV_Craft_Architect.Core.Services
@using FFXIV_Craft_Architect.Core.Models
@inject ILogger<ImportDialog> Logger
@inject GarlandService GarlandService
@inject RecipeCalculationService RecipeService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" @bind-ActivePanelIndex="_activeTab">
            <!-- Native Format - Always first as it's the primary format -->
            <MudTabPanel Text="Craft Architect (.craftplan)">
                <MudText Typo="Typo.body2" Class="mb-4">
                    Import a native Craft Architect plan. This preserves all plan data including acquisition sources and recipe structure.
                </MudText>
                
                <!-- Browse Button - Using label to trigger file input -->
                <div class="mb-4">
                    <InputFile id="nativeFileInput" 
                               OnChange="OnNativeFileSelected"
                               accept=".craftplan,.json" 
                               style="display: none;" />
                    <label for="nativeFileInput" style="display: block; cursor: pointer;">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.FolderOpen"
                                   FullWidth="true"
                                   Style="pointer-events: none;">
                            Browse for .craftplan file...
                        </MudButton>
                    </label>
                </div>
                
                @if (!string.IsNullOrEmpty(_uploadedFileName))
                {
                    <MudAlert Severity="Severity.Success" Dense="true" Class="mb-4">
                        Loaded: @_uploadedFileName
                    </MudAlert>
                }
                
                <MudDivider Class="my-4" />
                
                <MudText Typo="Typo.caption" Class="mb-2 d-block" Style="color: #888;">
                    Or paste JSON directly:
                </MudText>
                <MudTextField @bind-Value="_nativeJson"
                              Label="Plan JSON"
                              Variant="Variant.Outlined"
                              Lines="6"
                              Placeholder="Paste native plan JSON here..." />
            </MudTabPanel>
            
            <MudTabPanel Text="Teamcraft Text">
                <MudText Typo="Typo.body2" Class="mb-4">
                    Paste Teamcraft "Copy as Text" output. Only the "Items :" section will be imported (other sections like Crystals, Pre crafts, etc. are materials).
                </MudText>
                <MudTextField @bind-Value="_teamcraftText"
                              Label="Teamcraft List"
                              Variant="Variant.Outlined"
                              Lines="10"
                              Placeholder="Items :&#10;1x Ragstone Grinding Wheel&#10;1x Ash Spinning Wheel&#10;..." />
            </MudTabPanel>
            
            <MudTabPanel Text="Artisan JSON">
                <MudText Typo="Typo.body2" Class="mb-4">
                    Paste an Artisan crafting list JSON export
                </MudText>
                <MudTextField @bind-Value="_artisanJson"
                              Label="Artisan JSON"
                              Variant="Variant.Outlined"
                              Lines="10"
                              Placeholder="Paste JSON here..." />
            </MudTabPanel>
        </MudTabs>
        
        @if (_isProcessing)
        {
            <MudProgressLinear Indeterminate="true" Class="mt-4" />
            <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-2 d-block">
                @_processingMessage
            </MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   OnClick="Import" 
                   Disabled="_isProcessing || (string.IsNullOrWhiteSpace(_nativeJson) && string.IsNullOrWhiteSpace(_teamcraftText) && string.IsNullOrWhiteSpace(_artisanJson))">
            Import
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public int ActiveTab { get; set; } = 0;
    
    private int _activeTab = 0;
    private string _nativeJson = "";
    private string _teamcraftText = "";
    private string _artisanJson = "";
    private bool _isProcessing = false;
    private string _processingMessage = "";
    private string _uploadedFileName = "";
    
    protected override void OnInitialized()
    {
        _activeTab = ActiveTab;
    }
    
    private async Task Import()
    {
        _isProcessing = true;
        StateHasChanged();
        
        try
        {
            List<ImportItem>? items = null;
            CraftingPlan? nativePlan = null;
            
            if (!string.IsNullOrWhiteSpace(_nativeJson))
            {
                (items, nativePlan) = await ImportNativeAsync();
            }
            else if (!string.IsNullOrWhiteSpace(_teamcraftText))
            {
                items = await ImportTeamcraftAsync();
            }
            else if (!string.IsNullOrWhiteSpace(_artisanJson))
            {
                items = await ImportArtisanAsync();
            }
            
            if (items?.Count > 0)
            {
                // Return both items and native plan (if available)
                MudDialog.Close(DialogResult.Ok(new ImportResult 
                { 
                    Items = items, 
                    NativePlan = nativePlan 
                }));
            }
            else
            {
                Snackbar.Add("No valid items found to import", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Import failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task OnNativeFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
        
        try
        {
            // Read file content
            using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024); // 5MB max
            using var reader = new StreamReader(stream);
            _nativeJson = await reader.ReadToEndAsync();
            _uploadedFileName = file.Name;
            Snackbar.Add($"Loaded {file.Name} - ready to import", Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to read file: {ex.Message}", Severity.Error);
        }
    }

    private async Task<(List<ImportItem> Items, CraftingPlan? Plan)> ImportNativeAsync()
    {
        var items = new List<ImportItem>();
        CraftingPlan? plan = null;
        
        try
        {
            _processingMessage = "Parsing native plan format...";
            StateHasChanged();
            
            plan = RecipeService.DeserializePlan(_nativeJson);
            
            if (plan != null)
            {
                // Convert root items to ImportItem list
                foreach (var rootItem in plan.RootItems)
                {
                    items.Add(new ImportItem
                    {
                        Id = rootItem.ItemId,
                        Name = rootItem.Name,
                        IconId = rootItem.IconId,
                        Quantity = rootItem.Quantity,
                        MustBeHq = rootItem.MustBeHq
                    });
                }
                
                Snackbar.Add($"Imported native plan with {items.Count} items", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to parse native format: {ex.Message}", Severity.Error);
        }
        
        return (items, plan);
    }
    
    private async Task<List<ImportItem>> ImportTeamcraftAsync()
    {
        var items = new List<ImportItem>();
        var lines = _teamcraftText.Split('\n', StringSplitOptions.RemoveEmptyEntries);
        
        var currentSection = "";
        
        foreach (var line in lines)
        {
            var trimmed = line.Trim();
            if (string.IsNullOrWhiteSpace(trimmed)) continue;
             
            // Check for section header (ends with " :")
            if (trimmed.EndsWith(':'))
            {
                currentSection = trimmed.TrimEnd(':').Trim();
                Logger.LogInformation("[Import] Found section: {Section}", currentSection);
                continue;
            }
             
            // Only import from "Items" section
            if (!currentSection.Equals("Items", StringComparison.OrdinalIgnoreCase))
            {
                continue;
            }
             
            // Parse format: "1x Item Name" or "Nx Item Name"
            var (name, quantity) = ParseTeamcraftLine(trimmed);
             
            if (!string.IsNullOrWhiteSpace(name) && quantity > 0)
            {
                // Search for item
                try
                {
                    _processingMessage = $"Searching: {name}...";
                    StateHasChanged();
                     
                    var results = await GarlandService.SearchAsync(name);
                    var match = results.FirstOrDefault(r => 
                        r.Object.Name.Equals(name, StringComparison.OrdinalIgnoreCase));
                     
                    if (match != null)
                    {
                        items.Add(new ImportItem
                        {
                            Id = match.Id,
                            Name = match.Object.Name,
                            IconId = match.Object.IconId,
                            Quantity = quantity
                        });
                    }
                }
                catch { /* Skip items that fail to resolve */ }
            }
        }
        
        return items;
    }
    
    private static (string name, int quantity) ParseTeamcraftLine(string line)
    {
        // Teamcraft format: "92x Earth Shard" (quantity first)
        // Split by space
        var parts = line.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        
        if (parts.Length >= 2)
        {
            // Check first part for quantity pattern: "5x" or "5×" or "5x:"
            var firstPart = parts[0];
            
            // Try to parse quantity from first part
            string qtyString = "";
            if (firstPart.EndsWith('x'))
            {
                // Pattern: "92x"
                qtyString = firstPart.TrimEnd('x');
            }
            else if (firstPart.EndsWith('×'))
            {
                // Pattern: "92×" (multiplication symbol)
                qtyString = firstPart.TrimEnd('×');
            }
            else if (firstPart.EndsWith('x') && firstPart.Contains(':'))
            {
                // Pattern: "92x:" (Teamcraft sometimes uses this)
                qtyString = firstPart.TrimEnd('x').TrimEnd(':');
            }
            
            if (!string.IsNullOrEmpty(qtyString) && int.TryParse(qtyString, out var qty))
            {
                // Success: quantity found at start, name is rest of line
                var name = string.Join(' ', parts.Skip(1)).Trim();
                return (name, qty);
            }
            
            // Fallback: Try parsing first part as plain number
            if (int.TryParse(firstPart, out var plainQty))
            {
                var name = string.Join(' ', parts.Skip(1)).Trim();
                return (name, plainQty);
            }
        }
        
        // Default: whole line as name, quantity 1
        return (line, 1);
    }
    
    private async Task<List<ImportItem>> ImportArtisanAsync()
    {
        var items = new List<ImportItem>();
        
        try
        {
            using var doc = System.Text.Json.JsonDocument.Parse(_artisanJson);
            var root = doc.RootElement;
            
            // Artisan format has items array with itemId
            if (root.TryGetProperty("items", out var itemsArray))
            {
                foreach (var item in itemsArray.EnumerateArray())
                {
                    if (item.TryGetProperty("itemId", out var itemIdElement))
                    {
                        var itemId = itemIdElement.GetInt32();
                        var quantity = 1;
                        
                        if (item.TryGetProperty("quantity", out var qtyElement))
                        {
                            quantity = qtyElement.GetInt32();
                        }
                        
                        // Look up item name from Garland
                        try
                        {
                            _processingMessage = $"Resolving item {itemId}...";
                            StateHasChanged();
                            
                            var results = await GarlandService.SearchAsync(itemId.ToString());
                            var match = results.FirstOrDefault(r => r.Id == itemId);
                            
                            if (match != null)
                            {
                                items.Add(new ImportItem
                                {
                                    Id = itemId,
                                    Name = match.Object.Name,
                                    IconId = match.Object.IconId,
                                    Quantity = quantity
                                });
                            }
                        }
                        catch { /* Skip items that fail to resolve */ }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            throw new Exception("Invalid JSON format: " + ex.Message);
        }
        
        return items;
    }
    
    private void Cancel()
    {
        MudDialog.Cancel();
    }
    
    public class ImportItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public int IconId { get; set; }
        public int Quantity { get; set; }
        public bool MustBeHq { get; set; }
    }

    public class ImportResult
    {
        public List<ImportItem> Items { get; set; } = new();
        public CraftingPlan? NativePlan { get; set; }
    }
}
